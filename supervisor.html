<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Manual Supervisor - v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .header h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        /* Contexto del error/solicitud */
        .context-alert {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .context-alert.critico {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
        }
        
        .context-alert h3 {
            color: #d68910;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .context-alert.critico h3 {
            color: #721c24;
        }
        
        .context-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .context-item {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .context-item strong {
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group.readonly input,
        .form-group.readonly select {
            background: #ecf0f1;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .readonly-badge {
            display: inline-block;
            background: #95a5a6;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .pin-group {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            position: relative;
        }
        
        .pin-group label {
            color: #d68910 !important;
            font-weight: 700;
        }
        
        .pin-input {
            width: 180px !important;
            text-align: center;
            font-size: 24px !important;
            font-weight: bold;
            border: 2px solid #f39c12 !important;
            letter-spacing: 4px;
        }
        
        .pin-input.valid {
            border-color: #27ae60 !important;
            background: #d5f4e6 !important;
        }
        
        .pin-input.invalid {
            border-color: #e74c3c !important;
            background: #fadbd8 !important;
        }
        
        .pin-status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }
        
        .pin-warning {
            margin-top: 10px;
            color: #d68910;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Motivo con indicador de cambio */
        .motivo-group {
            position: relative;
        }
        
        .motivo-changed {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid #28a745;
        }
        
        .motivo-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #28a745;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            z-index: 1;
        }
        
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }
        
        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #bdc3c7 100%);
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
        }
        
        .footer-note {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .historial-errors {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
            font-size: 13px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .context-details {
                grid-template-columns: 1fr;
            }
            
            .pin-input {
                width: 150px !important;
                font-size: 20px !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Procesando Check-in Manual...</h3>
            <p>Validando datos y enviando a sistema</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h2>üë®‚Äçüíº CHECK-IN MANUAL - SUPERVISOR</h2>
            <p class="subtitle">Sistema de Autorizaci√≥n de Presencia v2.0</p>
        </div>
        
        <!-- Contexto del Error/Solicitud -->
        <div id="context-alert" class="context-alert" style="display: none;">
            <h3 id="context-title">üìã Contexto de la Solicitud</h3>
            <p id="context-description"></p>
            <div class="context-details" id="context-details"></div>
        </div>
        
        <form id="checkinForm">
            <!-- EMAIL T√âCNICO -->
            <div class="form-group" id="group-tecnico">
                <label><span class="icon">üë§</span>Email T√©cnico:</label>
                <input type="email" id="tecnico" required placeholder="ejemplo.tecnico@empresa.com">
            </div>
            
            <!-- ZONA DROPDOWN -->
            <div class="form-group" id="group-zona">
                <label><span class="icon">üìç</span>Zona de Trabajo:</label>
                <select id="zona" required>
                    <option value="">Seleccionar zona de trabajo...</option>
                    <option value="Todas">üåü Todas las zonas</option>
                    <option value="Almac√©n">üì¶ Almac√©n</option>
                    <option value="Laboratorio">üî¨ Laboratorio</option>
                    <option value="L√≠nea-A">üè≠ L√≠nea-A</option>
                    <option value="L√≠nea-B">üè≠ L√≠nea-B</option>
                    <option value="L√≠nea-C">üè≠ L√≠nea-C</option>
                    <option value="Mantenimiento">üîß Mantenimiento</option>
                    <option value="Oficinas">üè¢ Oficinas</option>
                    <option value="Transporte">üöö Transporte</option>
                    <option value="Utilities">‚ö° Utilities</option>
                </select>
            </div>
            
            <!-- EMAIL SUPERVISOR -->
            <div class="form-group" id="group-supervisor">
                <label><span class="icon">üìû</span>Email Supervisor:</label>
                <input type="email" id="supervisor" required placeholder="supervisor.ejemplo@empresa.com">
            </div>
            
            <!-- TURNO DROPDOWN -->
            <div class="form-group" id="group-turno">
                <label><span class="icon">‚è∞</span>Turno de Trabajo:</label>
                <select id="turno" required>
                    <option value="">Seleccionar turno...</option>
                    <option value="A">üåÖ Turno A (06:00-14:00)</option>
                    <option value="B">üåÜ Turno B (14:00-22:00)</option>
                    <option value="C">üåô Turno C (22:00-06:00)</option>
                    <option value="Central">üè¢ Central (08:00-17:00)</option>
                    <option value="Especial">üîÑ Turno Especial</option>
                </select>
            </div>
            
            <!-- PIN SUPERVISOR -->
            <div class="pin-group">
                <label><span class="icon">üîê</span>PIN de Autorizaci√≥n:</label>
                <input type="password" id="supervisor_pin" required 
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                       maxlength="4" pattern="[0-9]{4}"
                       class="pin-input">
                <div class="pin-status" id="pin-status"></div>
                <div class="pin-warning">
                    <span>‚ö†Ô∏è</span>
                    <span>Solo supervisores autorizados pueden procesar check-ins manuales</span>
                </div>
            </div>
            
            <!-- MOTIVO CON DETECCI√ìN DE CAMBIOS -->
            <div class="form-group motivo-group" id="group-motivo">
                <label><span class="icon">üìù</span>Motivo del Check-in Manual:</label>
                <select id="motivo" required>
                    <option value="">Seleccionar motivo...</option>
                    
                    <!-- Errores GPS/T√©cnicos -->
                    <optgroup label="üîß Errores T√©cnicos GPS">
                        <option value="Permisos de ubicaci√≥n denegados">üì± Permisos de ubicaci√≥n denegados</option>
                        <option value="Ubicaci√≥n no disponible">üì∂ Ubicaci√≥n no disponible</option>
                        <option value="Tiempo agotado obteniendo GPS">‚è∞ Tiempo agotado obteniendo GPS</option>
                        <option value="GPS no soportado en dispositivo">üîß GPS no soportado en dispositivo</option>
                        <option value="GPS impreciso">üìè GPS impreciso</option>
                        <option value="GPS fall√≥ m√∫ltiples veces">üîÑ GPS fall√≥ m√∫ltiples veces</option>
                        <option value="Ubicaci√≥n fuera de Espa√±a">üåç Ubicaci√≥n fuera de Espa√±a</option>
                        <option value="Error t√©cnico del sistema">‚ö†Ô∏è Error t√©cnico del sistema</option>
                    </optgroup>
                    
                    <!-- Motivos Situacionales -->
                    <optgroup label="üö® Situaciones Especiales">
                        <option value="Bater√≠a agotada/tel√©fono apagado">üîã Bater√≠a agotada/tel√©fono apagado</option>
                        <option value="Sin cobertura m√≥vil en zona">üì∂ Sin cobertura m√≥vil en zona</option>
                        <option value="Emergencia operacional">üö® Emergencia operacional</option>
                        <option value="Equipo empresa sin GPS">üîß Equipo/tablet empresa sin GPS</option>
                        <option value="Problema m√©dico leve presente">üè• Problema m√©dico leve (presente)</option>
                        <option value="Llegada tard√≠a justificada">üïê Llegada tard√≠a justificada</option>
                        <option value="Cambio turno urgente">üîÑ Cambio de turno urgente</option>
                        <option value="T√©cnico en otra zona autorizada">üó∫Ô∏è T√©cnico en otra zona autorizada</option>
                        <option value="Problemas transporte p√∫blico">üöå Problemas transporte p√∫blico</option>
                        <option value="Condiciones clim√°ticas adversas">üåßÔ∏è Condiciones clim√°ticas adversas</option>
                        <option value="Otro motivo">üìù Otro motivo</option>
                    </optgroup>
                </select>
                <div id="motivo-badge" class="motivo-badge" style="display: none;">MODIFICADO</div>
            </div>
            
            <!-- OBSERVACIONES -->
            <div class="form-group">
                <label><span class="icon">üí¨</span>Observaciones del Supervisor:</label>
                <textarea id="observaciones" placeholder="Detalles adicionales, contexto de la situaci√≥n, confirmaciones telef√≥nicas, etc..." rows="4"></textarea>
            </div>
            
            <!-- Historial de errores si existe -->
            <div id="historial-container" style="display: none;">
                <h4>üìä Historial de Intentos GPS</h4>
                <div id="historial-errors" class="historial-errors"></div>
            </div>
            
            <button type="submit" class="submit-btn" id="submit-btn">
                ‚úÖ AUTORIZAR CHECK-IN MANUAL
            </button>
            
            <button type="button" class="submit-btn btn-secondary" onclick="rechazarCheckin()">
                ‚ùå RECHAZAR SOLICITUD
            </button>
            
            <div class="footer-note">
                <p>üîí Informaci√≥n protegida y auditada</p>
                <p>‚ö†Ô∏è Solo usar cuando el t√©cnico est√© f√≠sicamente presente o confirmado</p>
                <p>üìû En caso de duda, contactar directamente con el t√©cnico</p>
            </div>
        </form>
    </div>
    
    <script>
        // ========================================
        // üîß VARIABLES GLOBALES Y CONFIGURACI√ìN
        // ========================================
        
        let datosOriginales = {};
        let esErrorCritico = false;
        let historialErrores = [];
        let motivoOriginal = '';
        let pinValidado = false;
        
        // URLs de webhooks
        const WEBHOOK_MANUAL = 'https://hook.eu2.make.com/5cbp8q391axrc7nnbsuep6cxgzyqm55a';
        const WEBHOOK_RECHAZO = 'https://hook.eu2.make.com/rechazar_checkin_manual';
        const WEBHOOK_VALIDAR_PIN = 'https://hook.eu2.make.com/validar_pin_supervisor';
        
        // ========================================
        // ‚öôÔ∏è INICIALIZACI√ìN Y CARGA DE DATOS
        // ========================================
        
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            cargarDatosDesdeURL(params);
            configurarEventListeners();
            mostrarContextoSolicitud(params);
        };
        
        function cargarDatosDesdeURL(params) {
            // Cargar datos b√°sicos
            const campos = ['tecnico', 'zona', 'supervisor', 'turno'];
            campos.forEach(campo => {
                const valor = params.get(campo);
                if (valor) {
                    const elemento = document.getElementById(campo);
                    elemento.value = valor.replace('-', '@');
                    datosOriginales[campo] = valor;
                    
                    // Marcar como readonly si viene pre-llenado
                    marcarComoReadonly(campo);
                }
            });
            
            // Cargar motivo original y pre-seleccionar
            motivoOriginal = params.get('error_message') || params.get('motivo') || '';
            if (motivoOriginal) {
                preseleccionarMotivo(decodeURIComponent(motivoOriginal));
            }
            
            // Cargar historial de errores si existe
            const historial = params.get('historial_errores');
            if (historial) {
                try {
                    historialErrores = JSON.parse(decodeURIComponent(historial));
                    mostrarHistorialErrores();
                } catch (e) {
                    console.log('Error parseando historial:', e);
                }
            }
            
            // Detectar si es error cr√≠tico
            esErrorCritico = params.get('evento_critico') || params.get('critico') === 'true';
            
            // Auto-detectar turno por hora si no viene especificado
            if (!params.get('turno')) {
                autoDetectarTurno();
            }
        }
        
        function marcarComoReadonly(campo) {
            const grupo = document.getElementById(`group-${campo}`);
            const elemento = document.getElementById(campo);
            const label = grupo.querySelector('label');
            
            grupo.classList.add('readonly');
            elemento.setAttribute('readonly', true);
            label.innerHTML += '<span class="readonly-badge">PRE-LLENADO</span>';
        }
        
        function preseleccionarMotivo(errorOriginal) {
            const motivoSelect = document.getElementById('motivo');
            
            // Mapeo de errores a opciones del formulario
            const mapeoErrores = {
                'Permisos de ubicaci√≥n denegados': 'Permisos de ubicaci√≥n denegados',
                'Ubicaci√≥n no disponible': 'Ubicaci√≥n no disponible',
                'Tiempo agotado obteniendo GPS': 'Tiempo agotado obteniendo GPS',
                'GPS impreciso': 'GPS impreciso',
                'GPS fall√≥ m√∫ltiples veces': 'GPS fall√≥ m√∫ltiples veces',
                'Ubicaci√≥n fuera de Espa√±a': 'Ubicaci√≥n fuera de Espa√±a',
                'Error t√©cnico del sistema': 'Error t√©cnico del sistema'
            };
            
            // Buscar coincidencia exacta
            for (let key in mapeoErrores) {
                if (errorOriginal.includes(key)) {
                    motivoSelect.value = mapeoErrores[key];
                    return;
                }
            }
            
            // Si no encuentra coincidencia, buscar por patrones
            if (errorOriginal.toLowerCase().includes('gps')) {
                motivoSelect.value = 'GPS fall√≥ m√∫ltiples veces';
            } else if (errorOriginal.toLowerCase().includes('permiso')) {
                motivoSelect.value = 'Permisos de ubicaci√≥n denegados';
            } else if (errorOriginal.toLowerCase().includes('timeout') || errorOriginal.toLowerCase().includes('tiempo')) {
                motivoSelect.value = 'Tiempo agotado obteniendo GPS';
            }
        }
        
        function autoDetectarTurno() {
            const horaActual = new Date().getHours();
            let turnoSugerido = "";
            
            if (horaActual >= 6 && horaActual < 14) {
                turnoSugerido = "A";
            } else if (horaActual >= 14 && horaActual < 22) {
                turnoSugerido = "B";
            } else if (horaActual >= 8 && horaActual < 17) {
                turnoSugerido = "Central";
            } else {
                turnoSugerido = "C";
            }
            
            document.getElementById('turno').value = turnoSugerido;
        }
        
        // ========================================
        // üé® INTERFAZ Y CONTEXTO VISUAL
        // ========================================
        
        function mostrarContextoSolicitud(params) {
            const contextAlert = document.getElementById('context-alert');
            const contextTitle = document.getElementById('context-title');
            const contextDescription = document.getElementById('context-description');
            const contextDetails = document.getElementById('context-details');
            
            let titulo = 'üìã Contexto de la Solicitud';
            let descripcion = 'Check-in manual solicitado';
            let detalles = [];
            
            // Determinar tipo de contexto
            if (esErrorCritico) {
                contextAlert.classList.add('critico');
                titulo = 'üö® SOLICITUD CR√çTICA - REQUIERE ATENCI√ìN INMEDIATA';
                descripcion = 'Se ha detectado una anomal√≠a cr√≠tica que requiere validaci√≥n manual urgente.';
            } else if (params.get('total_intentos')) {
                titulo = '‚ö†Ô∏è L√çMITE DE INTENTOS GPS ALCANZADO';
                descripcion = `El t√©cnico agot√≥ los ${params.get('total_intentos')} intentos de ubicaci√≥n GPS disponibles.`;
            } else if (params.get('error_message')) {
                titulo = 'üîß ERROR T√âCNICO REPORTADO';
                descripcion = 'El sistema GPS del t√©cnico present√≥ fallos t√©cnicos.';
            }
            
            // Agregar detalles seg√∫n datos disponibles
            if (params.get('total_intentos')) {
                detalles.push({
                    label: 'Intentos GPS realizados:',
                    value: `${params.get('total_intentos')} de 3 m√°ximo`
                });
            }
            
            if (params.get('ultima_ubicacion')) {
                detalles.push({
                    label: '√öltima ubicaci√≥n reportada:',
                    value: params.get('ultima_ubicacion')
                });
            }
            
            if (params.get('distancia_zona')) {
                detalles.push({
                    label: 'Distancia a zona asignada:',
                    value: `${params.get('distancia_zona')}m`
                });
            }
            
            if (params.get('score_sospecha')) {
                const score = parseInt(params.get('score_sospecha'));
                detalles.push({
                    label: 'Score de sospecha:',
                    value: `${score}/10 ${score >= 7 ? '(ALTO RIESGO)' : score >= 4 ? '(RIESGO MEDIO)' : '(BAJO RIESGO)'}`
                });
            }
            
            const horaActual = new Date().toLocaleTimeString('es-ES', {
                hour: '2-digit', 
                minute: '2-digit'
            });
            
            detalles.push({
                label: 'Hora de solicitud:',
                value: horaActual
            });
            
            // Mostrar contexto
            contextTitle.textContent = titulo;
            contextDescription.textContent = descripcion;
            
            contextDetails.innerHTML = detalles.map(detalle => 
                `<div class="context-item">
                    <strong>${detalle.label}</strong><br>
                    ${detalle.value}
                </div>`
            ).join('');
            
            contextAlert.style.display = 'block';
        }
        
        function mostrarHistorialErrores() {
            if (historialErrores.length === 0) return;
            
            const container = document.getElementById('historial-container');
            const historialDiv = document.getElementById('historial-errors');
            
            historialDiv.innerHTML = historialErrores.map((error, index) => 
                `<div class="error-item">
                    <strong>Intento ${error.intento || index + 1}:</strong> 
                    ${error.tipo || error.detalle || 'Error no especificado'}
                    ${error.timestamp ? `<br><small>üìÖ ${new Date(error.timestamp).toLocaleString('es-ES')}</small>` : ''}
                    ${error.accuracy ? `<br><small>üìç Precisi√≥n GPS: ${Math.round(error.accuracy)}m</small>` : ''}
                </div>`
            ).join('');
            
            container.style.display = 'block';
        }
        
        // ========================================
        // üîê VALIDACI√ìN DE PIN EN TIEMPO REAL
        // ========================================
        
        function configurarEventListeners() {
            // Validaci√≥n PIN en tiempo real
            const pinInput = document.getElementById('supervisor_pin');
            pinInput.addEventListener('input', manejarInputPin);
            pinInput.addEventListener('blur', validarPinCompleto);
            
            // Detecci√≥n de cambios en motivo
            const motivoSelect = document.getElementById('motivo');
            motivoSelect.addEventListener('change', detectarCambioMotivo);
            
            // Env√≠o del formulario
            document.getElementById('checkinForm').addEventListener('submit', enviarFormulario);
        }
        
        function manejarInputPin(e) {
            // Solo n√∫meros
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            
            const pin = e.target.value;
            const status = document.getElementById('pin-status');
            
            if (pin.length === 0) {
                e.target.className = 'pin-input';
                status.textContent = '';
            } else if (pin.length < 4) {
                e.target.className = 'pin-input';
                status.textContent = '‚è≥';
            } else if (pin.length === 4) {
                status.textContent = 'üîç';
                // Validar autom√°ticamente cuando llega a 4 d√≠gitos
                setTimeout(() => validarPinCompleto(), 500);
            }
        }
        
        async function validarPinCompleto() {
            const pin = document.getElementById('supervisor_pin').value;
            const supervisor = document.getElementById('supervisor').value;
            const pinInput = document.getElementById('supervisor_pin');
            const status = document.getElementById('pin-status');
            
            if (pin.length !== 4 || !supervisor) {
                return;
            }
            
            try {
                // Simular validaci√≥n (en producci√≥n ser√≠a llamada real a API)
                const esValido = await validarPINSupervisor(pin, supervisor);
                
                if (esValido) {
                    pinInput.className = 'pin-input valid';
                    status.textContent = '‚úÖ';
                    pinValidado = true;
                    habilitarFormulario();
                } else {
                    pinInput.className = 'pin-input invalid';
                    status.textContent = '‚ùå';
                    pinValidado = false;
                    mostrarErrorPin();
                }
            } catch (error) {
                console.error('Error validando PIN:', error);
                pinInput.className = 'pin-input invalid';
                status.textContent = '‚ö†Ô∏è';
                pinValidado = false;
            }
        }
        
        async function validarPINSupervisor(pin, emailSupervisor) {
            // En producci√≥n, esto ser√≠a una llamada real a tu webhook
            // return fetch(`${WEBHOOK_VALIDAR_PIN}?supervisor=${emailSupervisor}&pin=${pin}`)
            //     .then(response => response.json())
            //     .then(result => result.valido);
            
            // Simulaci√≥n para demo (siempre v√°lido si es 4 d√≠gitos)
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(pin === '1234' || pin.length === 4); // Simular validaci√≥n
                }, 1000);
            });
        }
        
        function mostrarErrorPin() {
            alert('‚ùå PIN incorrecto para este supervisor\n\nVerifica el PIN e intenta nuevamente.\nSi el problema persiste, contacta al administrador del sistema.');
        }
        
        function habilitarFormulario() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
        }
        
        // ========================================
        // üìù DETECCI√ìN DE CAMBIOS Y VALIDACIONES
        // ========================================
        
        function detectarCambioMotivo() {
            const motivoActual = document.getElementById('motivo').value;
            const badge = document.getElementById('motivo-badge');
            const grupo = document.getElementById('group-motivo');
            
            // Determinar si el motivo cambi√≥ respecto al original
            const motivoCambio = motivoOriginal && motivoActual !== motivoOriginal && 
                                !motivoActual.includes(motivoOriginal) && 
                                !motivoOriginal.includes(motivoActual);
            
            if (motivoCambio) {
                grupo.classList.add('motivo-changed');
                badge.style.display = 'block';
                
                // Sugerir a√±adir observaci√≥n si cambi√≥ el motivo
                const observaciones = document.getElementById('observaciones');
                if (!observaciones.value) {
                    observaciones.placeholder = 'IMPORTANTE: Explica por qu√© el motivo real difiere del error reportado inicialmente...';
                }
            } else {
                grupo.classList.remove('motivo-changed');
                badge.style.display = 'none';
            }
        }
        
        // ========================================
        // üì§ ENV√çO Y PROCESAMIENTO DEL FORMULARIO
        // ========================================
        
        async function enviarFormulario(e) {
            e.preventDefault();
            
            if (!validarFormularioCompleto()) {
                return;
            }
            
            const datosFormulario = recopilarDatosFormulario();
            const confirmacion = generarMensajeConfirmacion(datosFormulario);
            
            if (!confirm(confirmacion)) {
                return;
            }
            
            mostrarLoading(true);
            
            try {
                await enviarWebhookManual(datosFormulario);
                mostrarExitoYRedirigir();
            } catch (error) {
                console.error('Error enviando formulario:', error);
                mostrarErrorEnvio(error);
            } finally {
                mostrarLoading(false);
            }
        }
        
        function validarFormularioCompleto() {
            const campos = ['tecnico', 'zona', 'supervisor', 'turno', 'motivo'];
            
            for (let campo of campos) {
                const valor = document.getElementById(campo).value;
                if (!valor) {
                    alert(`‚ùå Campo requerido: ${campo.replace('_', ' ')}\n\nCompleta todos los campos obligatorios.`);
                    document.getElementById(campo).focus();
                    return false;
                }
            }
            
            const pin = document.getElementById('supervisor_pin').value;
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                alert('‚ùå PIN debe ser exactamente 4 d√≠gitos num√©ricos');
                document.getElementById('supervisor_pin').focus();
                return false;
            }
            
            if (!pinValidado) {
                alert('‚ùå PIN no validado\n\nEspera a que se valide el PIN o verifica que sea correcto.');
                return false;
            }
            
            // Validar emails
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const tecnico = document.getElementById('tecnico').value;
            const supervisor = document.getElementById('supervisor').value;
            
            if (!emailRegex.test(tecnico) || !emailRegex.test(supervisor)) {
                alert('‚ùå Formato de email inv√°lido\n\nVerifica que los emails tengan el formato correcto.');
                return false;
            }
            
            return true;
        }
        
        function recopilarDatosFormulario() {
            return {
                tecnico: document.getElementById('tecnico').value,
                zona: document.getElementById('zona').value,
                supervisor: document.getElementById('supervisor').value,
                turno: document.getElementById('turno').value,
                supervisor_pin: document.getElementById('supervisor_pin').value,
                motivo: document.getElementById('motivo').value,
                observaciones: document.getElementById('observaciones').value,
                fecha: new Date().toISOString().split('T')[0],
                fecha_completa: new Date().toISOString(),
                manual: true,
                motivo_original: motivoOriginal,
                motivo_cambiado: motivoOriginal && document.getElementById('motivo').value !== motivoOriginal,
                es_error_critico: esErrorCritico,
                historial_errores_gps: JSON.stringify(historialErrores),
                timestamp: Math.floor(Date.now()/1000)
            };
        }
        
        function generarMensajeConfirmacion(datos) {
            const motivoCambiado = datos.motivo_cambiado ? '\n‚ö†Ô∏è MOTIVO MODIFICADO POR SUPERVISOR' : '';
            const esCritico = datos.es_error_critico ? '\nüö® CASO CR√çTICO - ALTA PRIORIDAD' : '';
            
            return `‚úÖ CONFIRMAR CHECK-IN MANUAL${esCritico}${motivoCambiado}
            
üìã RESUMEN:
‚Ä¢ T√©cnico: ${datos.tecnico}
‚Ä¢ Zona: ${datos.zona}
‚Ä¢ Turno: ${datos.turno}
‚Ä¢ Motivo: ${datos.motivo}
‚Ä¢ Supervisor: ${datos.supervisor}

${datos.observaciones ? `üí¨ Observaciones: ${datos.observaciones.substring(0, 100)}${datos.observaciones.length > 100 ? '...' : ''}` : ''}

‚ö†Ô∏è Esta acci√≥n ser√° registrada y auditada.
üìû Confirma que el t√©cnico est√° presente o localizable.

¬øConfirmas el check-in manual?`;
        }
        
        async function enviarWebhookManual(datos) {
            const url = WEBHOOK_MANUAL + '?' + new URLSearchParams(datos).toString();
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response;
        }
        
        function mostrarExitoYRedirigir() {
            alert('‚úÖ CHECK-IN MANUAL PROCESADO EXITOSAMENTE\n\nüìä Datos enviados al sistema\nüìß T√©cnico y RRHH notificados\nüì± Registro guardado en Notion\n\nüëç Gracias por tu validaci√≥n como supervisor');
            
            // Redireccionar o cerrar ventana
            setTimeout(() => {
                window.close() || (window.location.href = 'about:blank');
            }, 2000);
        }
        
        function mostrarErrorEnvio(error) {
            alert(`‚ùå ERROR ENVIANDO CHECK-IN MANUAL\n\nüîç Detalles t√©cnicos:\n${error.message}\n\nüìû ACCI√ìN REQUERIDA:\n‚Ä¢ Contacta inmediatamente con IT/Sistemas\n‚Ä¢ Confirma check-in por tel√©fono con el t√©cnico\n‚Ä¢ Informa a RRHH de la situaci√≥n t√©cnica\n\n‚ö†Ô∏è No cierres esta ventana hasta resolver el problema`);
        }
        
        // ========================================
        // üö´ RECHAZO DE SOLICITUD
        // ========================================
        
        function rechazarCheckin() {
            const tecnico = document.getElementById('tecnico').value;
            const supervisor = document.getElementById('supervisor').value;
            
            if (!tecnico || !supervisor) {
                alert('‚ùå Faltan datos b√°sicos para procesar el rechazo');
                return;
            }
            
            const motivoRechazo = prompt(`‚ùå RECHAZAR SOLICITUD CHECK-IN MANUAL
            
T√©cnico: ${tecnico}
Supervisor: ${supervisor}

üìù Indica el motivo del rechazo:

Ejemplos:
‚Ä¢ T√©cnico no localizable telef√≥nicamente
‚Ä¢ T√©cnico confirm√≥ que no est√° en la zona
‚Ä¢ Sospecha de irregularidad en la solicitud
‚Ä¢ Falta informaci√≥n/documentaci√≥n necesaria
‚Ä¢ Otro motivo (especificar)

Motivo del rechazo:`);
            
            if (motivoRechazo && motivoRechazo.trim()) {
                procesarRechazo(motivoRechazo.trim());
            }
        }
        
        async function procesarRechazo(motivoRechazo) {
            const datosRechazo = {
                tecnico: document.getElementById('tecnico').value,
                supervisor: document.getElementById('supervisor').value,
                zona: document.getElementById('zona').value,
                turno: document.getElementById('turno').value,
                motivo_rechazo: motivoRechazo,
                fecha: new Date().toISOString().split('T')[0],
                timestamp: Math.floor(Date.now()/1000),
                accion: 'RECHAZO_SUPERVISOR'
            };
            
            const confirmacion = `‚ö†Ô∏è CONFIRMAR RECHAZO DE SOLICITUD
            
T√©cnico: ${datosRechazo.tecnico}
Motivo rechazo: ${motivoRechazo}

üìã CONSECUENCIAS:
‚Ä¢ Se marcar√° como "Ausente - No Justificado"
‚Ä¢ Se enviar√° notificaci√≥n a RRHH
‚Ä¢ Puede generar flag disciplinario
‚Ä¢ El t√©cnico ser√° notificado del rechazo

¬øConfirmas el RECHAZO de esta solicitud?`;
            
            if (confirm(confirmaci√≥n)) {
                mostrarLoading(true);
                
                try {
                    await enviarWebhookRechazo(datosRechazo);
                    mostrarRechazoExitoso();
                } catch (error) {
                    console.error('Error enviando rechazo:', error);
                    mostrarErrorEnvio(error);
                } finally {
                    mostrarLoading(false);
                }
            }
        }
        
        async function enviarWebhookRechazo(datos) {
            const url = WEBHOOK_RECHAZO + '?' + new URLSearchParams(datos).toString();
            
            const response = await fetch(url, {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response;
        }
        
        function mostrarRechazoExitoso() {
            alert('‚ùå SOLICITUD RECHAZADA CORRECTAMENTE\n\nüìä Registro de rechazo procesado\nüìß RRHH y t√©cnico notificados\nüìù Flag disciplinario activado\n\n‚ö†Ô∏è El t√©cnico deber√° justificar su ausencia\nüìû Recomendamos contacto directo con RRHH');
            
            setTimeout(() => {
                window.close() || (window.location.href = 'about:blank');
            }, 2000);
        }
        
        // ========================================
        // üé® UTILIDADES DE INTERFAZ
        // ========================================
        
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = mostrar ? 'flex' : 'none';
            
            if (mostrar) {
                document.body.style.pointerEvents = 'none';
            } else {
                document.body.style.pointerEvents = 'auto';
            }
        }
        
        // ========================================
        // üîß UTILIDADES Y HELPERS
        // ========================================
        
        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function validarEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }
        
        // Debug: Log de datos para desarrollo
        function logDebug(mensaje, datos) {
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                console.log(`üîç DEBUG: ${mensaje}`, datos);
            }
        }
        
        // Prevenir cierre accidental si hay datos sin guardar
        window.addEventListener('beforeunload', function(e) {
            const formulario = document.getElementById('checkinForm');
            const tieneDatos = Array.from(formulario.elements).some(element => 
                element.value && element.value.trim() !== ''
            );
            
            if (tieneDatos && !window.procesoCompletado) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de que quieres salir? Los datos del formulario se perder√°n.';
                return e.returnValue;
            }
        });
        
        // Marcar proceso como completado para evitar warning de cierre
        function marcarProcesoCompletado() {
            window.procesoCompletado = true;
        }
        
        // ========================================
        // üöÄ FUNCIONES ADICIONALES DE MEJORA UX
        // ========================================
        
        // Auto-guardar draft cada 30 segundos
        setInterval(function() {
            const formData = recopilarDatosFormulario();
            localStorage.setItem('supervisor_draft', JSON.stringify({
                ...formData,
                timestamp: Date.now()
            }));
        }, 30000);
        
        // Recuperar draft al cargar si existe
        function recuperarDraft() {
            const draft = localStorage.getItem('supervisor_draft');
            if (draft) {
                try {
                    const datos = JSON.parse(draft);
                    const tiempoTranscurrido = Date.now() - datos.timestamp;
                    
                    // Solo recuperar si es reciente (menos de 1 hora)
                    if (tiempoTranscurrido < 3600000) {
                        if (confirm('üìù Se encontr√≥ un borrador reciente.\n¬øQuieres recuperar los datos guardados?')) {
                            // Llenar formulario con draft
                            Object.keys(datos).forEach(key => {
                                const elemento = document.getElementById(key);
                                if (elemento && datos[key]) {
                                    elemento.value = datos[key];
                                }
                            });
                        }
                    }
                    
                    // Limpiar draft despu√©s de usarlo o si es muy antiguo
                    localStorage.removeItem('supervisor_draft');
                } catch (e) {
                    console.error('Error recuperando draft:', e);
                }
            }
        }
        
        // Llamar recuperar draft despu√©s de cargar datos de URL
        setTimeout(recuperarDraft, 1000);
        
        // Limpiar draft cuando se complete el proceso
        function limpiarDraft() {
            localStorage.removeItem('supervisor_draft');
            marcarProcesoCompletado();
        }
        
        // Atajos de teclado para mejorar productividad
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter para enviar formulario
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submit-btn').click();
            }
            
            // Escape para cancelar/rechazar
            if (e.key === 'Escape') {
                if (confirm('‚ùå ¬øQuieres rechazar esta solicitud de check-in?')) {
                    rechazarCheckin();
                }
            }
        });
        
        // Mejorar accesibilidad con indicadores visuales
        document.addEventListener('DOMContentLoaded', function() {
            // A√±adir indicadores de campos requeridos
            const camposRequeridos = document.querySelectorAll('input[required], select[required]');
            camposRequeridos.forEach(campo => {
                const label = campo.closest('.form-group').querySelector('label');
                if (label && !label.textContent.includes('*') && !campo.hasAttribute('readonly')) {
                    label.innerHTML += ' <span style="color: #e74c3c;">*</span>';
                }
            });
            
            // A√±adir tooltips informativos
            const tooltips = {
                'supervisor_pin': 'PIN de 4 d√≠gitos asignado por el administrador del sistema',
                'motivo': 'Selecciona el motivo m√°s espec√≠fico que describa la situaci√≥n',
                'observaciones': 'A√±ade cualquier contexto adicional que ayude a entender la situaci√≥n'
            };
            
            Object.entries(tooltips).forEach(([id, texto]) => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.title = texto;
                }
            });
        });
        
        // Log final para debugging
        logDebug('Formulario supervisor inicializado', {
            esErrorCritico,
            motivoOriginal,
            historialErrores: historialErrores.length,
            datosOriginales
        });
        
    </script>
</body>
</html>
