<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Manual Supervisor - v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
        }

        .header h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        .context-alert {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .context-alert.critico {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
        }

        .context-alert h3 {
            color: #d68910;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .context-alert.critico h3 {
            color: #721c24;
        }

        .context-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .context-item {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .context-item strong {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group.readonly input,
        .form-group.readonly select {
            background: #ecf0f1;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .readonly-badge {
            display: inline-block;
            background: #95a5a6;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .pin-group {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            position: relative;
        }

        .pin-group label {
            color: #d68910 !important;
            font-weight: 700;
        }

        .pin-input {
            width: 180px !important;
            text-align: center;
            font-size: 24px !important;
            font-weight: bold;
            border: 2px solid #f39c12 !important;
            letter-spacing: 4px;
        }

        .pin-input.valid {
            border-color: #27ae60 !important;
            background: #d5f4e6 !important;
        }

        .pin-input.invalid {
            border-color: #e74c3c !important;
            background: #fadbd8 !important;
        }

        .pin-status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }

        .pin-warning {
            margin-top: 10px;
            color: #d68910;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .motivo-group {
            position: relative;
        }

        .motivo-changed {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid #28a745;
        }

        .motivo-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #28a745;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            z-index: 1;
            display: none;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }

        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #bdc3c7 100%);
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
        }

        .footer-note {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.5;
        }

        .historial-errors {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
            font-size: 13px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            .context-details {
                grid-template-columns: 1fr;
            }
            .pin-input {
                width: 150px !important;
                font-size: 20px !important;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Procesando Check-in Manual...</h3>
            <p>Validando datos y enviando a sistema</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h2>üë®‚Äçüíº CHECK-IN MANUAL - SUPERVISOR</h2>
            <div class="subtitle">Sistema de Autorizaci√≥n de Presencia v2.0</div>
        </div>

        <div class="context-alert" id="context-alert" style="display: none;">
            <h3 id="context-title">üìã Contexto de la Solicitud</h3>
            <p id="context-description">Check-in manual solicitado</p>
            <div class="context-details" id="context-details"></div>
        </div>

        <form id="checkinForm">
            <div class="form-group" id="group-tecnico">
                <label for="tecnico">üë§Email T√©cnico:</label>
                <input type="email" id="tecnico" required>
            </div>

            <div class="form-group" id="group-zona">
                <label for="zona">üìçZona de Trabajo:</label>
                <select id="zona" required>
                    <option value="">Seleccionar zona de trabajo...</option>
                    <option value="Todas las zonas">üåü Todas las zonas</option>
                    <option value="Almac√©n">üì¶ Almac√©n</option>
                    <option value="Laboratorio">üî¨ Laboratorio</option>
                    <option value="L√≠nea-A">üè≠ L√≠nea-A</option>
                    <option value="L√≠nea-B">üè≠ L√≠nea-B</option>
                    <option value="L√≠nea-C">üè≠ L√≠nea-C</option>
                    <option value="Mantenimiento">üîß Mantenimiento</option>
                    <option value="Oficinas">üè¢ Oficinas</option>
                    <option value="Transporte">üöö Transporte</option>
                    <option value="Utilities">‚ö° Utilities</option>
                </select>
            </div>

            <div class="form-group" id="group-supervisor">
                <label for="supervisor">üìûEmail Supervisor:</label>
                <input type="email" id="supervisor" required>
            </div>

            <div class="form-group" id="group-turno">
                <label for="turno">‚è∞Turno de Trabajo:</label>
                <select id="turno" required>
                    <option value="">Seleccionar turno...</option>
                    <option value="A">üåÖ Turno A (06:00-14:00)</option>
                    <option value="B">üåÜ Turno B (14:00-22:00)</option>
                    <option value="C">üåô Turno C (22:00-06:00)</option>
                    <option value="Central">üè¢ Central (08:00-17:00)</option>
                    <option value="Especial">üîÑ Turno Especial</option>
                </select>
            </div>

            <div class="pin-group">
                <label for="supervisor_pin">üîêPIN de Autorizaci√≥n:</label>
                <input type="text" id="supervisor_pin" class="pin-input" maxlength="4" 
                       placeholder="1234" required>
                <div class="pin-status" id="pin-status"></div>
                <div class="pin-warning">
                    ‚ö†Ô∏è Solo supervisores autorizados pueden procesar check-ins manuales
                </div>
            </div>

            <div class="form-group motivo-group" id="group-motivo_cambio">
                <label for="motivo_cambio">üìùMotivo del Check-in Manual:</label>
                <select id="motivo_cambio" required>
                    <option value="">Seleccionar motivo...</option>
                    <option value="Permisos de ubicaci√≥n denegados">üì± Permisos de ubicaci√≥n denegados</option>
                    <option value="Ubicaci√≥n no disponible">üì∂ Ubicaci√≥n no disponible</option>
                    <option value="Tiempo agotado obteniendo GPS">‚è∞ Tiempo agotado obteniendo GPS</option>
                    <option value="GPS no soportado en dispositivo">üîß GPS no soportado en dispositivo</option>
                    <option value="GPS impreciso">üìè GPS impreciso</option>
                    <option value="GPS fall√≥ m√∫ltiples veces">üîÑ GPS fall√≥ m√∫ltiples veces</option>
                    <option value="Ubicaci√≥n fuera de Espa√±a">üåç Ubicaci√≥n fuera de Espa√±a</option>
                    <option value="Error t√©cnico del sistema">‚ö†Ô∏è Error t√©cnico del sistema</option>
                    <option value="T√©cnico fuera de zona asignada">üìç T√©cnico fuera de zona asignada</option>
                    <option value="Bater√≠a agotada/tel√©fono apagado">üîã Bater√≠a agotada/tel√©fono apagado</option>
                    <option value="Sin cobertura m√≥vil en zona">üì∂ Sin cobertura m√≥vil en zona</option>
                    <option value="Emergencia operacional">üö® Emergencia operacional</option>
                    <option value="Equipo/tablet empresa sin GPS">üîß Equipo/tablet empresa sin GPS</option>
                    <option value="Problema m√©dico leve (presente)">üè• Problema m√©dico leve (presente)</option>
                    <option value="Llegada tard√≠a justificada">üïê Llegada tard√≠a justificada</option>
                    <option value="Cambio de turno urgente">üîÑ Cambio de turno urgente</option>
                    <option value="T√©cnico en otra zona autorizada">üó∫Ô∏è T√©cnico en otra zona autorizada</option>
                    <option value="Problemas transporte p√∫blico">üöå Problemas transporte p√∫blico</option>
                    <option value="Condiciones clim√°ticas adversas">üåßÔ∏è Condiciones clim√°ticas adversas</option>
                    <option value="Otro motivo">üìù Otro motivo</option>
                </select>
                <div class="motivo-badge" id="motivo-badge">MODIFICADO</div>
            </div>

            <div class="form-group">
                <label for="observaciones">üí¨Observaciones del Supervisor:</label>
                <textarea id="observaciones" rows="4" 
                          placeholder="Detalles adicionales, contexto de la situaci√≥n, confirmaciones telef√≥nicas, etc..."></textarea>
            </div>

            <div id="historial-container" style="display: none;">
                <h4>üìä Historial de Intentos GPS</h4>
                <div class="historial-errors" id="historial-errors"></div>
            </div>

            <button type="submit" class="submit-btn" id="submit-btn" disabled>
                ‚úÖ AUTORIZAR CHECK-IN MANUAL
            </button>

            <button type="button" class="submit-btn btn-secondary" onclick="rechazarCheckin()">
                ‚ùå RECHAZAR SOLICITUD
            </button>
        </form>

        <div class="footer-note">
            üîí Informaci√≥n protegida y auditada<br>
            ‚ö†Ô∏è Solo usar cuando el t√©cnico est√© f√≠sicamente presente o confirmado<br>
            üìû En caso de duda, contactar directamente con el t√©cnico
        </div>
    </div>

    <script>
        // ========================================
        // üîß VARIABLES GLOBALES OPTIMIZADAS
        // ========================================
        let datosOriginales = {};
        let esErrorCritico = false;
        let historialErroresGPS = [];
        let motivoOriginal = '';
        let pinValidado = false;
        let parametrosURL = {};

        const WEBHOOK_MANUAL = 'https://hook.eu2.make.com/wve7gq8kh6ytw6tq4vfxiepi928n2yk8';
        const WEBHOOK_RECHAZO = 'https://hook.eu2.make.com/wve7gq8kh6ytw6tq4vfxiepi928n2yk8';
        const WEBHOOK_VALIDAR_PIN = 'https://hook.eu2.make.com/jrfjqan7utpu25x6tjoikhn3xl6i83yu';

        // ========================================
        // ‚öôÔ∏è INICIALIZACI√ìN OPTIMIZADA
        // ========================================
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            cargarDatosDesdeURL(params);
            configurarEventListeners();
            mostrarContextoSolicitud(params);
        };

        function cargarDatosDesdeURL(params) {
            // Cargar parametrosURL unificados
            parametrosURL = {
                tecnico: params.get('t') || params.get('tecnico') || '',
                zona_principal: params.get('z') || params.get('zona') || '',
                supervisor: params.get('s') || params.get('supervisor') || '',
                turno: params.get('tu') || params.get('turno') || '',
                fecha_evento: params.get('f') || params.get('fecha_evento') || new Date().toISOString().split('T')[0],
                horario_turno: params.get('h') || params.get('horario_turno') || '',
                telefono: params.get('tel') || params.get('telefono') || '',
                hash_validacion: params.get('hash') || params.get('hash_validacion') || '',
                zonas_secundarias: params.get('zs') || params.get('zonas_secundarias') || ''
            };

            // ‚úÖ OPTIMIZACI√ìN: Auto-rellenar zona_utilizada con zona_principal
            const campos = [
                {id: 'tecnico', param: 'tecnico'},
                {id: 'zona', param: 'zona_principal'}, // ‚úÖ Auto-relleno
                {id: 'supervisor', param: 'supervisor'},
                {id: 'turno', param: 'turno'}
            ];

            campos.forEach(campo => {
                const valor = parametrosURL[campo.param];
                if (valor) {
                    const elemento = document.getElementById(campo.id);
                    if (elemento) {
                        elemento.value = valor.replace('-', '@');
                        datosOriginales[campo.id] = valor;
                        marcarComoReadonly(campo.id);
                    }
                }
            });

            // Cargar motivo original
            motivoOriginal = params.get('error_message') || params.get('motivo') || '';
            if (motivoOriginal) {
                preseleccionarMotivo(decodeURIComponent(motivoOriginal));
            }

            // Cargar historial
            const historial = params.get('historial_completo') || params.get('historial_errores');
            if (historial) {
                try {
                    historialErroresGPS = JSON.parse(decodeURIComponent(historial));
                    mostrarHistorialErrores();
                } catch (e) {
                    console.log('Error parseando historial:', e);
                }
            }

            esErrorCritico = params.get('evento_critico') || params.get('critico') === 'true';

            if (!params.get('turno')) {
                autoDetectarTurno();
            }
        }

        function marcarComoReadonly(campo) {
            const grupo = document.getElementById(`group-${campo}`);
            const elemento = document.getElementById(campo);
            
            if (elemento) {
                // ‚úÖ ASEGURAR que el elemento funcione
                elemento.setAttribute('readonly', true);
                
                // Solo aplicar estilos de grupo si existe
                if (grupo) {
                    const label = grupo.querySelector('label');
                    grupo.classList.add('readonly');
                    if (label && !label.innerHTML.includes('PRE-LLENADO')) {
                        label.innerHTML += '<span class="readonly-badge">PRE-LLENADO</span>';
                    }
                }
                console.log(`‚úÖ Campo ${campo} marcado como readonly`);
            } else {
                console.warn(`‚ùå Elemento ${campo} no encontrado para marcar readonly`);
            }
        }

        function preseleccionarMotivo(errorOriginal) {
            const motivoSelect = document.getElementById('motivo_cambio');
            
            const mapeoAutomaticoErrores = {
                // Errores t√©cnicos GPS (mapeo exacto)
                'PERMISOS_GPS_DENEGADOS': 'Permisos de ubicaci√≥n denegados',
                'GPS_NO_DISPONIBLE': 'Ubicaci√≥n no disponible',
                'TIMEOUT_GPS': 'Tiempo agotado obteniendo GPS',
                'GPS_IMPRECISO': 'GPS impreciso',
                'ERROR_GPS_DESCONOCIDO': 'Error t√©cnico del sistema',
                'GEOLOCATION_NO_SOPORTADO': 'GPS no soportado en dispositivo',
                // Errores de ubicaci√≥n (mapeo corregido)
                'FUERA_ZONA': 'T√©cnico fuera de zona asignada', // ‚úÖ CORREGIDO
                'ZONA_LEJANA': 'T√©cnico fuera de zona asignada', // ‚úÖ CORREGIDO
                // Errores cr√≠ticos
                'FUERA_ESPANA': 'Ubicaci√≥n fuera de Espa√±a',
                'GPS_SOSPECHOSO': 'Error t√©cnico del sistema',
                'DISPOSITIVO_SOSPECHOSO': 'Error t√©cnico del sistema',
                // Errores de sistema
                'LIMITE_ALCANZADO': 'GPS fall√≥ m√∫ltiples veces',
                'COORDENADAS_INVALIDAS': 'Error t√©cnico del sistema',
                'COORDENADAS_NULAS': 'Error t√©cnico del sistema'
            };

            // ‚úÖ MAPEO POR TEXTO (fallback)
            const mapeoTexto = {
                'Permisos de ubicaci√≥n denegados': 'Permisos de ubicaci√≥n denegados',
                'Ubicaci√≥n no disponible': 'Ubicaci√≥n no disponible',
                'Tiempo agotado obteniendo GPS': 'Tiempo agotado obteniendo GPS',
                'GPS impreciso': 'GPS impreciso',
                'GPS fall√≥ m√∫ltiples veces': 'GPS fall√≥ m√∫ltiples veces',
                'Ubicaci√≥n fuera de Espa√±a': 'Ubicaci√≥n fuera de Espa√±a',
                'Error t√©cnico del sistema': 'Error t√©cnico del sistema'
            };

            console.log('üîç Mapeo autom√°tico para error:', errorOriginal);

            // 1. Intentar mapeo autom√°tico por tipo de error
            for (let tipoError in mapeoAutomaticoErrores) {
                if (errorOriginal.includes(tipoError)) {
                    motivoSelect.value = mapeoAutomaticoErrores[tipoError];
                    console.log('‚úÖ Mapeo autom√°tico exitoso:', mapeoAutomaticoErrores[tipoError]);
                    
                    // ‚úÖ LIMPIAR placeholder si se mape√≥ autom√°ticamente
                    const observaciones = document.getElementById('observaciones');
                    if (observaciones.placeholder.includes('ERROR NO MAPEADO')) {
                        observaciones.placeholder = 'Detalles adicionales, contexto de la situaci√≥n, confirmaciones telef√≥nicas, etc...';
                    }
                    return;
                }
            }

            // 2. Intentar mapeo por texto coincidente
            for (let textoError in mapeoTexto) {
                if (errorOriginal.includes(textoError)) {
                    motivoSelect.value = mapeoTexto[textoError];
                    console.log('‚úÖ Mapeo por texto exitoso:', mapeoTexto[textoError]);
                    return;
                }
            }

            // 3. Mapeo por patrones (mejorado)
            if (errorOriginal.toLowerCase().includes('fuera') && errorOriginal.toLowerCase().includes('zona')) {
                motivoSelect.value = 'T√©cnico fuera de zona asignada';
                console.log('‚úÖ Mapeo por patr√≥n: fuera de zona');
            } else if (errorOriginal.toLowerCase().includes('gps') && errorOriginal.toLowerCase().includes('precis')) {
                motivoSelect.value = 'GPS impreciso';
                console.log('‚úÖ Mapeo por patr√≥n: GPS impreciso');
            } else if (errorOriginal.toLowerCase().includes('gps')) {
                motivoSelect.value = 'GPS fall√≥ m√∫ltiples veces';
                console.log('‚úÖ Mapeo por patr√≥n: GPS gen√©rico');
            } else if (errorOriginal.toLowerCase().includes('permiso') || errorOriginal.toLowerCase().includes('denied')) {
                motivoSelect.value = 'Permisos de ubicaci√≥n denegados';
                console.log('‚úÖ Mapeo por patr√≥n: permisos');
            } else if (errorOriginal.toLowerCase().includes('timeout') || errorOriginal.toLowerCase().includes('tiempo')) {
                motivoSelect.value = 'Tiempo agotado obteniendo GPS';
                console.log('‚úÖ Mapeo por patr√≥n: timeout');
            } else {
                // ‚úÖ NO SE PUDO MAPEAR - MOSTRAR AYUDA AL SUPERVISOR
                console.warn('‚ùå Error no mapeado autom√°ticamente:', errorOriginal);
                mostrarErrorNoMapeado(errorOriginal);
            }
        }

        // 3. NUEVA funci√≥n para errores no mapeados:
        function mostrarErrorNoMapeado(errorOriginal) {
            const observaciones = document.getElementById('observaciones');
            const motivoSelect = document.getElementById('motivo_cambio');

            // ‚úÖ MOSTRAR AYUDA EN OBSERVACIONES
            observaciones.placeholder = `‚ö†Ô∏è ERROR NO MAPEADO AUTOM√ÅTICAMENTE - SELECCIONA MANUALMENTE

Error original: "${errorOriginal}"

üí° SUGERENCIAS:
‚Ä¢ Si menciona "GPS" ‚Üí "GPS fall√≥ m√∫ltiples veces"
‚Ä¢ Si menciona "ubicaci√≥n" ‚Üí "Ubicaci√≥n no disponible"
‚Ä¢ Si menciona "timeout/tiempo" ‚Üí "Tiempo agotado obteniendo GPS"
‚Ä¢ Si menciona "permisos" ‚Üí "Permisos de ubicaci√≥n denegados"
‚Ä¢ Si menciona "zona/distancia" ‚Üí "T√©cnico fuera de zona asignada"
‚Ä¢ Si no est√° claro ‚Üí "Error t√©cnico del sistema"

A√±ade aqu√≠ el contexto que consideres relevante...`;

            // ‚úÖ RESALTAR CAMPO MOTIVO
            const grupo = document.getElementById('group-motivo_cambio');
            grupo.style.borderColor = '#ff9800';
            grupo.style.backgroundColor = '#fff3e0';

            // ‚úÖ A√ëADIR INDICADOR VISUAL
            const badge = document.getElementById('motivo-badge');
            badge.style.display = 'block';
            badge.textContent = 'REVISAR';
            badge.style.backgroundColor = '#ff9800';

            // ‚úÖ SCROLL HACIA EL CAMPO
            motivoSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });

            console.log('‚ö†Ô∏è Supervisor debe seleccionar motivo manualmente para:', errorOriginal);
        }

        function autoDetectarTurno() {
            const horaActual = new Date().getHours();
            let turnoSugerido = "";

            if (horaActual >= 6 && horaActual < 14) {
                turnoSugerido = "A";
            } else if (horaActual >= 14 && horaActual < 22) {
                turnoSugerido = "B";
            } else if (horaActual >= 8 && horaActual < 17) {
                turnoSugerido = "Central";
            } else {
                turnoSugerido = "C";
            }

            document.getElementById('turno').value = turnoSugerido;
        }

        // ========================================
        // üé® INTERFAZ Y CONTEXTO VISUAL
        // ========================================
        function mostrarContextoSolicitud(params) {
            const contextAlert = document.getElementById('context-alert');
            const contextTitle = document.getElementById('context-title');
            const contextDescription = document.getElementById('context-description');
            const contextDetails = document.getElementById('context-details');

            let titulo = 'üìã Contexto de la Solicitud';
            let descripcion = 'Check-in manual solicitado';
            let detalles = [];

            if (esErrorCritico) {
                contextAlert.classList.add('critico');
                titulo = 'üö® SOLICITUD CR√çTICA - REQUIERE ATENCI√ìN INMEDIATA';
                descripcion = 'Se ha detectado una anomal√≠a cr√≠tica que requiere validaci√≥n manual urgente.';
            } else if (params.get('total_intentos')) {
                titulo = '‚ö†Ô∏è L√çMITE DE INTENTOS GPS ALCANZADO';
                descripcion = `El t√©cnico agot√≥ los ${params.get('total_intentos')} intentos de ubicaci√≥n GPS disponibles.`;
            } else if (params.get('error_message')) {
                titulo = 'üîß ERROR T√âCNICO REPORTADO';
                descripcion = 'El sistema GPS del t√©cnico present√≥ fallos t√©cnicos.';
            }

            if (params.get('total_intentos')) {
                detalles.push({
                    label: 'Intentos GPS realizados:',
                    value: `${params.get('total_intentos')} de 3 m√°ximo`
                });
            }

            if (params.get('ultima_ubicacion')) {
                detalles.push({
                    label: '√öltima ubicaci√≥n reportada:',
                    value: params.get('ultima_ubicacion')
                });
            }

            if (params.get('distancia_zona')) {
                detalles.push({
                    label: 'Distancia a zona asignada:',
                    value: `${params.get('distancia_zona')}m`
                });
            }

            if (params.get('score_sospecha')) {
                const score = parseInt(params.get('score_sospecha'));
                detalles.push({
                    label: 'Score de sospecha:',
                    value: `${score}/10 ${score >= 7 ? '(ALTO RIESGO)' : score >= 4 ? '(RIESGO MEDIO)' : '(BAJO RIESGO)'}`
                });
            }

            const horaActual = new Date().toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
            detalles.push({
                label: 'Hora de solicitud:',
                value: horaActual
            });

            contextTitle.textContent = titulo;
            contextDescription.textContent = descripcion;
            contextDetails.innerHTML = detalles.map(detalle => `<div class="context-item">
                <strong>${detalle.label}</strong><br>
                ${detalle.value}
            </div>`
            ).join('');

            contextAlert.style.display = 'block';
        }

        function mostrarHistorialErrores() {
            if (historialErroresGPS.length === 0) return;

            const container = document.getElementById('historial-container');
            const historialDiv = document.getElementById('historial-errors');

            historialDiv.innerHTML = historialErroresGPS.map((error, index) => `<div class="error-item">
                <strong>Intento ${error.intento || index + 1}:</strong> ${error.tipo || error.detalle || 'Error no especificado'}
                ${error.timestamp ? `<br><small>üìÖ ${new Date(error.timestamp).toLocaleString('es-ES')}</small>` : ''}
                ${error.accuracy ? `<br><small>üìç Precisi√≥n GPS: ${Math.round(error.accuracy)}m</small>` : ''}
            </div>`
            ).join('');

            container.style.display = 'block';
        }

        // ========================================
        // üîê VALIDACI√ìN DE PIN - CORREGIDA Y OPTIMIZADA
        // ========================================
        let validandoPin = false; // ‚úÖ FLAG para evitar validaciones m√∫ltiples
        let timeoutValidacion = null; // ‚úÖ Control de timeout

        function configurarEventListeners() {
            const pinInput = document.getElementById('supervisor_pin');
            pinInput.addEventListener('input', manejarInputPin);
            // ‚úÖ REMOVEMOS el blur listener que causaba re-validaciones
            // pinInput.addEventListener('blur', validarPinCompleto);

            const motivoSelect = document.getElementById('motivo_cambio');
            motivoSelect.addEventListener('change', detectarCambioMotivo);

            document.getElementById('checkinForm').addEventListener('submit', enviarFormulario);
        }

        function manejarInputPin(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            const pin = e.target.value;
            const status = document.getElementById('pin-status');

            // ‚úÖ LIMPIAR timeout anterior si existe
            if (timeoutValidacion) {
                clearTimeout(timeoutValidacion);
                timeoutValidacion = null;
            }

            // ‚úÖ RESETEAR estado si se est√° editando un PIN ya validado
            if (pinValidado && pin.length < 4) {
                pinValidado = false;
                document.getElementById('submit-btn').disabled = true;
                e.target.className = 'pin-input';
            }

            if (pin.length === 0) {
                e.target.className = 'pin-input';
                status.textContent = '';
                pinValidado = false;
            } else if (pin.length < 4) {
                e.target.className = 'pin-input';
                status.textContent = '‚è≥';
                pinValidado = false;
            } else if (pin.length === 4) {
                // ‚úÖ SOLO validar si no est√° ya validando y no est√° ya validado
                if (!validandoPin && !pinValidado) {
                    status.textContent = 'üîç';
                    timeoutValidacion = setTimeout(() => validarPinCompleto(), 500);
                }
            }
        }

        async function validarPinCompleto() {
            // ‚úÖ PREVENIR validaciones m√∫ltiples
            if (validandoPin) {
                console.log('‚ö†Ô∏è Validaci√≥n ya en curso, saltando...');
                return;
            }

            const pin = document.getElementById('supervisor_pin').value;
            const supervisor = document.getElementById('supervisor').value;
            const pinInput = document.getElementById('supervisor_pin');
            const status = document.getElementById('pin-status');

            // ‚úÖ VALIDACIONES previas mejoradas
            if (pin.length !== 4) {
                console.log('‚ö†Ô∏è PIN no tiene 4 d√≠gitos, saltando validaci√≥n');
                return;
            }

            if (!supervisor || supervisor.trim() === '') {
                console.log('‚ö†Ô∏è Email supervisor vac√≠o, saltando validaci√≥n');
                status.textContent = 'üìß';
                return;
            }

            // ‚úÖ MARCAR como validando
            validandoPin = true;
            status.textContent = 'üîç';

            try {
                console.log('üîç Iniciando validaci√≥n PIN para:', supervisor);
                const esValido = await validarPINSupervisor(pin, supervisor);

                if (esValido) {
                    pinInput.className = 'pin-input valid';
                    status.textContent = '‚úÖ';
                    pinValidado = true;
                    habilitarFormulario();
                    console.log('‚úÖ PIN validado correctamente');
                } else {
                    pinInput.className = 'pin-input invalid';
                    status.textContent = '‚ùå';
                    pinValidado = false;
                    mostrarErrorPin();
                    console.log('‚ùå PIN inv√°lido');
                }
            } catch (error) {
                console.error('‚ùå Error validando PIN:', error);
                pinInput.className = 'pin-input invalid';
                status.textContent = '‚ö†Ô∏è';
                pinValidado = false;
                // ‚úÖ NO mostrar error autom√°ticamente en catch, ya se maneja en validarPINSupervisor
            } finally {
                // ‚úÖ SIEMPRE liberar el flag
                validandoPin = false;
            }
        }

        async function validarPINSupervisor(pin, emailSupervisor) {
            try {
                const url = `${WEBHOOK_VALIDAR_PIN}?supervisor=${encodeURIComponent(emailSupervisor)}&pin=${pin}&timestamp=${Date.now()}`;
                console.log('üîç Validando PIN con webhook:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // ‚úÖ A√ëADIR timeout para evitar cuelgues
                    signal: AbortSignal.timeout(10000) // 10 segundos timeout
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    const textResult = await response.text();
                    console.log('üìù Respuesta webhook (texto):', textResult);

                    if (textResult.toLowerCase().includes('true') || 
                        textResult.toLowerCase().includes('valido') || 
                        textResult.toLowerCase().includes('success')) {
                        return true;
                    }
                    return false;
                }

                console.log('üìù Respuesta webhook (JSON):', result);
                return result.valido === true || result.valid === true || result.success === true || result.status === 'valid';

            } catch (error) {
                console.error('‚ùå Error validando PIN:', error);
                
                // ‚úÖ MANEJO MEJORADO de errores sin mostrar alertas m√∫ltiples
                if (error.name === 'AbortError') {
                    console.log('‚è∞ Timeout en validaci√≥n PIN');
                    return false;
                } else if (error.name === 'TypeError' || error.message.includes('fetch')) {
                    console.log('üåê Error de conexi√≥n en validaci√≥n PIN');
                    // ‚úÖ NO mostrar alert aqu√≠, solo en casos espec√≠ficos
                    return false;
                } else {
                    console.log('‚ö†Ô∏è Error del servidor en validaci√≥n PIN');
                    return false;
                }
            }
        }

        function mostrarErrorPin(mensajePersonalizado = null) {
            // ‚úÖ SOLO mostrar error si no se ha validado correctamente Y es un error real
            if (pinValidado) {
                return; // No mostrar error si ya est√° validado
            }

            const mensajeDefault = `‚ùå PIN incorrecto para este supervisor

Verifica el PIN e intenta nuevamente.
Si el problema persiste, contacta al administrador del sistema.`;

            const mensaje = mensajePersonalizado || mensajeDefault;
            
            // ‚úÖ SOLO mostrar alert en errores cr√≠ticos, no en errores de conexi√≥n autom√°ticos
            if (mensajePersonalizado || !validandoPin) {
                alert(mensaje);
            }

            const pinInput = document.getElementById('supervisor_pin');
            pinInput.value = '';
            pinInput.className = 'pin-input';
            pinInput.focus();

            const status = document.getElementById('pin-status');
            status.textContent = '';

            pinValidado = false;
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
        }

        function habilitarFormulario() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
        }

        // ========================================
        // üìù DETECCI√ìN DE CAMBIOS
        // ========================================
        function detectarCambioMotivo() {
            const motivoActual = document.getElementById('motivo_cambio').value;
            const badge = document.getElementById('motivo-badge');
            const grupo = document.getElementById('group-motivo_cambio');
            const observaciones = document.getElementById('observaciones');

            // ‚úÖ LIMPIAR AYUDA CUANDO SE SELECCIONE MOTIVO
            if (motivoActual && observaciones.placeholder.includes('ERROR NO MAPEADO')) {
                observaciones.placeholder = 'Detalles adicionales, contexto de la situaci√≥n, confirmaciones telef√≥nicas, etc...';
                grupo.style.borderColor = '';
                grupo.style.backgroundColor = '';
            }

            // Mantener badge solo si realmente cambi√≥ vs original
            const motivoCambio = motivoOriginal && 
                                motivoActual !== motivoOriginal && 
                                !motivoActual.includes(motivoOriginal) && 
                                !motivoOriginal.includes(motivoActual);

            if (motivoCambio) {
                grupo.classList.add('motivo-changed');
                badge.style.display = 'block';
                badge.textContent = 'MODIFICADO';
                badge.style.backgroundColor = '#28a745';

                if (!observaciones.value) {
                    observaciones.placeholder = 'IMPORTANTE: Explica por qu√© el motivo real difiere del error reportado inicialmente...';
                }
            } else {
                grupo.classList.remove('motivo-changed');
                badge.style.display = 'none';
            }
        }

        // ========================================
        // üì§ ENV√çO OPTIMIZADO DEL FORMULARIO
        // ========================================
        async function enviarFormulario(e) {
            e.preventDefault();

            if (!validarFormularioCompleto()) {
                return;
            }

            const datosFormulario = recopilarDatosFormulario();
            const confirmacion = generarMensajeConfirmacion(datosFormulario);

            if (!confirm(confirmacion)) {
                return;
            }

            mostrarLoading(true);

            try {
                const result = await enviarWebhookManual(datosFormulario);
                mostrarExitoYRedirigir(result); // ‚úÖ Pasar resultado del webhook
            } catch (error) {
                console.error('Error enviando formulario:', error);
                mostrarErrorEnvio(error);
            } finally {
                mostrarLoading(false);
            }
        }

        function validarFormularioCompleto() {
            const campos = ['tecnico', 'zona', 'supervisor', 'turno', 'motivo_cambio'];

            for (let campo of campos) {
                const valor = document.getElementById(campo).value;
                if (!valor) {
                    alert(`‚ùå Campo requerido: ${campo.replace('_', ' ')}

Completa todos los campos obligatorios.`);
                    document.getElementById(campo).focus();
                    return false;
                }
            }

            const pin = document.getElementById('supervisor_pin').value;
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                alert('‚ùå PIN debe ser exactamente 4 d√≠gitos num√©ricos');
                document.getElementById('supervisor_pin').focus();
                return false;
            }

            if (!pinValidado) {
                alert('‚ùå PIN no validado\n\nEspera a que se valide el PIN o verifica que sea correcto.');
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const tecnico = document.getElementById('tecnico').value;
            const supervisor = document.getElementById('supervisor').value;

            if (!emailRegex.test(tecnico) || !emailRegex.test(supervisor)) {
                alert('‚ùå Formato de email inv√°lido\n\nVerifica que los emails tengan el formato correcto.');
                return false;
            }

            return true;
        }

        // ‚úÖ DATOS OPTIMIZADOS SIN DUPLICACIONES
        function recopilarDatosFormulario() {
            return {
                // ‚úÖ DATOS PRINCIPALES UNIFICADOS
                tecnico: document.getElementById('tecnico').value,
                zona_principal: parametrosURL.zona_principal,
                zona_utilizada: document.getElementById('zona').value,
                es_zona_secundaria: document.getElementById('zona').value !== parametrosURL.zona_principal,
                supervisor: document.getElementById('supervisor').value,
                turno: document.getElementById('turno').value,

                // ‚úÖ DATOS DEL SUPERVISOR
                supervisor_pin: document.getElementById('supervisor_pin').value,
                motivo_cambio: document.getElementById('motivo_cambio').value,
                observaciones: document.getElementById('observaciones').value,

                // ‚úÖ FECHAS OPTIMIZADAS (solo las necesarias)
                fecha_evento: parametrosURL.fecha_evento,
                timestamp: Math.floor(Date.now()/1000),

                // ‚úÖ CONTEXTO UNIFICADO
                horario_turno: parametrosURL.horario_turno,
                telefono: parametrosURL.telefono,
                hash_validacion: parametrosURL.hash_validacion,
                zonas_secundarias: parametrosURL.zonas_secundarias,

                // ‚úÖ METADATOS OPTIMIZADOS
                metodo_check_in: 'Supervisor',
                ubicacion_verificada: 'true',

                // ‚úÖ DISPOSITIVO UNIFICADO
                datos_dispositivo: JSON.stringify({
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    timestamp: Date.now(),
                    tipo_validacion: 'SUPERVISOR_MANUAL'
                }),

                // ‚úÖ ERROR CONTEXT
                error_message: motivoOriginal,
                motivo_cambiado: motivoOriginal && document.getElementById('motivo_cambio').value !== motivoOriginal,
                es_error_critico: esErrorCritico,

                // ‚úÖ HISTORIAL UNIFICADO
                historial_completo: JSON.stringify(historialErroresGPS)
            };
        }

        function generarMensajeConfirmacion(datos) {
            const motivoCambiado = datos.motivo_cambiado ? '\n‚ö†Ô∏è MOTIVO MODIFICADO POR SUPERVISOR' : '';
            const esCritico = datos.es_error_critico ? '\nüö® CASO CR√çTICO - ALTA PRIORIDAD' : '';

            return `‚úÖ CONFIRMAR CHECK-IN MANUAL${esCritico}${motivoCambiado}

üìã RESUMEN:
‚Ä¢ T√©cnico: ${datos.tecnico}
‚Ä¢ Zona: ${datos.zona_utilizada}
‚Ä¢ Turno: ${datos.turno}
‚Ä¢ Motivo: ${datos.motivo_cambio}
‚Ä¢ Supervisor: ${datos.supervisor}

${datos.observaciones ? `üí¨ Observaciones: ${datos.observaciones.substring(0, 100)}${datos.observaciones.length > 100 ? '...' : ''}` : ''}

‚ö†Ô∏è Esta acci√≥n ser√° registrada y auditada.
üìû Confirma que el t√©cnico est√° presente o localizable.

¬øConfirmas el check-in manual?`;
        }

        async function enviarWebhookManual(datos) {
            const url = WEBHOOK_MANUAL + '?' + new URLSearchParams(datos).toString();

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // ‚úÖ PARSEAR RESPUESTA DEL WEBHOOK
            let result;
            try {
                result = await response.json();
            } catch (parseError) {
                // Si no es JSON, asumir √©xito
                result = { success: true, message: "Check-in procesado" };
            }

            // ‚úÖ VALIDAR RESPUESTA DEL MAKE.COM
            if (result.success === false) {
                throw new Error(result.message || result.error || 'Error desconocido del servidor');
            }

            return result;
        }

        function mostrarExitoYRedirigir(result = {}) {
            const mensaje = result.message || 'CHECK-IN MANUAL PROCESADO EXITOSAMENTE';
            const tecnico = result.tecnico || document.getElementById('tecnico').value;
            const zona = result.zona || document.getElementById('zona').value;

            alert(`‚úÖ ${mensaje}

üë§ T√©cnico: ${tecnico}
üìç Zona: ${zona}
üìä Datos enviados al sistema
üìß Notificaciones enviadas
üì± Registro guardado en Notion

üëç Gracias por tu validaci√≥n como supervisor`);

            setTimeout(() => {
                window.close() || (window.location.href = 'about:blank');
            }, 2000);
        }

        function mostrarErrorEnvio(error) {
            let mensaje = `‚ùå ERROR PROCESANDO CHECK-IN MANUAL`;
            let detalles = error.message;
            let acciones = `üìû ACCI√ìN REQUERIDA:
‚Ä¢ Contacta inmediatamente con IT/Sistemas  
‚Ä¢ Confirma check-in por tel√©fono con el t√©cnico
‚Ä¢ Informa a RRHH de la situaci√≥n t√©cnica

‚ö†Ô∏è No cierres esta ventana hasta resolver el problema`;

            // ‚úÖ MANEJO ESPEC√çFICO DE ERRORES DEL SERVIDOR
            if (error.message.includes('TECNICO_NO_ENCONTRADO')) {
                mensaje = `‚ùå T√âCNICO NO ENCONTRADO`;
                detalles = `El t√©cnico ${document.getElementById('tecnico').value} no existe en el sistema`;
                acciones = `üìû ACCI√ìN REQUERIDA:
‚Ä¢ Verifica el email del t√©cnico
‚Ä¢ Contacta con RRHH para confirmar el registro
‚Ä¢ Si es un t√©cnico nuevo, debe ser dado de alta primero`;
            } else if (error.message.includes('PIN_INVALIDO')) {
                mensaje = `‚ùå PIN SUPERVISOR INCORRECTO`;
                detalles = `El PIN introducido no coincide con el asignado a este supervisor`;
                acciones = `üìû ACCI√ìN REQUERIDA:
‚Ä¢ Verifica tu PIN de supervisor
‚Ä¢ Si olvidaste tu PIN, contacta al administrador
‚Ä¢ El PIN debe ser exactamente 4 d√≠gitos`;
            }

            alert(`${mensaje}

üîç Detalles:
${detalles}

${acciones}`);
        }

        // ========================================
        // üö´ RECHAZO OPTIMIZADO
        // ========================================
        function rechazarCheckin() {
            const tecnico = document.getElementById('tecnico').value;
            const supervisor = document.getElementById('supervisor').value;

            if (!tecnico || !supervisor) {
                alert('‚ùå Faltan datos b√°sicos para procesar el rechazo');
                return;
            }

            const motivoRechazo = prompt(`‚ùå RECHAZAR SOLICITUD CHECK-IN MANUAL

T√©cnico: ${tecnico}
Supervisor: ${supervisor}

üìù Indica el motivo del rechazo:

Ejemplos:
‚Ä¢ T√©cnico no localizable telef√≥nicamente
‚Ä¢ T√©cnico confirm√≥ que no est√° en la zona
‚Ä¢ Sospecha de irregularidad en la solicitud
‚Ä¢ Falta informaci√≥n/documentaci√≥n necesaria
‚Ä¢ Otro motivo (especificar)

Motivo del rechazo:`);

            if (motivoRechazo && motivoRechazo.trim()) {
                procesarRechazo(motivoRechazo.trim());
            }
        }

        async function procesarRechazo(motivoRechazo) {
            // ‚úÖ DATOS OPTIMIZADOS SIN DUPLICACIONES
            const datosRechazo = {
                // Datos b√°sicos
                tecnico: document.getElementById('tecnico').value,
                supervisor: document.getElementById('supervisor').value,
                zona_principal: parametrosURL.zona_principal,
                zona_utilizada: document.getElementById('zona').value,
                turno: document.getElementById('turno').value,
                motivo_rechazo: motivoRechazo,

                // Fechas optimizadas
                fecha_evento: parametrosURL.fecha_evento,
                timestamp: Math.floor(Date.now()/1000),

                // Contexto
                horario_turno: parametrosURL.horario_turno,
                telefono: parametrosURL.telefono,
                hash_validacion: parametrosURL.hash_validacion,

                // Metadatos
                accion: 'RECHAZO_SUPERVISOR',
                metodo_check_in: 'Rechazado',
                ubicacion_verificada: 'NO_VERIFICADA',
                observaciones_sistema: `Rechazado por supervisor: ${motivoRechazo}`,

                // Error context
                error_message: motivoOriginal,

                // Datos dispositivo
                datos_dispositivo: JSON.stringify({
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    tipo_accion: 'RECHAZO_SUPERVISOR'
                }),

                // Historial
                historial_completo: JSON.stringify(historialErroresGPS)
            };

            const confirmacion = `‚ö†Ô∏è CONFIRMAR RECHAZO DE SOLICITUD

T√©cnico: ${datosRechazo.tecnico}
Motivo rechazo: ${motivoRechazo}

üìã CONSECUENCIAS:
‚Ä¢ Se marcar√° como "Ausente - No Justificado"
‚Ä¢ Se enviar√° notificaci√≥n a RRHH
‚Ä¢ Puede generar flag disciplinario
‚Ä¢ El t√©cnico ser√° notificado del rechazo

¬øConfirmas el RECHAZO de esta solicitud?`;

            if (confirm(confirmacion)) {
                mostrarLoading(true);

                try {
                    await enviarWebhookRechazo(datosRechazo);
                    mostrarRechazoExitoso();
                } catch (error) {
                    console.error('Error enviando rechazo:', error);
                    mostrarErrorEnvio(error);
                } finally {
                    mostrarLoading(false);
                }
            }
        }

        async function enviarWebhookRechazo(datos) {
            const url = WEBHOOK_RECHAZO + '?' + new URLSearchParams(datos).toString();
            console.log('üì§ Enviando rechazo a webhook:', url);

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            console.log('‚úÖ Rechazo enviado exitosamente');
            return response;
        }

        function mostrarRechazoExitoso() {
            alert('‚ùå SOLICITUD RECHAZADA CORRECTAMENTE\n\nüìä Registro de rechazo procesado\nüìß RRHH y t√©cnico notificados\nüìù Flag disciplinario activado\n\n‚ö†Ô∏è El t√©cnico deber√° justificar su ausencia\nüìû Recomendamos contacto directo con RRHH');

            setTimeout(() => {
                window.close() || (window.location.href = 'about:blank');
            }, 2000);
        }

        // ========================================
        // üé® UTILIDADES DE INTERFAZ
        // ========================================
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = mostrar ? 'flex' : 'none';

            if (mostrar) {
                document.body.style.pointerEvents = 'none';
            } else {
                document.body.style.pointerEvents = 'auto';
            }
        }

        // ========================================
        // üöÄ MEJORAS UX OPTIMIZADAS
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            const camposRequeridos = document.querySelectorAll('input[required], select[required]');
            camposRequeridos.forEach(campo => {
                const formGroup = campo.closest('.form-group') || campo.closest('.pin-group');
                if (formGroup) {
                    const label = formGroup.querySelector('label');
                    if (label && !label.textContent.includes('*') && !campo.hasAttribute('readonly')) {
                        label.innerHTML += ' <span style="color: #e74c3c;">*</span>';
                    }
                }
            });

            const tooltips = {
                'supervisor_pin': 'PIN de 4 d√≠gitos asignado por el administrador del sistema',
                'motivo_cambio': 'Selecciona el motivo m√°s espec√≠fico que describa la situaci√≥n',
                'observaciones': 'A√±ade cualquier contexto adicional que ayude a entender la situaci√≥n'
            };

            Object.entries(tooltips).forEach(([id, texto]) => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.title = texto;
                }
            });
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submit-btn').click();
            }

            if (e.key === 'Escape') {
                if (confirm('‚ùå ¬øQuieres rechazar esta solicitud de check-in?')) {
                    rechazarCheckin();
                }
            }
        });

        console.log('‚úÖ Formulario supervisor optimizado inicializado');
    </script>
</body>
</html>
