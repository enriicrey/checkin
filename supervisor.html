<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Manual Supervisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 550px;
            width: 100%;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .header h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #95a5a6;
        }
        
        .pin-group {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .pin-group label {
            color: #d68910 !important;
            font-weight: 700;
        }
        
        .pin-input {
            width: 180px !important;
            text-align: center;
            font-size: 24px !important;
            font-weight: bold;
            border: 2px solid #f39c12 !important;
            letter-spacing: 4px;
        }
        
        .pin-warning {
            margin-top: 10px;
            color: #d68910;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .footer-note {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h2 {
                font-size: 24px;
            }
            
            .pin-input {
                width: 150px !important;
                font-size: 20px !important;
            }
        }
        
        /* Estados hover para inputs */
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #bdc3c7;
        }
        
        /* Animación de entrada */
        .container {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>🔧 CHECK-IN MANUAL - SUPERVISOR</h2>
            <p class="subtitle">Sistema de Autorización de Presencia</p>
        </div>
        
        <form id="checkinForm">
            <!-- EMAIL TÉCNICO -->
            <div class="form-group">
                <label><span class="icon">👤</span>Email Técnico:</label>
                <input type="email" id="tecnico" required placeholder="ejemplo.tecnico@empresa.com">
            </div>
            
            <!-- ZONA DROPDOWN -->
            <div class="form-group">
                <label><span class="icon">📍</span>Zona de Trabajo:</label>
                <select id="zona" required>
                    <option value="">Seleccionar zona de trabajo...</option>
                    <option value="Todas">📋 Todas las zonas</option>
                    <option value="Almacén">📦 Almacén</option>
                    <option value="Laboratorio">🔬 Laboratorio</option>
                    <option value="Línea-A">🏭 Línea-A</option>
                    <option value="Línea-B">🏭 Línea-B</option>
                    <option value="Línea-C">🏭 Línea-C</option>
                    <option value="Mantenimiento">🔧 Mantenimiento</option>
                    <option value="Oficinas">🏢 Oficinas</option>
                    <option value="Transporte">🚚 Transporte</option>
                    <option value="Utilities">⚡ Utilities</option>
                </select>
            </div>
            
            <!-- EMAIL SUPERVISOR -->
            <div class="form-group">
                <label><span class="icon">📞</span>Email Supervisor:</label>
                <input type="email" id="supervisor" required placeholder="supervisor.ejemplo@empresa.com">
            </div>
            
            <!-- TURNO DROPDOWN -->
            <div class="form-group">
                <label><span class="icon">⏰</span>Turno de Trabajo:</label>
                <select id="turno" required>
                    <option value="">Seleccionar turno...</option>
                    <option value="A">🌅 Turno A (06:00-14:00)</option>
                    <option value="B">🌆 Turno B (14:00-22:00)</option>
                    <option value="C">🌙 Turno C (22:00-06:00)</option>
                    <option value="Central">🏢 Central (08:00-17:00)</option>
                </select>
            </div>
            
            <!-- PIN SUPERVISOR -->
            <div class="pin-group">
                <label><span class="icon">🔐</span>PIN de Autorización:</label>
                <input type="password" id="supervisor_pin" required 
                       placeholder="••••" 
                       maxlength="4" pattern="[0-9]{4}"
                       class="pin-input">
                <div class="pin-warning">
                    <span>⚠️</span>
                    <span>Solo supervisores autorizados pueden procesar check-ins manuales</span>
                </div>
            </div>
            
            <!-- MOTIVO -->
            <div class="form-group">
                <label><span class="icon">📝</span>Motivo del Check-in Manual:</label>
                <select id="motivo" required>
                    <option value="">Seleccionar motivo...</option>
                    <!-- Errores GPS específicos -->
                    <option value="Permisos de ubicación denegados">📱 Permisos de ubicación denegados</option>
                    <option value="Ubicación no disponible">📶 Ubicación no disponible</option>
                    <option value="Tiempo agotado obteniendo GPS">⏰ Tiempo agotado obteniendo GPS</option>
                    <option value="GPS no soportado en este dispositivo">🔧 GPS no soportado en este dispositivo</option>
                    <option value="GPS impreciso">📏 GPS impreciso</option>
                    <option value="GPS falló múltiples veces">🔄 GPS falló múltiples veces</option>
                    <option value="Ubicación fuera de España">🌍 Ubicación fuera de España</option>
                    <!-- Motivos generales -->
                    <option value="🔋 Batería agotada/teléfono apagado">🔋 Batería agotada/teléfono apagado</option>
                    <option value="📶 Sin cobertura móvil en zona">📶 Sin cobertura móvil en zona</option>
                    <option value="🚨 Emergencia operacional">🚨 Emergencia operacional</option>
                    <option value="🔧 Equipo/tablet empresa sin GPS">🔧 Equipo/tablet empresa sin GPS</option>
                    <option value="🏥 Problema médico leve (presente)">🏥 Problema médico leve (presente)</option>
                    <option value="🕐 Llegada tardía justificada">🕐 Llegada tardía justificada</option>
                    <option value="⚠️ Error técnico del sistema">⚠️ Error técnico del sistema</option>
                    <option value="📝 Otro motivo">📝 Otro motivo</option>
                </select>
            </div>
            
            <!-- OBSERVACIONES -->
            <div class="form-group">
                <label><span class="icon">💬</span>Observaciones Adicionales (opcional):</label>
                <textarea id="observaciones" placeholder="Detalles adicionales del motivo, contexto o información relevante..." rows="3"></textarea>
            </div>
            
            <button type="submit" class="submit-btn">
                ✅ AUTORIZAR CHECK-IN MANUAL
            </button>
            
            <div class="footer-note">
                <p>🔒 Información protegida y auditada</p>
                <p>⚠️ Solo usar cuando el técnico esté físicamente presente</p>
            </div>
        </form>
    </div>
    
    <script>
        // CARGAR DATOS AL INICIAR
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            
            // Auto-completar desde URL si existe
            if (params.get('tecnico')) {
                document.getElementById('tecnico').value = params.get('tecnico').replace('-', '@');
            }
            
            if (params.get('zona')) {
                document.getElementById('zona').value = params.get('zona');
            }
            
            if (params.get('supervisor')) {
                document.getElementById('supervisor').value = params.get('supervisor').replace('-', '@');
            }
            
            if (params.get('turno')) {
                document.getElementById('turno').value = params.get('turno');
            }
            
            // Pre-seleccionar motivo basado en error_message
            if (params.get('error_message')) {
                const errorMessage = decodeURIComponent(params.get('error_message'));
                
                // Buscar coincidencia exacta o parcial
                const motivoSelect = document.getElementById('motivo');
                let encontrado = false;
                
                // Buscar coincidencia exacta
                for (let option of motivoSelect.options) {
                    if (option.value === errorMessage) {
                        option.selected = true;
                        encontrado = true;
                        break;
                    }
                }
                
                // Si no encuentra exacta, buscar parcial para casos dinámicos
                if (!encontrado) {
                    for (let option of motivoSelect.options) {
                        // Para "GPS impreciso: 150m" buscar "GPS impreciso"
                        if (errorMessage.includes('GPS impreciso') && option.value.includes('GPS impreciso')) {
                            option.selected = true;
                            encontrado = true;
                            break;
                        }
                        // Para "Ubicación fuera de España: 40.123, 3.456" buscar "Ubicación fuera de España"
                        if (errorMessage.includes('Ubicación fuera de España') && option.value.includes('Ubicación fuera de España')) {
                            option.selected = true;
                            encontrado = true;
                            break;
                        }
                    }
                }
                
                // Si no encuentra ninguna coincidencia, dejar vacío para que el supervisor elija
                if (!encontrado) {
                    console.log('No se encontró coincidencia para:', errorMessage);
                }
            }
            
            // Auto-detectar turno por hora SOLO si no viene en URL
            if (!params.get('turno')) {
                const horaActual = new Date().getHours();
                let turnoSugerido = "";
                
                if (horaActual >= 6 && horaActual < 14) {
                    turnoSugerido = "A";
                } else if (horaActual >= 14 && horaActual < 22) {
                    turnoSugerido = "B";
                } else if (horaActual >= 8 && horaActual < 17) {
                    turnoSugerido = "Central";
                } else {
                    turnoSugerido = "C";
                }
                
                document.getElementById('turno').value = turnoSugerido;
            }
        };
        
        // ENVÍO FORMULARIO
        document.getElementById('checkinForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tecnico = document.getElementById('tecnico').value;
            const zona = document.getElementById('zona').value;
            const supervisor = document.getElementById('supervisor').value;
            const turno = document.getElementById('turno').value;
            const supervisorPin = document.getElementById('supervisor_pin').value;
            const motivo = document.getElementById('motivo').value;
            const observaciones = document.getElementById('observaciones').value;
            
            // Validaciones mejoradas
            if (supervisorPin.length !== 4 || !/^\d{4}$/.test(supervisorPin)) {
                alert('❌ PIN debe ser exactamente 4 dígitos numéricos\n\nIntenta de nuevo con un PIN válido.');
                document.getElementById('supervisor_pin').focus();
                return;
            }
            
            if (!tecnico || !zona || !supervisor || !turno || !motivo) {
                alert('❌ Por favor completa todos los campos obligatorios\n\nRevisa que no falte ningún campo marcado como requerido.');
                return;
            }
            
            // Validar formato email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(tecnico) || !emailRegex.test(supervisor)) {
                alert('❌ Formato de email inválido\n\nVerifica que los emails tengan el formato correcto.');
                return;
            }
            
            // Construir URL webhook con fecha completa
            const url = "https://hook.eu2.make.com/5cbp8q391axrc7nnbsuep6cxgzyqm55a" +
                       "?tecnico=" + encodeURIComponent(tecnico) +
                       "&zona=" + encodeURIComponent(zona) +
                       "&supervisor=" + encodeURIComponent(supervisor) +
                       "&turno=" + encodeURIComponent(turno) +
                       "&supervisor_pin=" + encodeURIComponent(supervisorPin) +
                       "&motivo=" + encodeURIComponent(motivo) +
                       "&observaciones=" + encodeURIComponent(observaciones) +
                       "&fecha=" + new Date().toISOString().split('T')[0] +
                       "&fecha_completa=" + encodeURIComponent(new Date().toISOString()) +
                       "&manual=true" +
                       "&timestamp=" + Math.floor(Date.now()/1000);
            
            // Confirmación mejorada
            const confirmMessage = `✅ CONFIRMAR CHECK-IN MANUAL
            
📋 RESUMEN:
• Técnico: ${tecnico}
• Zona: ${zona}
• Turno: ${turno}
• Motivo: ${motivo}
• Supervisor: ${supervisor}

⚠️ Esta acción será registrada y auditada.

¿Confirmas el check-in manual?`;
            
            if (confirm(confirmMessage)) {
                // Mostrar loading
                const btn = document.querySelector('.submit-btn');
                btn.innerHTML = '⏳ Procesando...';
                btn.disabled = true;
                
                // Pequeño delay para UX
                setTimeout(() => {
                    window.location.href = url;
                }, 1000);
            }
        });
        
        // Efectos adicionales
        document.getElementById('supervisor_pin').addEventListener('input', function(e) {
            // Solo números
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
