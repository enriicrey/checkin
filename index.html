<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check-in GPS T√©cnicos</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    .container {
      background: white;
      border-radius: 15px;
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .header { text-align: center; margin-bottom: 20px; }
    .header .icon { font-size: 50px; }
    .info-box { background: #f1f1f1; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
    .info-item { margin: 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .info-item strong { min-width: 80px; }
    
    /* Alerta de horario */
    .horario-alert {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      color: #856404;
    }
    .horario-alert h4 { margin: 0 0 8px 0; color: #f57c00; }
    .horario-permitido { background: #d4edda; border-color: #28a745; color: #155724; }
    .horario-fuera { background: #f8d7da; border-color: #dc3545; color: #721c24; }
    
    /* Alerta de fecha */
    .fecha-alert {
      background: #f8d7da;
      border: 2px solid #dc3545;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      color: #721c24;
    }
    
    /* Estilos para selectores */
    .zona-selector {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .motivo-selector {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      display: none;
    }
    .zona-selector h4 { color: #1e7e34; margin: 0 0 10px 0; }
    .motivo-selector h4 { color: #f57c00; margin: 0 0 10px 0; }
    .required { color: #dc3545; font-weight: bold; }
    
    .zona-info, .motivo-info {
      background: rgba(255,255,255,0.7);
      padding: 8px 12px;
      border-radius: 6px;
      margin: 8px 0 12px 0;
      font-size: 12px;
      color: #666;
    }
    
    .zone-option, .motivo-option {
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .zone-option:hover, .motivo-option:hover { 
      border-color: #007bff; 
      background: #f8f9fa; 
      transform: translateY(-1px);
    }
    .zone-option.selected { 
      border-color: #28a745; 
      background: #e8f5e8; 
      box-shadow: 0 2px 8px rgba(40,167,69,0.3);
    }
    .motivo-option.selected { 
      border-color: #ff9800; 
      background: #fff3e0; 
      box-shadow: 0 2px 8px rgba(255,152,0,0.3);
    }
    .zone-option.disabled, .motivo-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .zone-option .zone-name { 
      font-weight: bold; 
      color: #1e7e34; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .zone-option .zone-distance { 
      font-size: 12px; 
      color: #666; 
      margin-top: 6px; 
    }
    .zone-principal-badge {
      background: #28a745;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }
    .zone-secondary-badge {
      background: #17a2b8;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }
    
    .motivo-placeholder {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 8px;
    }
    .motivo-option[data-motivo=""] {
      border-style: dashed;
      border-color: #ccc;
      background: #f8f9fa;
    }
    .motivo-selected-display {
      border: 2px solid #007bff !important;
      background: #e3f2fd !important;
      font-weight: bold;
    }
    .motivo-selected-display .motivo-placeholder {
      color: #0056b3;
      font-weight: bold;
    }
    
    .button { 
      background: #2ecc71; 
      color: white; 
      padding: 12px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      width: 100%; 
      margin-bottom: 10px; 
      font-weight: bold; 
      transition: all 0.3s ease;
    }
    .button:disabled { background: #95a5a6; cursor: not-allowed; }
    .button.loading { background: #f39c12; animation: pulse 1s infinite; }
    .button-emergency { background: #e74c3c; }
    
    .success-box, .error-box, .warning-box { 
      padding: 15px; 
      border-radius: 8px; 
      font-weight: bold; 
      margin-bottom: 15px; 
      line-height: 1.4;
    }
    .success-box { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .error-box { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .warning-box { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    
    /* P√°gina de confirmaci√≥n */
    .confirmation-page {
      text-align: center;
      padding: 40px 20px;
    }
    .confirmation-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .confirmation-details {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    .confirmation-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .confirmation-item:last-child { border-bottom: none; }
    .confirmation-label { font-weight: bold; color: #495057; }
    .confirmation-value { color: #28a745; font-weight: bold; }
    
    .footer { font-size: 11px; text-align: center; margin-top: 15px; color: #666; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    .connectivity-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    .connectivity-online { background: #d4edda; color: #155724; }
    .connectivity-offline { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="connectivity-status" id="connectivity-status">Online</div>
  
  <div class="container">
    <div class="header">
      <div class="icon">üìç</div>
      <h1>CHECK-IN T√âCNICOS</h1>
      <div class="subtitle">Sistema de Control de Presencia</div>
    </div>

    <!-- Contenido principal del check-in -->
    <div id="checkin-content">
      <div class="info-box">
        <div class="info-item">
          <strong>üë§ T√©cnico:</strong> <span id="tecnico-nombre">Cargando...</span>
        </div>
        <div class="info-item">
          <strong>üéØ Zona Principal:</strong> <span id="zona-principal">Cargando...</span>
        </div>
        <div class="info-item">
          <strong>üìç Zonas Secundarias:</strong> <span id="zonas-secundarias">Verificando...</span>
        </div>
        <div class="info-item">
          <strong>üíº Turno de trabajo:</strong> <span id="turno-info">Cargando...</span>
        </div>
        <div class="info-item">
          <strong>‚è∞ Horario Check-in:</strong> <span id="horario-turno">Cargando...</span>
        </div>
        <div class="info-item">
          <strong>üïí Hora actual:</strong> <span id="hora-actual">--:--:--</span>
        </div>
      </div>

      <!-- Alerta de validaci√≥n de fecha -->
      <div class="fecha-alert" id="fecha-alert" style="display:none;">
        <h4>‚ùå Enlace no v√°lido para hoy</h4>
        <p>Este enlace es para otra fecha. Usa el enlace correcto del calendario de hoy.</p>
      </div>

      <!-- Alerta de horario -->
      <div class="horario-alert" id="horario-alert">
        <h4>‚è∞ Validando horario de turno...</h4>
        <p id="horario-mensaje">Verificando si est√° dentro del horario permitido...</p>
      </div>

      <!-- Selector de Zona de Trabajo -->
      <div class="zona-selector" id="zona-selector" style="display:none;">
        <h4>üéØ Zona de trabajo para este check-in:</h4>
        <div class="zona-info">
          <small>Por defecto: Zona principal seg√∫n calendario. Solo puedes seleccionar zonas autorizadas para ti.</small>
        </div>
        <div id="zona-options"></div>
      </div>

      <!-- Selector de Motivo -->
      <div class="motivo-selector" id="motivo-selector">
        <h4>üìù Motivo del trabajo en zona secundaria: <span class="required">*</span></h4>
        <div class="motivo-info">
          <small>Requerido cuando trabajas fuera de tu zona principal asignada</small>
        </div>
        <div id="motivo-options">
          <div class="motivo-option motivo-selected-display" data-motivo="" id="motivo-display">
            <div class="motivo-placeholder">üëÜ Selecciona un motivo v√°lido</div>
          </div>
          <div class="motivo-option" data-motivo="incidencia">üö® Atendiendo incidencia</div>
          <div class="motivo-option" data-motivo="mantenimiento">üîß Mantenimiento programado</div>
          <div class="motivo-option" data-motivo="mantenimiento_urgencia">‚ö° Mantenimiento de urgencia</div>
          <div class="motivo-option" data-motivo="apoyo">ü§ù Apoyo a otro t√©cnico</div>
          <div class="motivo-option" data-motivo="apoyo_interzonal">üîÑ Apoyo interzonal por carga de trabajo</div>
          <div class="motivo-option" data-motivo="ausencia_reemplazo">üë• Ausencia de un compa√±ero reemplazado</div>
          <div class="motivo-option" data-motivo="traslado">üöö Traslado de material/equipo</div>
          <div class="motivo-option" data-motivo="reunion">üíº Reuni√≥n de trabajo</div>
          <div class="motivo-option" data-motivo="supervision">üëî Supervisi√≥n/inspecci√≥n</div>
          <div class="motivo-option" data-motivo="planificacion_especial">üìã Cambio de planificaci√≥n (turno especial)</div>
          <div class="motivo-option" data-motivo="emergencia">üö® Situaci√≥n de emergencia</div>
          <div class="motivo-option" data-motivo="otro">‚ùì Otro motivo</div>
        </div>
      </div>

      <div class="status-message" id="status-message">
        <div class="warning-box">Validando par√°metros de acceso...</div>
      </div>

      <button class="button" id="gps-button" onclick="iniciarCheckIn()" disabled>VALIDANDO ACCESO...</button>
      <button class="button button-emergency" id="emergency-button" onclick="contactarSupervisor()">CONTACTAR SUPERVISOR</button>
    </div>

    <!-- P√°gina de confirmaci√≥n (oculta inicialmente) -->
    <div id="confirmation-content" style="display:none;">
      <div class="confirmation-page">
        <div class="confirmation-icon">‚úÖ</div>
        <h2>Check-in Completado</h2>
        <p>Tu presencia ha sido registrada exitosamente</p>
        
        <div class="confirmation-details" id="confirmation-details">
          <!-- Se llenar√° din√°micamente -->
        </div>
        
        <div class="success-box">
          <strong>¬øQu√© pasa ahora?</strong><br><br>
          üìä Tus datos se han enviado al sistema<br>
          üìß Tu supervisor ha sido notificado<br>
          üì± Puedes cerrar esta p√°gina<br><br>
          <small>Si tienes alg√∫n problema durante tu turno, contacta a tu supervisor.</small>
        </div>
        
        <button class="button" onclick="cerrarPagina()">CERRAR</button>
      </div>
    </div>

    <div class="footer">
      Datos protegidos | GPS activado | Integrado con Notion
    </div>
  </div>

  <script>
    // CONFIGURACI√ìN DE ZONAS CON EMOJIS
    const zonasConfiguracion = {
      "L√≠nea-A": { lat: 41.53838, lng: 1.8679, radio: 450, tipo: "produccion", codigo: "LA", emoji: "üè≠" },
      "Todas": { lat: 40.4168, lng: -3.7038, radio: 1000, tipo: "general", codigo: "ALL", emoji: "üåü" },
      "Utilities": { lat: 40.4200, lng: -3.7100, radio: 600, tipo: "utilities", codigo: "UTIL", emoji: "‚ö°" },
      "Laboratorio": { lat: 40.4150, lng: -3.7050, radio: 400, tipo: "laboratorio", codigo: "LAB", emoji: "üî¨" },
      "Mantenimiento": { lat: 40.4180, lng: -3.7080, radio: 700, tipo: "mantenimiento", codigo: "MANT", emoji: "üîß" },
      "Transporte": { lat: 40.4220, lng: -3.7120, radio: 800, tipo: "transporte", codigo: "TRANS", emoji: "üöö" },
      "Almac√©n": { lat: 40.4160, lng: -3.7040, radio: 500, tipo: "almacen", codigo: "ALM", emoji: "üì¶" },
      "L√≠nea-C": { lat: 40.4190, lng: -3.7090, radio: 450, tipo: "produccion", codigo: "LC", emoji: "üè≠" },
      "L√≠nea-B": { lat: 40.4170, lng: -3.7070, radio: 450, tipo: "produccion", codigo: "LB", emoji: "üè≠" },
      "Oficinas": { lat: 40.4210, lng: -3.7110, radio: 300, tipo: "oficinas", codigo: "OFIC", emoji: "üè¢" }
    };

    // WEBHOOKS PARA MAKE
    const webhookExitoso = 'https://hook.eu2.make.com/ce7vo1vgbpboaf9moajxp28uv7dh5mnm';
    const webhookManual = 'https://hook.eu2.make.com/l2fczz9kmprj996pxf7tfbtnvw2nmak0';

    // VARIABLES GLOBALES
    const MAX_INTENTOS = 3;
    let parametrosURL = {};
    let intentosGPS = 0; // CONTADOR UNIFICADO para todos los errores
    let ubicacionActual = null;
    let zonaSeleccionada = null;
    let motivoSeleccionado = null;
    let zonasSecundariasArray = [];
    let deviceFingerprint = {};
    let conectividadOnline = true;
    let fechaValida = false;
    let horarioValido = false;
    let zonasAutorizadas = [];
    let historialErroresGPS = []; // HISTORIAL COMPLETO para todos los eventos

    // INICIALIZACI√ìN
    window.onload = function() {
      cargarParametros();
      actualizarHora();
      setInterval(actualizarHora, 1000);
      inicializarDeteccionDispositivo();
      inicializarConectividad();
      validarAcceso();
    };

    function cargarParametros() {
      const params = new URLSearchParams(window.location.search);
      parametrosURL = {
        tecnico: params.get('t') || '',
        zona_principal: params.get('z') || '',
        zonas_secundarias: params.get('zs') || '',
        turno: params.get('tu') || '',
        supervisor: params.get('s') || '',
        telefono: params.get('tel') || '',
        fecha_evento: params.get('f') || '',
        horario_turno: params.get('h') || '',
        hash_validacion: params.get('hash') || ''
      };

      // Procesar zonas autorizadas (principal + secundarias)
      zonasAutorizadas = [];
      if (parametrosURL.zona_principal) {
        zonasAutorizadas.push(parametrosURL.zona_principal);
      }
      if (parametrosURL.zonas_secundarias) {
        zonasSecundariasArray = parametrosURL.zonas_secundarias.split(',').map(z => z.trim());
        zonasAutorizadas.push(...zonasSecundariasArray);
      }

      // Actualizar interfaz
      document.getElementById('tecnico-nombre').textContent = parametrosURL.tecnico || 'No especificado';
      document.getElementById('zona-principal').textContent = parametrosURL.zona_principal || 'No especificada';
      document.getElementById('zonas-secundarias').textContent = 
        zonasSecundariasArray.length > 0 ? zonasSecundariasArray.join(', ') : 'Ninguna autorizada';
      document.getElementById('turno-info').textContent = parametrosURL.turno || 'No especificado';
      document.getElementById('horario-turno').textContent = parametrosURL.horario_turno || 'No especificado';

      // Zona seleccionada por defecto: zona principal
      zonaSeleccionada = parametrosURL.zona_principal;
      motivoSeleccionado = null;
    }

    function actualizarHora() {
      const ahora = new Date();
      document.getElementById('hora-actual').textContent = ahora.toLocaleTimeString('es-ES', { 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
      });
    }

    // VALIDACI√ìN DE ACCESO COMPLETA
    function validarAcceso() {
      // 1. Validar par√°metros b√°sicos primero
      if (!parametrosURL.tecnico || !parametrosURL.zona_principal) {
        mostrarError('‚ùå Enlace incompleto. Faltan par√°metros obligatorios.');
        return;
      }

      // 2. Validar fecha del evento
      if (!validarFechaEvento()) {
        return;
      }

      // 3. Validar zonas autorizadas
      if (!validarZonasAutorizadas()) {
        return;
      }

      // 4. Validar horario de turno (al final para mejor UX)
      if (!validarHorarioTurno()) {
        return;
      }

      // 5. Si todo es v√°lido, mostrar interfaz
      mostrarInterfazCheckIn();
    }

    function validarFechaEvento() {
      const hoy = new Date().toISOString().split('T')[0];
      
      if (!parametrosURL.fecha_evento) {
        parametrosURL.fecha_evento = hoy;
        fechaValida = true;
        return true;
      }
      
      if (parametrosURL.fecha_evento !== hoy) {
        fechaValida = false;
        document.getElementById('fecha-alert').style.display = 'block';
        document.getElementById('fecha-alert').innerHTML = `
          <h4>‚ùå Enlace no v√°lido para hoy</h4>
          <p><strong>Fecha del enlace:</strong> ${parametrosURL.fecha_evento}<br>
          <strong>Fecha actual:</strong> ${hoy}<br><br>
          Este enlace corresponde a otro d√≠a. Usa el enlace correcto del calendario de hoy.</p>
        `;
        mostrarError('‚ùå Este enlace no es v√°lido para la fecha de hoy.');
        return false;
      }

      fechaValida = true;
      return true;
    }

    function validarHorarioTurno() {
      if (!parametrosURL.horario_turno) {
        horarioValido = true;
        document.getElementById('horario-alert').style.display = 'none';
        return true;
      }

      const ahora = new Date();
      const horaActual = ahora.getHours() * 60 + ahora.getMinutes();
      
      try {
        const [inicio, fin] = parametrosURL.horario_turno.split('-');
        const [horaInicio, minInicio] = inicio.split(':').map(Number);
        const [horaFin, minFin] = fin.split(':').map(Number);
        
        const minutosInicio = horaInicio * 60 + minInicio;
        const minutosFin = horaFin * 60 + minFin;
        
        let dentroHorario = false;
        
        if (minutosInicio <= minutosFin) {
          dentroHorario = horaActual >= minutosInicio && horaActual <= minutosFin;
        } else {
          dentroHorario = horaActual >= minutosInicio || horaActual <= minutosFin;
        }

        const alertDiv = document.getElementById('horario-alert');
        const mensajeDiv = document.getElementById('horario-mensaje');
        
        if (dentroHorario) {
          horarioValido = true;
          alertDiv.className = 'horario-alert horario-permitido';
          mensajeDiv.innerHTML = `‚úÖ <strong>Horario Check-in v√°lido</strong><br>
            Ventana check-in: ${parametrosURL.horario_turno} | Hora actual: ${ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}<br>
            <small>üí° Este es el horario para hacer check-in, antes del inicio de tu turno de trabajo</small>`;
          return true;
        } else {
          horarioValido = false;
          alertDiv.className = 'horario-alert horario-fuera';
          
          let minutosHastaTurno;
          if (horaActual < minutosInicio) {
            minutosHastaTurno = minutosInicio - horaActual;
          } else {
            minutosHastaTurno = (24 * 60) - horaActual + minutosInicio;
          }
          
          const horasRestantes = Math.floor(minutosHastaTurno / 60);
          const minRestantes = minutosHastaTurno % 60;
          
          mensajeDiv.innerHTML = `‚è∞ <strong>Fuera de horario de check-in</strong><br>
            Ventana check-in: ${parametrosURL.horario_turno}<br>
            Tiempo hasta ventana check-in: ${horasRestantes}h ${minRestantes}min<br><br>
            <small>üí° Solo puedes hacer check-in durante la ventana horaria asignada<br>
            Si es una emergencia, contacta a tu supervisor.</small>`;
          
          mostrarError('‚ùå No puedes hacer check-in fuera de tu horario asignado.');
          return false;
        }
      } catch (error) {
        horarioValido = false;
        document.getElementById('horario-mensaje').innerHTML = '‚ùå Error en formato de horario check-in. Contacta al administrador.';
        mostrarError('‚ùå Error en configuraci√≥n de horario check-in.');
        return false;
      }
    }

    function validarZonasAutorizadas() {
      const zonasInvalidas = zonasAutorizadas.filter(zona => !zonasConfiguracion[zona]);
      
      if (zonasInvalidas.length > 0) {
        mostrarError(`‚ùå Zonas no v√°lidas en configuraci√≥n: ${zonasInvalidas.join(', ')}`);
        return false;
      }

      if (zonasAutorizadas.length === 0) {
        mostrarError('‚ùå No tienes zonas autorizadas para check-in.');
        return false;
      }

      return true;
    }

    function mostrarInterfazCheckIn() {
      if (!fechaValida || !horarioValido) {
        return;
      }

      document.getElementById('horario-alert').style.display = 'none';
      document.getElementById('fecha-alert').style.display = 'none';

      mostrarSelectorZonas();
      configurarSelectores();

      const gpsButton = document.getElementById('gps-button');
      gpsButton.disabled = false;
      gpsButton.innerHTML = 'OBTENER UBICACI√ìN Y CHECK-IN';

      mostrarEstado('‚úÖ Acceso validado. Selecciona tu zona de trabajo y procede con el check-in.');
    }

    function inicializarDeteccionDispositivo() {
      deviceFingerprint = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        timestamp: Date.now(),
        riskLevel: 'LOW'
      };
    }

    function inicializarConectividad() {
      conectividadOnline = navigator.onLine;
      document.getElementById('connectivity-status').textContent = conectividadOnline ? 'Online' : 'Offline';
    }

    function validarConectividad() {
      return Promise.resolve(conectividadOnline);
    }

    function mostrarSelectorZonas() {
      const selector = document.getElementById('zona-selector');
      const options = document.getElementById('zona-options');
      
      options.innerHTML = '';
      zonasAutorizadas.forEach((zona) => {
        const config = zonasConfiguracion[zona];
        if (!config) return;
        
        const esPrincipal = zona === parametrosURL.zona_principal;
        
        const optionDiv = document.createElement('div');
        optionDiv.className = `zone-option ${zonaSeleccionada === zona ? 'selected' : ''}`;
        optionDiv.innerHTML = `
          <div class="zone-name">
            ${config.emoji} ${zona}
            <span class="${esPrincipal ? 'zone-principal-badge' : 'zone-secondary-badge'}">
              ${esPrincipal ? 'PRINCIPAL' : 'SECUNDARIA'}
            </span>
          </div>
          <div class="zone-distance">
            üìè Radio: ${config.radio}m | üè∑Ô∏è Tipo: ${config.tipo}
            ${esPrincipal ? ' - Zona asignada seg√∫n calendario' : ' - Requiere motivo'}
          </div>
        `;
        
        optionDiv.addEventListener('click', function() {
          document.querySelectorAll('.zone-option').forEach(o => o.classList.remove('selected'));
          document.querySelectorAll('.motivo-option').forEach(o => o.classList.remove('selected'));
          
          this.classList.add('selected');
          zonaSeleccionada = zona;
          motivoSeleccionado = null;
          
          // Reset motivo display
          const motivoDisplay = document.getElementById('motivo-display');
          motivoDisplay.innerHTML = '<div class="motivo-placeholder">üëá Selecciona un motivo v√°lido</div>';
          motivoDisplay.classList.remove('selected');
          
          const motivoSelector = document.getElementById('motivo-selector');
          if (!esPrincipal) {
            motivoSelector.style.display = 'block';
            mostrarEstado('Zona secundaria seleccionada. Debes seleccionar un motivo v√°lido.');
          } else {
            motivoSelector.style.display = 'none';
            mostrarEstado('Zona principal seleccionada. Puedes proceder con el check-in.');
          }
          
          validarSeleccionCompleta();
        });
        
        options.appendChild(optionDiv);
      });
      
      selector.style.display = 'block';
    }

    function configurarSelectores() {
      document.querySelectorAll('.motivo-option').forEach(option => {
        // Skip el display option
        if (option.id === 'motivo-display') return;
        
        option.addEventListener('click', function() {
          const motivo = this.dataset.motivo;
          if (motivo === '') return;
          
          // Limpiar selecciones anteriores
          document.querySelectorAll('.motivo-option').forEach(o => o.classList.remove('selected'));
          
          // Seleccionar este motivo
          this.classList.add('selected');
          motivoSeleccionado = motivo;
          
          // Actualizar el display del motivo seleccionado
          const motivoDisplay = document.getElementById('motivo-display');
          motivoDisplay.innerHTML = this.innerHTML;
          motivoDisplay.classList.add('selected');
          
          validarSeleccionCompleta();
        });
      });
    }

    function validarSeleccionCompleta() {
      const esZonaSecundaria = zonaSeleccionada !== parametrosURL.zona_principal;
      const tieneMotivo = motivoSeleccionado && motivoSeleccionado !== '';
      
      let puedeCheckIn = false;
      let mensaje = '';
      
      if (!esZonaSecundaria) {
        puedeCheckIn = true;
        mensaje = 'Listo para check-in en zona principal';
      } else if (esZonaSecundaria && tieneMotivo) {
        puedeCheckIn = true;
        mensaje = `Listo para check-in en ${zonaSeleccionada} - Motivo: ${obtenerTextoMotivo(motivoSeleccionado)}`;
      } else {
        puedeCheckIn = false;
        mensaje = 'Debes seleccionar un motivo para trabajar en zona secundaria';
      }
      
      const gpsButton = document.getElementById('gps-button');
      gpsButton.disabled = !puedeCheckIn;
      
      if (puedeCheckIn) {
        mostrarEstado(mensaje);
        gpsButton.style.background = '#2ecc71';
        gpsButton.innerHTML = 'OBTENER UBICACI√ìN Y CHECK-IN';
      } else {
        mostrarError(mensaje);
        gpsButton.style.background = '#95a5a6';
        gpsButton.innerHTML = 'COMPLETA SELECCI√ìN';
      }
    }

    function obtenerTextoMotivo(motivo) {
      const motivos = {
        'incidencia': 'üö® Atendiendo incidencia',
        'mantenimiento': 'üîß Mantenimiento programado',
        'mantenimiento_urgencia': '‚ö° Mantenimiento de urgencia',
        'apoyo': 'ü§ù Apoyo a otro t√©cnico',
        'apoyo_interzonal': 'üîÑ Apoyo interzonal por carga de trabajo',
        'ausencia_reemplazo': 'üë• Ausencia de un compa√±ero reemplazado',
        'traslado': 'üöö Traslado de material/equipo',
        'reunion': 'üíº Reuni√≥n de trabajo',
        'supervision': 'üëî Supervisi√≥n/inspecci√≥n',
        'planificacion_especial': 'üìã Cambio de planificaci√≥n (turno especial)',
        'emergencia': 'üö® Situaci√≥n de emergencia',
        'otro': '‚ùì Otro motivo'
      };
      return motivos[motivo] || motivo;
    }

    function validarUbicacionConZonasSecundarias(lat, lng) {
      const zona = zonasConfiguracion[zonaSeleccionada];
      if (!zona) {
        return {
          valido: false,
          codigo: "ZONA_NO_CONFIGURADA",
          mensaje: `Zona "${zonaSeleccionada}" no configurada`,
          zona_utilizada: zonaSeleccionada,
          es_zona_secundaria: false
        };
      }

      const distancia = calcularDistancia(lat, lng, zona.lat, zona.lng);
      const esZonaSecundaria = zonasSecundariasArray.includes(zonaSeleccionada);
      const ubicacionReportada = `${lat.toFixed(6)},${lng.toFixed(6)}`;

      if (distancia <= zona.radio) {
        return {
          valido: true,
          codigo: "UBICACION_VALIDA",
          mensaje: `Check-in exitoso en ${zonaSeleccionada}`,
          distancia: Math.round(distancia),
          zona_utilizada: zonaSeleccionada,
          es_zona_secundaria: esZonaSecundaria,
          motivo_cambio: motivoSeleccionado,
          metodo_checkin: "GPS",
          ubicacion_reportada: ubicacionReportada,
          ubicacion_verificada: "V√°lida",
          observaciones_sistema: `GPS: ${Math.round(distancia)}m del centro de ${zonaSeleccionada}${esZonaSecundaria ? ' (zona secundaria)' : ''}`
        };
      }

      return {
        valido: false,
        codigo: "ZONA_LEJANA",
        mensaje: `Alejado de ${zonaSeleccionada}`,
        distancia: Math.round(distancia),
        zona_utilizada: zonaSeleccionada,
        es_zona_secundaria: esZonaSecundaria,
        motivo_cambio: motivoSeleccionado,
        metodo_checkin: "Manual",
        ubicacion_reportada: ubicacionReportada,
        ubicacion_verificada: "No V√°lida"
      };
    }

    // ========================================
    // FUNCIONES MEJORADAS DE MANEJO DE ERRORES
    // ========================================

    // FUNCI√ìN PARA ERRORES CR√çTICOS (supervisor inmediato)
    async function manejarErrorCritico(tipo, datos, mensaje) {
      console.log(`üö® Error cr√≠tico detectado: ${tipo}`);
      
      // Registrar en historial
      const evento = {
        intento: intentosGPS + 1,
        timestamp: new Date().toISOString(),
        tipo: tipo,
        detalle: mensaje,
        datos_completos: datos,
        nivel_criticidad: 'CRITICO'
      };
      
      historialErroresGPS.push(evento);
      
      // Enviar inmediatamente al supervisor
      enviarSupervisorInmediato(tipo, evento);
      
      // Bloquear interfaz completamente
      bloquearInterfazCritica(mensaje);
    }

    // FUNCI√ìN PARA ERRORES NORMALES (con reintentos)
    function manejarErrorConReintentos(tipo, evento, mensaje) {
      console.log(`‚ö†Ô∏è Error normal detectado: ${tipo} (Intento ${intentosGPS}/${MAX_INTENTOS})`);
      
      // A√±adir tipo y detalles al evento
      evento.tipo = tipo;
      evento.detalle = mensaje;
      evento.nivel_criticidad = 'NORMAL';
      
      // Registrar en historial
      historialErroresGPS.push(evento);
      
      // Verificar si se alcanz√≥ el l√≠mite
      if (intentosGPS >= MAX_INTENTOS) {
        // Enviar todo el historial al supervisor
        enviarHistorialCompleto('LIMITE_ALCANZADO');
        bloquearInterfazLimite();
      } else {
        // Permitir reintento
        mostrarErrorConOpcionReintento(mensaje, tipo);
        resetearBotonParaReintento();
      }
    }

    // ENV√çO INMEDIATO AL SUPERVISOR (casos cr√≠ticos)
    function enviarSupervisorInmediato(tipo, evento) {
      const url = webhookManual + 
                 `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
                 `&evento_critico=${tipo}` +
                 `&timestamp=${Date.now()}` +
                 `&coordenadas=${evento.datos_completos?.lat || 'N/A'},${evento.datos_completos?.lng || 'N/A'}` +
                 `&accuracy=${evento.datos_completos?.accuracy || 'N/A'}` +
                 `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
                 `&zona_intentada=${encodeURIComponent(zonaSeleccionada || 'N/A')}` +
                 `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
                 `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
                 `&detalle_error=${encodeURIComponent(evento.detalle)}` +
                 `&dispositivo_ip=${evento.datos_completos?.dispositivo?.ip_publica || 'N/A'}` +
                 `&dispositivo_timezone=${evento.datos_completos?.dispositivo?.timezone || 'N/A'}` +
                 `&anomalias_detectadas=${encodeURIComponent(JSON.stringify(evento.datos_completos?.anomalias || []))}` +
                 `&datos_dispositivo=${encodeURIComponent(JSON.stringify(evento.datos_completos?.dispositivo || {}))}`;
      
      fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Supervisor notificado inmediatamente'))
        .catch(() => console.log('‚ùå Error notificando supervisor'));
    }

    // BLOQUEO DE INTERFAZ PARA CASOS CR√çTICOS
    function bloquearInterfazCritica(mensaje) {
      // Mostrar mensaje cr√≠tico
      document.getElementById('status-message').innerHTML = `
        <div class="error-box">
          üö® <strong>Error cr√≠tico detectado</strong><br><br>
          ${mensaje}<br><br>
          üìß <strong>Supervisor notificado autom√°ticamente</strong><br>
          üîî Te contactar√° para revisar la situaci√≥n<br><br>
          üìû <strong>Contacto directo:</strong><br>
          <a href="tel:${parametrosURL.telefono}" style="font-size: 16px; font-weight: bold;">${parametrosURL.telefono}</a><br><br>
          ‚ö†Ô∏è <strong>Este tipo de error requiere validaci√≥n manual inmediata</strong>
        </div>`;
        
      // Deshabilitar todos los botones permanentemente
      const gpsButton = document.getElementById('gps-button');
      gpsButton.disabled = true;
      gpsButton.innerHTML = 'üö® ERROR CR√çTICO DETECTADO';
      gpsButton.style.background = '#dc3545';
      gpsButton.style.opacity = '0.7';
      gpsButton.classList.remove('loading');
      
      const emergencyButton = document.getElementById('emergency-button');
      emergencyButton.disabled = true;
      emergencyButton.innerHTML = 'üìß SUPERVISOR NOTIFICADO';
      emergencyButton.style.background = '#6c757d';
      emergencyButton.style.opacity = '0.7';
    }

    // BLOQUEO DE INTERFAZ POR L√çMITE ALCANZADO
    function bloquearInterfazLimite() {
      document.getElementById('status-message').innerHTML = `
        <div class="error-box">
          ‚ùå <strong>M√°ximo de intentos alcanzado (${MAX_INTENTOS})</strong><br><br>
          üìß <strong>Historial completo enviado al supervisor</strong><br>
          üîî Te contactar√° para procesar check-in manual<br><br>
          üìû <strong>Contacta directamente:</strong><br>
          <a href="tel:${parametrosURL.telefono}" style="font-size: 16px; font-weight: bold;">${parametrosURL.telefono}</a><br><br>
          üí° <strong>Posibles soluciones:</strong><br>
          ‚Ä¢ Verificar permisos de ubicaci√≥n<br>
          ‚Ä¢ Salir al exterior para mejor se√±al GPS<br>
          ‚Ä¢ Reiniciar navegador si persiste
        </div>`;
        
      // Deshabilitar botones
      const gpsButton = document.getElementById('gps-button');
      gpsButton.disabled = true;
      gpsButton.innerHTML = '‚ùå M√ÅXIMO INTENTOS ALCANZADO';
      gpsButton.style.background = '#dc3545';
      gpsButton.style.opacity = '0.7';
      gpsButton.classList.remove('loading');
      
      const emergencyButton = document.getElementById('emergency-button');
      emergencyButton.disabled = true;
      emergencyButton.innerHTML = 'üìß SUPERVISOR NOTIFICADO';
      emergencyButton.style.background = '#6c757d';
      emergencyButton.style.opacity = '0.7';
    }

    // MOSTRAR ERROR CON OPCI√ìN DE REINTENTO
    function mostrarErrorConOpcionReintento(mensaje, tipo) {
      const sugerencias = {
        'GPS_IMPRECISO': 'Sal al exterior o busca zona con mejor cobertura GPS',
        'FUERA_ZONA': 'Despl√°zate hacia el centro de tu zona asignada',
        'ERROR_TECNICO_GPS': 'Verifica permisos de ubicaci√≥n en el navegador'
      };
      
      document.getElementById('status-message').innerHTML = `
        <div class="warning-box">
          ‚ö†Ô∏è ${mensaje}<br><br>
          üîÑ <strong>Intento ${intentosGPS}/${MAX_INTENTOS}</strong><br>
          üìä <em>Evento registrado para auditor√≠a</em><br><br>
          üí° <strong>Sugerencia:</strong> ${sugerencias[tipo] || 'Reintenta tras verificar las condiciones'}<br><br>
          üìû <strong>Si necesitas ayuda:</strong> Contacta a tu supervisor
        </div>`;
    }

    // RESETEAR BOT√ìN PARA PERMITIR REINTENTO
    function resetearBotonParaReintento() {
      if (intentosGPS < MAX_INTENTOS) {
        const button = document.getElementById('gps-button');
        button.innerHTML = `REINTENTO ${intentosGPS + 1}/${MAX_INTENTOS} - OBTENER UBICACI√ìN`;
        button.disabled = false;
        button.classList.remove('loading');
        button.style.background = '#f39c12'; // Color naranja para reintentos
        
        // Validar que la selecci√≥n siga siendo correcta
        validarSeleccionCompleta();
      }
    }

    // ========================================
    // FUNCIONES AUXILIARES MEJORADAS
    // ========================================

    // FUNCI√ìN MEJORADA PARA OBTENER DATOS DEL DISPOSITIVO
    async function obtenerDatosDispositivoMejorado() {
        const dispositivo = {
            // Datos b√°sicos existentes
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            
            // NUEVOS: Datos de red y ubicaci√≥n
            ip_publica: await obtenerIPPublica().catch(() => 'no_disponible'),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezone_offset: new Date().getTimezoneOffset(),
            
            // NUEVOS: Capacidades del dispositivo  
            screen_resolution: `${screen.width}x${screen.height}`,
            color_depth: screen.colorDepth,
            pixel_ratio: window.devicePixelRatio,
            
            // NUEVOS: Detecci√≥n de entorno
            touch_support: 'ontouchstart' in window,
            webgl_info: obtenerWebGLInfo(),
            
            // NUEVOS: Detecci√≥n anti-bot
            webdriver: navigator.webdriver || false,
            automation_indicators: detectarAutomation(),
            
            // Metadatos
            timestamp_dispositivo: Date.now(),
            connection_type: navigator.connection?.effectiveType || 'unknown'
        };
        
        return dispositivo;
    }

    // OBTENER IP P√öBLICA
    async function obtenerIPPublica() {
        try {
            const response = await fetch('https://api.ipify.org?format=json', {
                timeout: 5000
            });
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.log('No se pudo obtener IP p√∫blica:', error);
            return 'no_disponible';
        }
    }

    // INFORMACI√ìN WebGL
    function obtenerWebGLInfo() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (!gl) return 'no_disponible';
            
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            return {
                vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown',
                renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown'
            };
        } catch (error) {
            return 'error';
        }
    }

    // DETECTAR AUTOMATION (bots, scripts)
    function detectarAutomation() {
        const indicadores = [];
        
        // Selenium
        if (window.navigator.webdriver) {
            indicadores.push('SELENIUM_WEBDRIVER');
        }
        
        // Phantom JS
        if (window.callPhantom || window._phantom) {
            indicadores.push('PHANTOM_JS');
        }
        
        // Headless Chrome
        if (navigator.userAgent.includes('HeadlessChrome')) {
            indicadores.push('HEADLESS_CHROME');
        }
        
        // Propiedades an√≥malas
        if (navigator.plugins.length === 0 && !navigator.userAgent.includes('Mobile')) {
            indicadores.push('SIN_PLUGINS_DESKTOP');
        }
        
        return indicadores;
    }

    // ANALIZAR COHERENCIA DEL DISPOSITIVO
    async function analizarCoherenciaDispositivo(coords, dispositivo) {
        const anomalias = [];
        
        // 1. Timezone vs GPS
        if (dispositivo.timezone && !dispositivo.timezone.includes('Europe') && 
            coords.lat > 35 && coords.lat < 45 && coords.lng > -10 && coords.lng < 5) {
            anomalias.push('TIMEZONE_GPS_INCOHERENTE');
        }
        
        // 2. Indicadores de automation
        if (dispositivo.automation_indicators.length > 0) {
            anomalias.push('AUTOMATION_DETECTADA');
        }
        
        // 3. WebGL sospechoso
        if (dispositivo.webgl_info.renderer && 
            (dispositivo.webgl_info.renderer.includes('SwiftShader') || 
             dispositivo.webgl_info.renderer.includes('VMware'))) {
            anomalias.push('WEBGL_EMULADOR');
        }
        
        // 4. Resoluci√≥n t√≠pica de emulador
        if (dispositivo.screen_resolution === '393x851' || // Android emulator
            dispositivo.screen_resolution === '375x667' || // iPhone emulator
            dispositivo.screen_resolution === '1920x1080' && dispositivo.pixel_ratio === 1) {
            anomalias.push('RESOLUCION_EMULADOR_TIPICA');
        }
        
        // 5. User Agent vs capacidades
        if (navigator.userAgent.includes('Mobile') && !dispositivo.touch_support) {
            anomalias.push('MOBILE_SIN_TOUCH');
        }
        
        return anomalias;
    }

    // CALCULAR DISTANCIA M√çNIMA AL BORDE DE ESPA√ëA
    function calcularDistanciaMinimaBordeEspana(lat, lng) {
        // Coordenadas aproximadas de los bordes de Espa√±a
        const bordeEspana = {
            norte: 43.79,
            sur: 35.95,
            este: 4.32,
            oeste: -9.30
        };
        
        let distanciaMinima = Infinity;
        
        // Distancia a cada borde
        if (lat > bordeEspana.norte) {
            distanciaMinima = Math.min(distanciaMinima, 
                calcularDistancia(lat, lng, bordeEspana.norte, lng));
        }
        if (lat < bordeEspana.sur) {
            distanciaMinima = Math.min(distanciaMinima, 
                calcularDistancia(lat, lng, bordeEspana.sur, lng));
        }
        if (lng > bordeEspana.este) {
            distanciaMinima = Math.min(distanciaMinima, 
                calcularDistancia(lat, lng, lat, bordeEspana.este));
        }
        if (lng < bordeEspana.oeste) {
            distanciaMinima = Math.min(distanciaMinima, 
                calcularDistancia(lat, lng, lat, bordeEspana.oeste));
        }
        
        return Math.round(distanciaMinima);
    }

    // ========================================
    // FUNCI√ìN exitoGPS MEJORADA
    // ========================================
    
    async function exitoGPS(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      const timestamp = position.timestamp || Date.now();

      // VALIDACIONES B√ÅSICAS PRIMERO
      
      // 1. Coordenadas v√°lidas
      if (!lat || !lng || isNaN(lat) || isNaN(lng) || !isFinite(lat) || !isFinite(lng)) {
        return manejarErrorCritico('COORDENADAS_INVALIDAS', {lat, lng, accuracy}, 'Coordenadas GPS inv√°lidas detectadas');
      }
      
      // 2. Coordenadas nulas (0,0) - Error com√∫n
      if (lat === 0 && lng === 0) {
        return manejarErrorCritico('COORDENADAS_NULAS', {lat, lng, accuracy}, 'GPS devolvi√≥ coordenadas nulas');
      }
      
      // 3. Coordenadas fuera de rango mundial
      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        return manejarErrorCritico('COORDENADAS_FUERA_RANGO', {lat, lng, accuracy}, 'Coordenadas fuera del rango terrestre');
      }

      // OBTENER DATOS DEL DISPOSITIVO
      const dispositivoCompleto = await obtenerDatosDispositivoMejorado();
      const anomaliasDispositivo = await analizarCoherenciaDispositivo({lat, lng}, dispositivoCompleto);

      // VALIDACIONES DE UBICACI√ìN - CASOS CR√çTICOS (van directo al supervisor)
      
      // 4. Fuera de Espa√±a - CR√çTICO
      if (lat < 35 || lat > 45 || lng < -10 || lng > 5) {
        return manejarErrorCritico('FUERA_ESPANA', {
          lat, lng, accuracy, 
          dispositivo: dispositivoCompleto,
          anomalias: anomaliasDispositivo,
          distancia_borde: calcularDistanciaMinimaBordeEspana(lat, lng)
        }, 'Ubicaci√≥n fuera de Espa√±a detectada');
      }
      
      // 5. GPS sospechosamente preciso - CR√çTICO
      if (accuracy < 5) {
        return manejarErrorCritico('GPS_SOSPECHOSO', {
          lat, lng, accuracy,
          dispositivo: dispositivoCompleto,
          anomalias: anomaliasDispositivo
        }, `GPS anormalmente preciso: ${accuracy}m`);
      }
      
      // 6. M√∫ltiples anomal√≠as del dispositivo - CR√çTICO
      if (anomaliasDispositivo.length >= 2) {
        return manejarErrorCritico('DISPOSITIVO_SOSPECHOSO', {
          lat, lng, accuracy,
          dispositivo: dispositivoCompleto,
          anomalias: anomaliasDispositivo
        }, 'Dispositivo con m√∫ltiples patrones sospechosos');
      }

      // CASOS NORMALES - Permiten reintentos hasta l√≠mite
      
      // Incrementar contador unificado
      intentosGPS++;
      ubicacionActual = { lat, lng, accuracy };

      // Crear registro del evento
      const evento = {
        intento: intentosGPS,
        timestamp: new Date().toISOString(),
        lat, lng, accuracy,
        dispositivo: dispositivoCompleto,
        anomalias: anomaliasDispositivo
      };

      // 7. GPS muy impreciso - NORMAL (reintentos)
      if (accuracy > 100) {
        return manejarErrorConReintentos('GPS_IMPRECISO', evento, `GPS poco preciso: ${Math.round(accuracy)}m`);
      }

      // 8. Validaci√≥n de zona asignada - NORMAL (reintentos)
      const validacion = validarUbicacionConZonasSecundarias(lat, lng);
      
      if (!validacion.valido) {
        evento.distancia_zona = validacion.distancia;
        evento.zona_intentada = zonaSeleccionada;
        return manejarErrorConReintentos('FUERA_ZONA', evento, `Fuera de zona ${zonaSeleccionada}: ${validacion.distancia}m`);
      }

      // ‚úÖ √âXITO - Todo validado correctamente
      evento.tipo = 'EXITO';
      evento.zona_final = zonaSeleccionada;
      evento.es_zona_secundaria = zonaSeleccionada !== parametrosURL.zona_principal;
      evento.motivo_zona_secundaria = motivoSeleccionado;
      
      // A√±adir a historial y enviar resultado exitoso
      historialErroresGPS.push(evento);
      
      validacion.device_fingerprint = dispositivoCompleto;
      validacion.gps_accuracy = Math.round(accuracy);
      validacion.horario_turno = parametrosURL.horario_turno;
      validacion.fecha_evento = parametrosURL.fecha_evento;
      validacion.historial_completo = historialErroresGPS;
      
      enviarResultadoCheckIn(lat, lng, accuracy, validacion);
    }

    // ========================================
    // FUNCI√ìN errorGPS MEJORADA
    // ========================================

    function errorGPS(error) {
      // INCREMENTAR contador unificado
      intentosGPS++;
      
      let tipoError = '';
      let mensajeError = '';
      let esCritico = false;
      
      // Clasificar tipo de error t√©cnico
      switch(error.code) {
        case error.PERMISSION_DENIED:
          tipoError = 'PERMISOS_GPS_DENEGADOS';
          mensajeError = 'Permisos de ubicaci√≥n denegados por el usuario';
          esCritico = false; // Puede solucionarse
          break;
          
        case error.POSITION_UNAVAILABLE:
          tipoError = 'GPS_NO_DISPONIBLE';
          mensajeError = 'Servicio GPS no disponible en este dispositivo';
          esCritico = true; // Problema hardware/software grave
          break;
          
        case error.TIMEOUT:
          tipoError = 'TIMEOUT_GPS';
          mensajeError = 'Tiempo agotado obteniendo ubicaci√≥n GPS';
          esCritico = false; // Puede ser temporal
          break;
          
        default:
          tipoError = 'ERROR_GPS_DESCONOCIDO';
          mensajeError = `Error GPS desconocido (c√≥digo: ${error.code})`;
          esCritico = true; // Error no identificado es sospechoso
          break;
      }
      
      // Crear evento del error
      const evento = {
        intento: intentosGPS,
        timestamp: new Date().toISOString(),
        tipo: tipoError,
        detalle: mensajeError,
        codigo_error: error.code,
        mensaje_navegador: error.message,
        nivel_criticidad: esCritico ? 'CRITICO' : 'NORMAL'
      };
      
      console.log(`${esCritico ? 'üö®' : '‚ö†Ô∏è'} Error GPS: ${tipoError} (Intento ${intentosGPS}/${MAX_INTENTOS})`);
      
      // MANEJO SEG√öN CRITICIDAD
      if (esCritico) {
        // Errores cr√≠ticos van directo al supervisor
        historialErroresGPS.push(evento);
        enviarSupervisorInmediato(tipoError, evento);
        bloquearInterfazCritica(mensajeError);
      } else {
        // Errores normales siguen l√≥gica de reintentos
        manejarErrorConReintentos(tipoError, evento, mensajeError);
      }
    }

    // FUNCI√ìN MEJORADA PARA ENVIAR HISTORIAL COMPLETO
    function enviarHistorialCompleto(motivo) {
      const resumen = {
        total_intentos: intentosGPS,
        motivo_envio: motivo,
        tipos_errores: [...new Set(historialErroresGPS.map(h => h.tipo))],
        primer_error: historialErroresGPS[0],
        ultimo_error: historialErroresGPS[historialErroresGPS.length - 1],
        timestamp_inicio: historialErroresGPS[0]?.timestamp,
        timestamp_fin: new Date().toISOString()
      };
      
      const url = webhookManual +
                 `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
                 `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
                 `&zona_intentada=${encodeURIComponent(zonaSeleccionada)}` +
                 `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
                 `&telefono=${encodeURIComponent(parametrosURL.telefono)}` +
                 `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
                 `&motivo_envio=${motivo}` +
                 `&total_intentos=${intentosGPS}` +
                 `&tipos_errores=${encodeURIComponent(resumen.tipos_errores.join(','))}` +
                 `&historial_completo=${encodeURIComponent(JSON.stringify(historialErroresGPS))}` +
                 `&resumen_eventos=${encodeURIComponent(JSON.stringify(resumen))}` +
                 `&timestamp=${Math.floor(Date.now()/1000)}`;
      
      fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Historial completo enviado al supervisor'))
        .catch(() => console.log('‚ùå Error enviando historial al supervisor'));
    }

    // ========================================
    // FUNCIONES ACTUALIZADAS PARA INICIALIZACI√ìN
    // ========================================

    // ACTUALIZAR LA FUNCI√ìN iniciarCheckIn PARA USAR LA NUEVA L√ìGICA
    function iniciarCheckIn() {
        const esZonaSecundaria = zonaSeleccionada !== parametrosURL.zona_principal;
        if (esZonaSecundaria && (!motivoSeleccionado || motivoSeleccionado === '')) {
            mostrarError('Debes seleccionar un motivo para trabajar en zona secundaria');
            return;
        }

        if (!fechaValida || !horarioValido) {
            mostrarError('No tienes acceso v√°lido para hacer check-in en este momento');
            return;
        }

        // VALIDACI√ìN CR√çTICA: Verificar l√≠mite de intentos ANTES de proceder
        if (intentosGPS >= MAX_INTENTOS) {
            bloquearInterfazLimite();
            return;
        }

        // Validar conectividad
        validarConectividad().then(tieneConexion => {
            if (!tieneConexion) {
                mostrarError('Sin conexi√≥n a internet. Verifica tu conectividad.');
                return;
            }

            if (!navigator.geolocation) {
                manejarErrorCritico('GEOLOCATION_NO_SOPORTADO', {}, 'GPS no soportado en este dispositivo');
                return;
            }

            // Mostrar estado de progreso
            mostrarEstado(`Obteniendo ubicaci√≥n GPS para ${zonaSeleccionada}... (Intento ${intentosGPS + 1}/${MAX_INTENTOS})`);

            const button = document.getElementById('gps-button');
            button.innerHTML = `Obteniendo GPS... (${intentosGPS + 1}/${MAX_INTENTOS})`;
            button.disabled = true;
            button.classList.add('loading');

            // Obtener posici√≥n GPS
            navigator.geolocation.getCurrentPosition(
                exitoGPS,  // Usar la nueva funci√≥n exitoGPS mejorada
                errorGPS,  // Usar la nueva funci√≥n errorGPS mejorada
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        });
    }

    // ========================================
    // FUNCIONES ORIGINALES MANTENIDAS
    // ========================================

    async function enviarResultadoCheckIn(lat, lng, accuracy, validacion) {
      const tieneConexion = await validarConectividad();
      if (!tieneConexion) {
        mostrarError('Perdida conexi√≥n antes del env√≠o. Reintenta cuando tengas conexi√≥n.');
        return;
      }

      const webhook = validacion.valido ? webhookExitoso : webhookManual;
      
      const fechaActual = new Date();
      const url = webhook + 
                 `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
                 `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
                 `&zonas_secundarias=${encodeURIComponent(parametrosURL.zonas_secundarias)}` +
                 `&zona_utilizada=${encodeURIComponent(validacion.zona_utilizada)}` +
                 `&es_zona_secundaria=${validacion.es_zona_secundaria}` +
                 `&motivo_cambio=${encodeURIComponent(validacion.motivo_cambio || '')}` +
                 `&turno=${encodeURIComponent(parametrosURL.turno)}` +
                 `&horario_turno=${encodeURIComponent(parametrosURL.horario_turno)}` +
                 `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
                 `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
                 `&lat=${lat}&lng=${lng}&accuracy=${accuracy}` +
                 `&ubicacion_reportada=${encodeURIComponent(validacion.ubicacion_reportada || '')}` +
                 `&ubicacion_verificada=${encodeURIComponent(validacion.ubicacion_verificada || '')}` +
                 `&distancia_zona_metros=${validacion.distancia || 0}` +
                 `&metodo_check_in=${encodeURIComponent(validacion.metodo_checkin || '')}` +
                 `&observaciones_sistema=${encodeURIComponent(validacion.observaciones_sistema || '')}` +
                 `&device_type=${encodeURIComponent(getDeviceType())}` +
                 `&user_agent=${encodeURIComponent(validacion.device_fingerprint?.userAgent || '')}` +
                 `&device_risk_level=${validacion.device_fingerprint?.riskLevel || ''}` +
                 `&hash_validacion=${encodeURIComponent(parametrosURL.hash_validacion)}` +
                 `&validacion_codigo=${validacion.codigo}` +
                 `&fecha_check=${parametrosURL.fecha_evento}` +
                 `&hora_check=${encodeURIComponent(fechaActual.toTimeString().split(' ')[0])}` +
                 `&historial_completo=${encodeURIComponent(JSON.stringify(validacion.historial_completo || []))}` +
                 `&timestamp=${Math.floor(Date.now()/1000)}`;

      if (validacion.valido) {
        mostrarPaginaConfirmacion(validacion);
        setTimeout(() => {
          fetch(url, {method: 'GET'}).catch(() => {});
        }, 1000);
      } else {
        mostrarResultadoError(validacion);
        fetch(url, {method: 'GET'}).catch(() => {});
      }
    }

    function mostrarPaginaConfirmacion(validacion) {
      document.getElementById('checkin-content').style.display = 'none';
      document.getElementById('confirmation-content').style.display = 'block';
      
      const detalles = document.getElementById('confirmation-details');
      const tipoZona = validacion.es_zona_secundaria ? 'secundaria' : 'principal';
      const motivoTexto = validacion.motivo_cambio ? obtenerTextoMotivo(validacion.motivo_cambio) : 'No aplicable';
      
      detalles.innerHTML = `
        <div class="confirmation-item">
          <span class="confirmation-label">T√©cnico:</span>
          <span class="confirmation-value">${parametrosURL.tecnico}</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Fecha:</span>
          <span class="confirmation-value">${parametrosURL.fecha_evento}</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Hora check-in:</span>
          <span class="confirmation-value">${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Zona:</span>
          <span class="confirmation-value">${validacion.zona_utilizada} (${tipoZona})</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Distancia:</span>
          <span class="confirmation-value">${validacion.distancia}m del centro</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Motivo:</span>
          <span class="confirmation-value">${motivoTexto}</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Turno:</span>
          <span class="confirmation-value">${parametrosURL.turno}</span>
        </div>
        <div class="confirmation-item">
          <span class="confirmation-label">Horario:</span>
          <span class="confirmation-value">${parametrosURL.horario_turno}</span>
        </div>
      `;
    }

    function mostrarResultadoError(validacion) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = `
        <div class="error-box">
          ‚ùå <strong>Check-in requiere validaci√≥n manual</strong><br><br>
          üìç <strong>Zona intentada:</strong> ${validacion.zona_utilizada}<br>
          üìè <strong>Distancia:</strong> ${validacion.distancia}m<br>
          ${validacion.motivo_cambio ? `üìù <strong>Motivo:</strong> ${obtenerTextoMotivo(validacion.motivo_cambio)}<br>` : ''}
          üìß Supervisor notificado para validaci√≥n manual
        </div>`;
        
      const gpsButton = document.getElementById('gps-button');
      gpsButton.disabled = true;
      gpsButton.innerHTML = 'SUPERVISOR NOTIFICADO';
      gpsButton.style.background = '#6c757d';
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLon = (lon2 - lon1) * rad;
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * rad) * Math.cos(lat2 * rad) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function getDeviceType() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('mobile') || ua.includes('android') || ua.includes('iphone')) return 'Mobile';
      if (ua.includes('tablet') || ua.includes('ipad')) return 'Tablet';
      return 'Desktop';
    }

    function mostrarEstado(mensaje) {
      document.getElementById('status-message').innerHTML = `<div class='success-box'>${mensaje}</div>`;
    }

    function mostrarError(mensaje) {
      document.getElementById('status-message').innerHTML = `<div class='error-box'>${mensaje}</div>`;
    }

    function contactarSupervisor() {
      const tel = parametrosURL.telefono || '';
      if (tel) {
        if (confirm('üìû ¬øQuieres contactar a tu supervisor?\n\n‚úÖ S√ç: Ser√° notificado para hacer check-in manual\n‚ùå NO: Cancelar')) {
          const infoSolicitud = zonaSeleccionada !== parametrosURL.zona_principal ? 
            `Zona solicitada: ${zonaSeleccionada}. Motivo: ${obtenerTextoMotivo(motivoSeleccionado || 'no especificado')}` :
            `Zona principal: ${parametrosURL.zona_principal}`;
          
          // ENV√çO: Solo cuando el t√©cnico solicita contacto manual
          enviarSolicitudManual(infoSolicitud);
          
          document.getElementById('status-message').innerHTML = `
            <div class="success-box">
              üìß <strong>Supervisor notificado correctamente</strong><br><br>
              üîî Tu supervisor ${parametrosURL.supervisor} ha sido informado<br>
              üìû Te contactar√° en breve para procesar check-in manual<br><br>
              üìã <strong>Informaci√≥n enviada:</strong><br>
              ‚Ä¢ Zona solicitada: ${zonaSeleccionada}<br>
              ${motivoSeleccionado ? `‚Ä¢ Motivo: ${obtenerTextoMotivo(motivoSeleccionado)}<br>` : ''}
              ‚Ä¢ Historial errores GPS: ${historialErroresGPS.length} error(es)<br><br>
              üì± <strong>Llamada directa:</strong><br>
              <a href="tel:${tel}">${tel}</a>
            </div>`;
          
          document.getElementById('gps-button').disabled = true;
          document.getElementById('emergency-button').disabled = true;
          document.getElementById('emergency-button').innerHTML = '‚úÖ ENVIADO';
          document.getElementById('emergency-button').style.background = '#28a745';
        }
      } else {
        mostrarError("‚ùå Tel√©fono del supervisor no disponible.");
      }
    }

    function enviarSolicitudManual(infoSolicitud) {
      const url = webhookManual +
                 `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
                 `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
                 `&zona_solicitada=${encodeURIComponent(zonaSeleccionada)}` +
                 `&motivo_cambio=${encodeURIComponent(motivoSeleccionado || '')}` +
                 `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
                 `&telefono=${encodeURIComponent(parametrosURL.telefono)}` +
                 `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
                 `&error_message=SOLICITUD_CHECKIN_MANUAL` +
                 `&info_solicitud=${encodeURIComponent(infoSolicitud)}` +
                 `&historial_errores=${encodeURIComponent(JSON.stringify(historialErroresGPS))}` +
                 `&device_fingerprint=${encodeURIComponent(JSON.stringify(deviceFingerprint))}` +
                 `&timestamp=${Math.floor(Date.now()/1000)}`;
      
      fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Solicitud manual enviada al supervisor'))
        .catch(() => console.log('‚ùå Error enviando solicitud manual'));
    }

    function cerrarPagina() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar la p√°gina?')) {
        window.close();
        setTimeout(() => {
          window.location.href = 'about:blank';
        }, 500);
      }
    }
  </script>
</body>
</html>
