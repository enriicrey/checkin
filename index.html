<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in GPS T√©cnicos - v2.0</title>
    <style>
        /* ======================================== */
        /* üé® ESTILOS CSS - INTERFAZ USUARIO */
        /* ======================================== */
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header .icon {
            font-size: 50px;
        }
        
        .info-box {
            background: #f1f1f1;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            margin: 8px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-item strong {
            min-width: 80px;
        }
        
        /* Alertas de validaci√≥n */
        .horario-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
        
        .horario-alert h4 {
            margin: 0 0 8px 0;
            color: #f57c00;
        }
        
        .horario-permitido {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .horario-fuera {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .fecha-alert {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }
        
        /* Selectores de zona y motivo */
        .zona-selector {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .motivo-selector {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .zona-selector h4 {
            color: #1e7e34;
            margin: 0 0 10px 0;
        }
        
        .motivo-selector h4 {
            color: #f57c00;
            margin: 0 0 10px 0;
        }
        
        .required {
            color: #dc3545;
            font-weight: bold;
        }
        
        .zone-option, .motivo-option {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .zone-option:hover, .motivo-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .zone-option.selected {
            border-color: #28a745;
            background: #e8f5e8;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        
        .motivo-option.selected {
            border-color: #ff9800;
            background: #fff3e0;
            box-shadow: 0 2px 8px rgba(255,152,0,0.3);
        }
        
        .zone-option .zone-name {
            font-weight: bold;
            color: #1e7e34;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .zone-principal-badge {
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .zone-secondary-badge {
            background: #17a2b8;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Botones y estados */
        .button {
            background: #2ecc71;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .button.loading {
            background: #f39c12;
            animation: pulse 1s infinite;
        }
        
        .button-emergency {
            background: #e74c3c;
        }
        
        .success-box, .error-box, .warning-box {
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .success-box {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .error-box {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .warning-box {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        /* P√°gina de confirmaci√≥n */
        .confirmation-page {
            text-align: center;
            padding: 40px 20px;
        }
        
        .confirmation-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .confirmation-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .confirmation-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .confirmation-item:last-child {
            border-bottom: none;
        }
        
        .confirmation-label {
            font-weight: bold;
            color: #495057;
        }
        
        .confirmation-value {
            color: #28a745;
            font-weight: bold;
        }
        
        .connectivity-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .connectivity-online {
            background: #d4edda;
            color: #155724;
        }
        
        .connectivity-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div id="connectivity-status" class="connectivity-status connectivity-online">Online</div>
    
    <div class="container">
        <div class="header">
            <div class="icon">üìç</div>
            <h1>CHECK-IN T√âCNICOS</h1>
            <p>Sistema de Control de Presencia v2.0</p>
        </div>

        <!-- Informaci√≥n del t√©cnico -->
        <div class="info-box">
            <div class="info-item"><strong>üë§ T√©cnico:</strong> <span id="tecnico-nombre">Cargando...</span></div>
            <div class="info-item"><strong>üéØ Zona Principal:</strong> <span id="zona-principal">Cargando...</span></div>
            <div class="info-item"><strong>üìç Zonas Secundarias:</strong> <span id="zonas-secundarias">Verificando...</span></div>
            <div class="info-item"><strong>üíº Turno de trabajo:</strong> <span id="turno-info">Cargando...</span></div>
            <div class="info-item"><strong>‚è∞ Horario Check-in:</strong> <span id="horario-turno">Cargando...</span></div>
            <div class="info-item"><strong>üïí Hora actual:</strong> <span id="hora-actual">--:--:--</span></div>
        </div>

        <!-- Alertas de validaci√≥n -->
        <div id="fecha-alert" class="fecha-alert" style="display: none;"></div>
        <div id="horario-alert" class="horario-alert" style="display: none;">
            <div id="horario-mensaje">‚è∞ Validando horario de turno...</div>
        </div>

        <!-- Selector de zonas -->
        <div id="zona-selector" class="zona-selector" style="display: none;">
            <h4>üéØ Zona de trabajo para este check-in:</h4>
            <div class="zona-info">Por defecto: Zona principal seg√∫n calendario. Solo puedes seleccionar zonas autorizadas para ti.</div>
            <div id="zona-options"></div>
        </div>

        <!-- Selector de motivos -->
        <div id="motivo-selector" class="motivo-selector">
            <h4>üìù Motivo del trabajo en zona secundaria: <span class="required">*</span></h4>
            <div class="motivo-info">Requerido cuando trabajas fuera de tu zona principal asignada</div>
            
            <div id="motivo-display" class="motivo-option">
                <div class="motivo-placeholder">üëÜ Selecciona un motivo v√°lido</div>
            </div>
            
            <div class="motivo-option" data-motivo="incidencia">üö® Atendiendo incidencia</div>
            <div class="motivo-option" data-motivo="mantenimiento">üîß Mantenimiento programado</div>
            <div class="motivo-option" data-motivo="mantenimiento_urgencia">‚ö° Mantenimiento de urgencia</div>
            <div class="motivo-option" data-motivo="apoyo">ü§ù Apoyo a otro t√©cnico</div>
            <div class="motivo-option" data-motivo="apoyo_interzonal">üîÑ Apoyo interzonal por carga de trabajo</div>
            <div class="motivo-option" data-motivo="ausencia_reemplazo">üë• Ausencia de un compa√±ero reemplazado</div>
            <div class="motivo-option" data-motivo="traslado">üöö Traslado de material/equipo</div>
            <div class="motivo-option" data-motivo="reunion">üíº Reuni√≥n de trabajo</div>
            <div class="motivo-option" data-motivo="supervision">üëî Supervisi√≥n/inspecci√≥n</div>
            <div class="motivo-option" data-motivo="planificacion_especial">üìã Cambio de planificaci√≥n (turno especial)</div>
            <div class="motivo-option" data-motivo="emergencia">üö® Situaci√≥n de emergencia</div>
            <div class="motivo-option" data-motivo="otro">‚ùì Otro motivo</div>
        </div>

        <!-- Estado del sistema -->
        <div id="status-message">
            <div class="warning-box">Validando par√°metros de acceso...</div>
        </div>

        <!-- Contenido principal -->
        <div id="checkin-content">
            <button id="gps-button" class="button" onclick="iniciarCheckIn()" disabled>VALIDANDO ACCESO...</button>
            <button id="emergency-button" class="button button-emergency" onclick="contactarSupervisor()">CONTACTAR SUPERVISOR</button>
        </div>

        <!-- P√°gina de confirmaci√≥n -->
        <div id="confirmation-content" class="confirmation-page" style="display: none;">
            <div class="confirmation-icon">‚úÖ</div>
            <h2>Check-in Completado</h2>
            <p>Tu presencia ha sido registrada exitosamente</p>
            <div id="confirmation-details" class="confirmation-details"></div>
            <div class="success-box">
                <strong>¬øQu√© pasa ahora?</strong><br><br>
                üìä Tus datos se han enviado al sistema<br>
                üìß Tu supervisor ha sido notificado<br>
                üì± Puedes cerrar esta p√°gina<br><br>
                Si tienes alg√∫n problema durante tu turno, contacta a tu supervisor.
            </div>
            <button class="button" onclick="cerrarPagina()">CERRAR</button>
        </div>

        <div class="footer">
            Datos protegidos | GPS activado | Integrado con Notion v2.0
        </div>
    </div>

    <script>
        // ========================================
        // üîß CONFIGURACI√ìN DEL SISTEMA
        // ========================================
        
        // CONSTANTES PRINCIPALES (modificables f√°cilmente)
        const CONFIG = {
            // L√≠mites de reintentos y umbrales
            MAX_INTENTOS: 3,
            UMBRAL_GPS_SOSPECHOSO: 5,           // metros - GPS m√°s preciso = sospechoso
            UMBRAL_GPS_IMPRECISO: 100,          // metros - GPS menos preciso = problem√°tico  
            UMBRAL_SCORE_POTENCIALMENTE_FALSO: 7, // Score ‚â•7 = GPS potencialmente falso
            
            // Distancias geogr√°ficas de referencia
            DISTANCIA_FABRICA_CERCA: 1000,      // metros - cerca de f√°brica
            DISTANCIA_FABRICA_LEJOS: 10000,     // metros - lejos de f√°brica
            DISTANCIA_FABRICA_EXTREMO: 50000,   // metros - muy lejos de f√°brica
            DISTANCIA_IP_GPS_SOSPECHOSA: 100000, // metros - diferencia IP-GPS sospechosa
            
            // Coordenadas de referencia (f√°brica principal)
            FABRICA_LAT: 41.53838,
            FABRICA_LNG: 1.8679,
            
            // URLs de integraci√≥n
            WEBHOOK_EXITOSO: 'https://hook.eu2.make.com/wve7gq8kh6ytw6tq4vfxiepi928n2yk8',
            WEBHOOK_MANUAL: 'https://hook.eu2.make.com/g3vgqvbgbnuxf76v2apdsg1752xhqidr'
        };
        
        // CONFIGURACI√ìN DE ZONAS (coordenadas y radios)
        const ZONAS_CONFIG = {
            "L√≠nea-A": { 
                lat: 41.53838, lng: 1.8679, radio: 450, 
                tipo: "produccion", codigo: "LA", emoji: "üè≠" 
            },
            "L√≠nea-B": { 
                lat: 40.4170, lng: -3.7070, radio: 450, 
                tipo: "produccion", codigo: "LB", emoji: "üè≠" 
            },
            "L√≠nea-C": { 
                lat: 40.4190, lng: -3.7090, radio: 450, 
                tipo: "produccion", codigo: "LC", emoji: "üè≠" 
            },
            "Utilities": { 
                lat: 40.4200, lng: -3.7100, radio: 600, 
                tipo: "utilities", codigo: "UTIL", emoji: "‚ö°" 
            },
            "Laboratorio": { 
                lat: 40.4150, lng: -3.7050, radio: 400, 
                tipo: "laboratorio", codigo: "LAB", emoji: "üî¨" 
            },
            "Mantenimiento": { 
                lat: 40.4180, lng: -3.7080, radio: 700, 
                tipo: "mantenimiento", codigo: "MANT", emoji: "üîß" 
            },
            "Transporte": { 
                lat: 40.4220, lng: -3.7120, radio: 800, 
                tipo: "transporte", codigo: "TRANS", emoji: "üöö" 
            },
            "Almac√©n": { 
                lat: 40.4160, lng: -3.7040, radio: 500, 
                tipo: "almacen", codigo: "ALM", emoji: "üì¶" 
            },
            "Oficinas": { 
                lat: 40.4210, lng: -3.7110, radio: 300, 
                tipo: "oficinas", codigo: "OFIC", emoji: "üè¢" 
            },
            "Todas": { 
                lat: 40.4168, lng: -3.7038, radio: 1000, 
                tipo: "general", codigo: "ALL", emoji: "üåü" 
            }
        };
        
        // PESOS PARA SCORING DE ANOMAL√çAS (modificables para ajustar sensibilidad)
        const PESOS_ANOMALIAS = {
            // CR√çTICAS (peso 3) - Indicadores fuertes de manipulaci√≥n
            'WEBGL_EMULADOR': 3,
            'AUTOMATION_DETECTADA': 3,
            'LEJOS_DE_FABRICA_EXTREMO': 3,
            'IP_GPS_DISTANCIA_SOSPECHOSA': 3,
            
            // ALTAS (peso 2) - Patrones sospechosos pero posibles
            'GPS_DEMASIADO_PRECISO': 2,
            'LEJOS_DE_FABRICA': 2,
            'GPS_TIMEZONE_INCOHERENTE': 2,
            'IP_TIMEZONE_INCOHERENTE': 2,
            
            // MENORES (peso 1) - Indicadores d√©biles
            'RESOLUCION_EMULADOR_TIPICA': 1,
            'MOBILE_SIN_TOUCH': 1,
            'TIMEZONE_GPS_INCOHERENTE': 1,
            'GPS_IMPRECISO_EN_FABRICA': 1
        };
        
        // DICCIONARIO DE MOTIVOS PARA ZONAS SECUNDARIAS
        const MOTIVOS_TEXTO = {
            'incidencia': 'üö® Atendiendo incidencia',
            'mantenimiento': 'üîß Mantenimiento programado',
            'mantenimiento_urgencia': '‚ö° Mantenimiento de urgencia',
            'apoyo': 'ü§ù Apoyo a otro t√©cnico',
            'apoyo_interzonal': 'üîÑ Apoyo interzonal por carga de trabajo',
            'ausencia_reemplazo': 'üë• Ausencia de un compa√±ero reemplazado',
            'traslado': 'üöö Traslado de material/equipo',
            'reunion': 'üíº Reuni√≥n de trabajo',
            'supervision': 'üëî Supervisi√≥n/inspecci√≥n',
            'planificacion_especial': 'üìã Cambio de planificaci√≥n (turno especial)',
            'emergencia': 'üö® Situaci√≥n de emergencia',
            'otro': '‚ùì Otro motivo'
        };
        
        // ========================================
        // üìã VARIABLES GLOBALES DEL SISTEMA
        // ========================================
        
        let parametrosURL = {};
        let intentosGPS = 0; // Contador unificado para todos los errores
        let ubicacionActual = null;
        let zonaSeleccionada = null;
        let motivoSeleccionado = null;
        let zonasSecundariasArray = [];
        let deviceFingerprint = {};
        let conectividadOnline = true;
        let fechaValida = false;
        let horarioValido = false;
        let zonasAutorizadas = [];
        let historialErroresGPS = []; // Historial completo de todos los eventos
        
        // ========================================
        // ‚öôÔ∏è INICIALIZACI√ìN DEL SISTEMA
        // ========================================
        
        window.onload = function() {
            cargarParametros();
            actualizarHora();
            setInterval(actualizarHora, 1000);
            inicializarDeteccionDispositivo();
            inicializarConectividad();
            validarAcceso();
        };
        
        function cargarParametros() {
            const params = new URLSearchParams(window.location.search);
            parametrosURL = {
                tecnico: params.get('t') || '',
                zona_principal: params.get('z') || '',
                zonas_secundarias: params.get('zs') || '',
                turno: params.get('tu') || '',
                supervisor: params.get('s') || '',
                telefono: params.get('tel') || '',
                fecha_evento: params.get('f') || '',
                horario_turno: params.get('h') || '',
                hash_validacion: params.get('hash') || ''
            };
            
            // Procesar zonas autorizadas (principal + secundarias)
            zonasAutorizadas = [];
            if (parametrosURL.zona_principal) {
                zonasAutorizadas.push(parametrosURL.zona_principal);
            }
            if (parametrosURL.zonas_secundarias) {
                zonasSecundariasArray = parametrosURL.zonas_secundarias.split(',').map(z => z.trim());
                zonasAutorizadas.push(...zonasSecundariasArray);
            }
            
            // Actualizar interfaz con datos cargados
            actualizarInterfazConParametros();
            
            // Zona seleccionada por defecto: zona principal
            zonaSeleccionada = parametrosURL.zona_principal;
            motivoSeleccionado = null;
        }
        
        function actualizarInterfazConParametros() {
            document.getElementById('tecnico-nombre').textContent = parametrosURL.tecnico || 'No especificado';
            document.getElementById('zona-principal').textContent = parametrosURL.zona_principal || 'No especificada';
            document.getElementById('zonas-secundarias').textContent = 
                zonasSecundariasArray.length > 0 ? zonasSecundariasArray.join(', ') : 'Ninguna autorizada';
            document.getElementById('turno-info').textContent = parametrosURL.turno || 'No especificado';
            document.getElementById('horario-turno').textContent = parametrosURL.horario_turno || 'No especificado';
        }
        
        function actualizarHora() {
            const ahora = new Date();
            document.getElementById('hora-actual').textContent = ahora.toLocaleTimeString('es-ES', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }
        
        function inicializarDeteccionDispositivo() {
            deviceFingerprint = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                timestamp: Date.now(),
                riskLevel: 'LOW'
            };
        }
        
        function inicializarConectividad() {
            conectividadOnline = navigator.onLine;
            document.getElementById('connectivity-status').textContent = conectividadOnline ? 'Online' : 'Offline';
            document.getElementById('connectivity-status').className = 
                `connectivity-status ${conectividadOnline ? 'connectivity-online' : 'connectivity-offline'}`;
        }
        
        // ========================================
        // üîê SISTEMA DE VALIDACIONES DE ACCESO
        // ========================================
        
        function validarAcceso() {
            console.log('üîç Iniciando validaci√≥n de acceso...');
            
            // 1. Validar par√°metros b√°sicos primero
            if (!validarParametrosBasicos()) return;
            
            // 2. Validar fecha del evento
            if (!validarFechaEvento()) return;
            
            // 3. Validar zonas autorizadas
            if (!validarZonasAutorizadas()) return;
            
            // 4. Validar horario de turno (√∫ltimo para mejor UX)
            if (!validarHorarioTurno()) return;
            
            // 5. Si todo es v√°lido, mostrar interfaz
            mostrarInterfazCheckIn();
        }
        
        function validarParametrosBasicos() {
            if (!parametrosURL.tecnico || !parametrosURL.zona_principal) {
                mostrarError('‚ùå Enlace incompleto. Faltan par√°metros obligatorios.');
                return false;
            }
            return true;
        }
        
        function validarFechaEvento() {
            const hoy = new Date().toISOString().split('T')[0];
            
            // Si no hay fecha, usar hoy por defecto
            if (!parametrosURL.fecha_evento) {
                parametrosURL.fecha_evento = hoy;
                fechaValida = true;
                return true;
            }
            
            // Verificar si la fecha del enlace coincide con hoy
            if (parametrosURL.fecha_evento !== hoy) {
                fechaValida = false;
                document.getElementById('fecha-alert').style.display = 'block';
                document.getElementById('fecha-alert').innerHTML = `
                    <h4>‚ùå Enlace no v√°lido para hoy</h4>
                    <p><strong>Fecha del enlace:</strong> ${parametrosURL.fecha_evento}<br>
                    <strong>Fecha actual:</strong> ${hoy}<br><br>
                    Este enlace corresponde a otro d√≠a. Usa el enlace correcto del calendario de hoy.</p>
                `;
                mostrarError('‚ùå Este enlace no es v√°lido para la fecha de hoy.');
                return false;
            }
            
            fechaValida = true;
            return true;
        }
        
        function validarZonasAutorizadas() {
            const zonasInvalidas = zonasAutorizadas.filter(zona => !ZONAS_CONFIG[zona]);
            
            if (zonasInvalidas.length > 0) {
                mostrarError(`‚ùå Zonas no v√°lidas en configuraci√≥n: ${zonasInvalidas.join(', ')}`);
                return false;
            }
            
            if (zonasAutorizadas.length === 0) {
                mostrarError('‚ùå No tienes zonas autorizadas para check-in.');
                return false;
            }
            
            return true;
        }
        
        function validarHorarioTurno() {
            // Si no hay horario especificado, permitir cualquier hora
            if (!parametrosURL.horario_turno) {
                horarioValido = true;
                document.getElementById('horario-alert').style.display = 'none';
                return true;
            }
            
            const ahora = new Date();
            const horaActual = ahora.getHours() * 60 + ahora.getMinutes();
            
            try {
                const [inicio, fin] = parametrosURL.horario_turno.split('-');
                const [horaInicio, minInicio] = inicio.split(':').map(Number);
                const [horaFin, minFin] = fin.split(':').map(Number);
                const minutosInicio = horaInicio * 60 + minInicio;
                const minutosFin = horaFin * 60 + minFin;
                
                let dentroHorario = false;
                
                // Manejar turnos que cruzan medianoche
                if (minutosInicio <= minutosFin) {
                    dentroHorario = horaActual >= minutosInicio && horaActual <= minutosFin;
                } else {
                    dentroHorario = horaActual >= minutosInicio || horaActual <= minutosFin;
                }
                
                const alertDiv = document.getElementById('horario-alert');
                const mensajeDiv = document.getElementById('horario-mensaje');
                
                if (dentroHorario) {
                    horarioValido = true;
                    alertDiv.className = 'horario-alert horario-permitido';
                    mensajeDiv.innerHTML = `‚úÖ <strong>Horario Check-in v√°lido</strong><br>
                        Ventana check-in: ${parametrosURL.horario_turno} | Hora actual: ${ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}<br>
                        <small>üí° Este es el horario para hacer check-in, antes del inicio de tu turno de trabajo</small>`;
                    return true;
                } else {
                    horarioValido = false;
                    alertDiv.className = 'horario-alert horario-fuera';
                    
                    // Calcular tiempo restante hasta el pr√≥ximo turno
                    let minutosHastaTurno;
                    if (horaActual < minutosInicio) {
                        minutosHastaTurno = minutosInicio - horaActual;
                    } else {
                        minutosHastaTurno = (24 * 60) - horaActual + minutosInicio;
                    }
                    
                    const horasRestantes = Math.floor(minutosHastaTurno / 60);
                    const minRestantes = minutosHastaTurno % 60;
                    
                    mensajeDiv.innerHTML = `‚è∞ <strong>Fuera de horario de check-in</strong><br>
                        Ventana check-in: ${parametrosURL.horario_turno}<br>
                        Tiempo hasta ventana check-in: ${horasRestantes}h ${minRestantes}min<br><br>
                        <small>üí° Solo puedes hacer check-in durante la ventana horaria asignada<br>
                        Si es una emergencia, contacta a tu supervisor.</small>`;
                    
                    mostrarError('‚ùå No puedes hacer check-in fuera de tu horario asignado.');
                    return false;
                }
            } catch (error) {
                horarioValido = false;
                document.getElementById('horario-mensaje').innerHTML = 
                    '‚ùå Error en formato de horario check-in. Contacta al administrador.';
                mostrarError('‚ùå Error en configuraci√≥n de horario check-in.');
                return false;
            }
        }
        
        function mostrarInterfazCheckIn() {
            if (!fechaValida || !horarioValido) {
                return;
            }
            
            // Ocultar alertas de validaci√≥n
            document.getElementById('horario-alert').style.display = 'none';
            document.getElementById('fecha-alert').style.display = 'none';
            
            // Mostrar selectores de zona
            mostrarSelectorZonas();
            configurarSelectores();
            
            // Habilitar bot√≥n principal
            const gpsButton = document.getElementById('gps-button');
            gpsButton.disabled = false;
            gpsButton.innerHTML = 'OBTENER UBICACI√ìN Y CHECK-IN';
            
            mostrarEstado('‚úÖ Acceso validado. Selecciona tu zona de trabajo y procede con el check-in.');
        }
        
        // ========================================
        // üéØ SISTEMA DE SELECCI√ìN DE ZONAS Y MOTIVOS
        // ========================================
        
        function mostrarSelectorZonas() {
            const selector = document.getElementById('zona-selector');
            const options = document.getElementById('zona-options');
            options.innerHTML = '';
            
            zonasAutorizadas.forEach((zona) => {
                const config = ZONAS_CONFIG[zona];
                if (!config) return;
                
                const esPrincipal = zona === parametrosURL.zona_principal;
                const optionDiv = document.createElement('div');
                optionDiv.className = `zone-option ${zonaSeleccionada === zona ? 'selected' : ''}`;
                optionDiv.innerHTML = `
                    <div class="zone-name">
                        ${config.emoji} ${zona}
                        <span class="${esPrincipal ? 'zone-principal-badge' : 'zone-secondary-badge'}">
                            ${esPrincipal ? 'PRINCIPAL' : 'SECUNDARIA'}
                        </span>
                    </div>
                    <div class="zone-distance">
                        üìè Radio: ${config.radio}m | üè∑Ô∏è Tipo: ${config.tipo}
                        ${esPrincipal ? ' - Zona asignada seg√∫n calendario' : ' - Requiere motivo'}
                    </div>
                `;
                
                optionDiv.addEventListener('click', function() {
                    seleccionarZona(zona, esPrincipal);
                });
                
                options.appendChild(optionDiv);
            });
            
            selector.style.display = 'block';
        }
        
        function seleccionarZona(zona, esPrincipal) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.zone-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.motivo-option').forEach(o => o.classList.remove('selected'));
            
            // Seleccionar nueva zona
            event.target.closest('.zone-option').classList.add('selected');
            zonaSeleccionada = zona;
            motivoSeleccionado = null;
            
            // Reset motivo display
            const motivoDisplay = document.getElementById('motivo-display');
            motivoDisplay.innerHTML = '<div class="motivo-placeholder">üëá Selecciona un motivo v√°lido</div>';
            motivoDisplay.classList.remove('selected');
            
            const motivoSelector = document.getElementById('motivo-selector');
            
            if (!esPrincipal) {
                // Zona secundaria - requiere motivo
                motivoSelector.style.display = 'block';
                mostrarEstado('Zona secundaria seleccionada. Debes seleccionar un motivo v√°lido.');
            } else {
                // Zona principal - no requiere motivo
                motivoSelector.style.display = 'none';
                mostrarEstado('Zona principal seleccionada. Puedes proceder con el check-in.');
            }
            
            validarSeleccionCompleta();
        }
        
        function configurarSelectores() {
            document.querySelectorAll('.motivo-option').forEach(option => {
                // Skip el display option
                if (option.id === 'motivo-display') return;
                
                option.addEventListener('click', function() {
                    const motivo = this.dataset.motivo;
                    if (motivo === '') return;
                    
                    // Limpiar selecciones anteriores
                    document.querySelectorAll('.motivo-option').forEach(o => o.classList.remove('selected'));
                    
                    // Seleccionar este motivo
                    this.classList.add('selected');
                    motivoSeleccionado = motivo;
                    
                    // Actualizar el display del motivo seleccionado
                    const motivoDisplay = document.getElementById('motivo-display');
                    motivoDisplay.innerHTML = this.innerHTML;
                    motivoDisplay.classList.add('selected');
                    
                    validarSeleccionCompleta();
                });
            });
        }
        
        function validarSeleccionCompleta() {
            const esZonaSecundaria = zonaSeleccionada !== parametrosURL.zona_principal;
            const tieneMotivo = motivoSeleccionado && motivoSeleccionado !== '';
            
            let puedeCheckIn = false;
            let mensaje = '';
            
            if (!esZonaSecundaria) {
                puedeCheckIn = true;
                mensaje = 'Listo para check-in en zona principal';
            } else if (esZonaSecundaria && tieneMotivo) {
                puedeCheckIn = true;
                mensaje = `Listo para check-in en ${zonaSeleccionada} - Motivo: ${MOTIVOS_TEXTO[motivoSeleccionado]}`;
            } else {
                puedeCheckIn = false;
                mensaje = 'Debes seleccionar un motivo para trabajar en zona secundaria';
            }
            
            const gpsButton = document.getElementById('gps-button');
            gpsButton.disabled = !puedeCheckIn;
            
            if (puedeCheckIn) {
                mostrarEstado(mensaje);
                gpsButton.style.background = '#2ecc71';
                gpsButton.innerHTML = 'OBTENER UBICACI√ìN Y CHECK-IN';
            } else {
                mostrarError(mensaje);
                gpsButton.style.background = '#95a5a6';
                gpsButton.innerHTML = 'COMPLETA SELECCI√ìN';
            }
        }
        
        // ========================================
        // üìç SISTEMA DE CAPTURA Y VALIDACI√ìN GPS
        // ========================================
        
        function iniciarCheckIn() {
            console.log('üöÄ Iniciando proceso de check-in...');
            
            // Validaciones previas
            const esZonaSecundaria = zonaSeleccionada !== parametrosURL.zona_principal;
            if (esZonaSecundaria && (!motivoSeleccionado || motivoSeleccionado === '')) {
                mostrarError('Debes seleccionar un motivo para trabajar en zona secundaria');
                return;
            }
            
            if (!fechaValida || !horarioValido) {
                mostrarError('No tienes acceso v√°lido para hacer check-in en este momento');
                return;
            }
            
            // CR√çTICO: Verificar l√≠mite de intentos ANTES de proceder
            if (intentosGPS >= CONFIG.MAX_INTENTOS) {
                bloquearInterfazLimite();
                return;
            }
            
            // Validar conectividad
            validarConectividad().then(tieneConexion => {
                if (!tieneConexion) {
                    mostrarError('Sin conexi√≥n a internet. Verifica tu conectividad.');
                    return;
                }
                
                if (!navigator.geolocation) {
                    manejarErrorCritico('GEOLOCATION_NO_SOPORTADO', {}, 'GPS no soportado en este dispositivo');
                    return;
                }
                
                // Mostrar estado de progreso
                mostrarEstado(`Obteniendo ubicaci√≥n GPS para ${zonaSeleccionada}... (Intento ${intentosGPS + 1}/${CONFIG.MAX_INTENTOS})`);
                
                const button = document.getElementById('gps-button');
                button.innerHTML = `Obteniendo GPS... (${intentosGPS + 1}/${CONFIG.MAX_INTENTOS})`;
                button.disabled = true;
                button.classList.add('loading');
                
                // Obtener posici√≥n GPS con configuraci√≥n optimizada
                navigator.geolocation.getCurrentPosition(
                    exitoGPS,
                    errorGPS,
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000
                    }
                );
            });
        }
        
        // ========================================
        // ‚úÖ MANEJO DE √âXITO GPS
        // ========================================
        
        async function exitoGPS(position) {
            console.log('üìç GPS obtenido exitosamente');
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const timestamp = position.timestamp || Date.now();
            
            // VALIDACIONES CR√çTICAS B√ÅSICAS
            if (!validarCoordenadasBasicas(lat, lng, accuracy)) return;
            
            // OBTENER DATOS COMPLETOS DEL DISPOSITIVO
            const dispositivoCompleto = await obtenerDatosDispositivoCompleto();
            const anomaliasDispositivo = await analizarCoherenciaDispositivo({lat, lng, accuracy}, dispositivoCompleto);
            
            // VALIDACIONES CR√çTICAS DE UBICACI√ìN (van directo al supervisor)
            if (!validarUbicacionCritica(lat, lng, accuracy, dispositivoCompleto, anomaliasDispositivo)) return;
            
            // INCREMENTAR CONTADOR PARA CASOS NORMALES
            intentosGPS++;
            ubicacionActual = { lat, lng, accuracy };
            
            // Crear registro del evento con todas las anomal√≠as
            const evento = crearEventoGPS(intentosGPS, lat, lng, accuracy, dispositivoCompleto, anomaliasDispositivo);
            
            // VALIDACIONES NORMALES (permiten reintentos)
            if (!validarPrecisionGPS(accuracy, evento)) return;
            if (!validarZonaAsignada(lat, lng, evento)) return;
            
            // ‚úÖ √âXITO - Todo validado correctamente
            await procesarCheckInExitoso(lat, lng, accuracy, evento, dispositivoCompleto);
        }
        
        function validarCoordenadasBasicas(lat, lng, accuracy) {
            // Coordenadas v√°lidas
            if (!lat || !lng || isNaN(lat) || isNaN(lng) || !isFinite(lat) || !isFinite(lng)) {
                manejarErrorCritico('COORDENADAS_INVALIDAS', {lat, lng, accuracy}, 'Coordenadas GPS inv√°lidas detectadas');
                return false;
            }
            
            // Coordenadas nulas (0,0) - Error com√∫n
            if (lat === 0 && lng === 0) {
                manejarErrorCritico('COORDENADAS_NULAS', {lat, lng, accuracy}, 'GPS devolvi√≥ coordenadas nulas');
                return false;
            }
            
            // Coordenadas fuera de rango mundial
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                manejarErrorCritico('COORDENADAS_FUERA_RANGO', {lat, lng, accuracy}, 'Coordenadas fuera del rango terrestre');
                return false;
            }
            
            return true;
        }
        
        function validarUbicacionCritica(lat, lng, accuracy, dispositivo, anomalias) {
            // Fuera de Espa√±a - CR√çTICO
            if (lat < 35 || lat > 45 || lng < -10 || lng > 5) {
                manejarErrorCritico('FUERA_ESPANA', {
                    lat, lng, accuracy, dispositivo, anomalias,
                    distancia_borde: calcularDistanciaMinimaBordeEspana(lat, lng)
                }, 'Ubicaci√≥n fuera de Espa√±a detectada');
                return false;
            }
            
            // GPS sospechosamente preciso - CR√çTICO
            if (accuracy < CONFIG.UMBRAL_GPS_SOSPECHOSO) {
                manejarErrorCritico('GPS_SOSPECHOSO', {
                    lat, lng, accuracy, dispositivo, anomalias
                }, `GPS anormalmente preciso: ${accuracy}m`);
                return false;
            }
            
            // M√∫ltiples anomal√≠as del dispositivo - CR√çTICO
            if (anomalias.length >= 2) {
                manejarErrorCritico('DISPOSITIVO_SOSPECHOSO', {
                    lat, lng, accuracy, dispositivo, anomalias
                }, 'Dispositivo con m√∫ltiples patrones sospechosos');
                return false;
            }
            
            return true;
        }
        
        function validarPrecisionGPS(accuracy, evento) {
            if (accuracy > CONFIG.UMBRAL_GPS_IMPRECISO) {
                manejarErrorConReintentos('GPS_IMPRECISO', evento, `GPS poco preciso: ${Math.round(accuracy)}m`);
                return false;
            }
            return true;
        }
        
        function validarZonaAsignada(lat, lng, evento) {
            const validacion = validarUbicacionConZona(lat, lng);
            
            if (!validacion.valido) {
                evento.distancia_zona = validacion.distancia;
                evento.zona_intentada = zonaSeleccionada;
                manejarErrorConReintentos('FUERA_ZONA', evento, `Fuera de zona ${zonaSeleccionada}: ${validacion.distancia}m`);
                return false;
            }
            
            return true;
        }
        
        async function procesarCheckInExitoso(lat, lng, accuracy, evento, dispositivo) {
            // Marcar como √©xito
            evento.tipo = 'EXITO';
            evento.zona_final = zonaSeleccionada;
            evento.es_zona_secundaria = zonaSeleccionada !== parametrosURL.zona_principal;
            evento.motivo_zona_secundaria = motivoSeleccionado;
            
            // A√±adir a historial
            historialErroresGPS.push(evento);
            
            // Validar ubicaci√≥n final
            const validacion = validarUbicacionConZona(lat, lng);
            
            // Crear resumen para m√©tricas de Notion
            const resumenExitoso = generarResumenExitoso(evento, validacion);
            
            // Preparar datos completos para env√≠o
            validacion.device_fingerprint = dispositivo;
            validacion.gps_accuracy = Math.round(accuracy);
            validacion.horario_turno = parametrosURL.horario_turno;
            validacion.fecha_evento = parametrosURL.fecha_evento;
            validacion.historial_completo = historialErroresGPS;
            validacion.resumen_eventos = resumenExitoso;
            
            // Enviar resultado exitoso
            enviarResultadoCheckIn(lat, lng, accuracy, validacion);
        }
        
        // ========================================
        // ‚ùå MANEJO DE ERRORES GPS
        // ========================================
        
function errorGPS(error) {
    console.log(`‚ö†Ô∏è Error GPS detectado: C√≥digo ${error.code}`);
    
    intentosGPS++;
    
    const { tipoError, mensajeError } = clasificarErrorGPS(error);
    
    // ‚úÖ A√ëADIR zona_intentada a TODOS los eventos de error
    const evento = {
        intento: intentosGPS,
        timestamp: new Date().toISOString(),
        tipo: tipoError,
        detalle: mensajeError,
        codigo_error: error.code,
        mensaje_navegador: error.message,
        nivel_criticidad: 'NORMAL',
        // ‚úÖ NUEVOS CAMPOS CR√çTICOS:
        zona_intentada: zonaSeleccionada,
        es_zona_secundaria: zonaSeleccionada !== parametrosURL.zona_principal,
        motivo_cambio: motivoSeleccionado || null
    };

    console.log(`‚ö†Ô∏è Error GPS: ${tipoError} en zona ${zonaSeleccionada} (Intento ${intentosGPS}/${CONFIG.MAX_INTENTOS})`);
    
    manejarErrorConReintentos(tipoError, evento, mensajeError);
}

        
        function clasificarErrorGPS(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return {
                        tipoError: 'PERMISOS_GPS_DENEGADOS',
                        mensajeError: 'Permisos de ubicaci√≥n denegados por el usuario'
                    };
                case error.POSITION_UNAVAILABLE:
                    return {
                        tipoError: 'GPS_NO_DISPONIBLE',
                        mensajeError: 'Servicio GPS no disponible en este dispositivo'
                    };
                case error.TIMEOUT:
                    return {
                        tipoError: 'TIMEOUT_GPS',
                        mensajeError: 'Tiempo agotado obteniendo ubicaci√≥n GPS'
                    };
                default:
                    return {
                        tipoError: 'ERROR_GPS_DESCONOCIDO',
                        mensajeError: `Error GPS desconocido (c√≥digo: ${error.code})`
                    };
            }
        }
        
        // ========================================
        // üö® MANEJO DE ERRORES CR√çTICOS
        // ========================================
        
        async function manejarErrorCritico(tipo, datos, mensaje) {
            console.log(`üö® Error cr√≠tico detectado: ${tipo}`);
            
            // Calcular score de sospecha (m√≠nimo 8 para cr√≠ticos)
            const coords = { lat: datos.lat, lng: datos.lng, accuracy: datos.accuracy };
            const scoreCritico = calcularScoreSospecha(datos.anomalias || [], coords, null);
            const scoreFinal = Math.max(scoreCritico, 8);
            
            // Registrar en historial con score cr√≠tico
                const evento = {
        intento: intentosGPS + 1,
        timestamp: new Date().toISOString(),
        tipo: tipo,
        detalle: mensaje,
        datos_completos: datos,
        nivel_criticidad: 'CRITICO',
        score_sospecha: scoreFinal,
        gps_potencialmente_falso: true,
        zona_intentada: zonaSeleccionada,
        es_zona_secundaria: zonaSeleccionada !== parametrosURL.zona_principal,
        motivo_cambio: motivoSeleccionado || null
    };
            
            historialErroresGPS.push(evento);
            
            // Enviar inmediatamente al supervisor
            enviarSupervisorInmediato(tipo, evento);
            
            // Bloquear interfaz completamente
            bloquearInterfazCritica(mensaje);
        }
        
function enviarSupervisorInmediato(tipo, evento) {
    const url = CONFIG.WEBHOOK_MANUAL + 
        `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
        `&evento_critico=${tipo}` +
        `&timestamp=${Math.floor(Date.now()/1000)}` + // ‚úÖ CORREGIDO: segundos consistente
        `&coordenadas=${evento.datos_completos?.lat || 'N/A'},${evento.datos_completos?.lng || 'N/A'}` +
        `&accuracy=${evento.datos_completos?.accuracy || 'N/A'}` +
        `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
        `&zona_utilizada=${encodeURIComponent(zonaSeleccionada || 'N/A')}` + // ‚úÖ CORREGIDO
        `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
        `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
        `&horario_turno=${encodeURIComponent(parametrosURL.horario_turno)}` + // ‚úÖ A√ëADIDO
        `&detalle_error=${encodeURIComponent(evento.detalle)}` +
        `&error_message=${encodeURIComponent(evento.detalle)}` + // ‚úÖ A√ëADIDO para consistencia
        `&score_sospecha=${evento.score_sospecha}` +
        `&anomalias_detectadas=${encodeURIComponent(JSON.stringify(evento.datos_completos?.anomalias || []))}` +
        `&datos_dispositivo=${encodeURIComponent(JSON.stringify(evento.datos_completos?.dispositivo || {}))}` +
        `&historial_completo=${encodeURIComponent(JSON.stringify(historialErroresGPS))}` + // ‚úÖ A√ëADIDO
        `&metodo_check_in=Supervisor`; // ‚úÖ A√ëADIDO

    fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Supervisor notificado inmediatamente'))
        .catch(() => console.log('‚ùå Error notificando supervisor'));
}
        
        function bloquearInterfazCritica(mensaje) {
            document.getElementById('status-message').innerHTML = `
                <div class="error-box">
                    üö® <strong>Error cr√≠tico detectado</strong><br><br>
                    ${mensaje}<br><br>
                    üìß <strong>Supervisor notificado autom√°ticamente</strong><br>
                    üîî Te contactar√° para revisar la situaci√≥n<br><br>
                    üìû <strong>Contacto directo:</strong><br>
                    <a href="tel:${parametrosURL.telefono}" style="font-size: 16px; font-weight: bold;">${parametrosURL.telefono}</a><br><br>
                    ‚ö†Ô∏è <strong>Este tipo de error requiere validaci√≥n manual inmediata</strong>
                </div>`;
                
            // Deshabilitar todos los botones permanentemente
            const gpsButton = document.getElementById('gps-button');
            gpsButton.disabled = true;
            gpsButton.innerHTML = 'üö® ERROR CR√çTICO DETECTADO';
            gpsButton.style.background = '#dc3545';
            gpsButton.style.opacity = '0.7';
            gpsButton.classList.remove('loading');
            
            const emergencyButton = document.getElementById('emergency-button');
            emergencyButton.disabled = true;
            emergencyButton.innerHTML = 'üìß SUPERVISOR NOTIFICADO';
            emergencyButton.style.background = '#6c757d';
            emergencyButton.style.opacity = '0.7';
        }
        
        // ========================================
        // ‚ö†Ô∏è MANEJO DE ERRORES CON REINTENTOS
        // ========================================
        
        function manejarErrorConReintentos(tipo, evento, mensaje) {
            console.log(`‚ö†Ô∏è Error normal detectado: ${tipo} (Intento ${intentosGPS}/${CONFIG.MAX_INTENTOS})`);
            
            // A√±adir detalles al evento
            evento.tipo = tipo;
            evento.detalle = mensaje;
            evento.nivel_criticidad = 'NORMAL';
            
            // Registrar en historial
            historialErroresGPS.push(evento);
            
            // Verificar si se alcanz√≥ el l√≠mite
            if (intentosGPS >= CONFIG.MAX_INTENTOS) {
                enviarHistorialCompleto('LIMITE_ALCANZADO');
                bloquearInterfazLimite();
            } else {
                // Permitir reintento - mostrar error persistente
                mostrarErrorConOpcionReintento(mensaje, tipo);
                resetearBotonParaReintento();
            }
        }
        
        function mostrarErrorConOpcionReintento(mensaje, tipo) {
            const sugerencias = {
                'GPS_IMPRECISO': 'Sal al exterior o busca zona con mejor cobertura GPS',
                'FUERA_ZONA': 'Despl√°zate hacia el centro de tu zona asignada',
                'ERROR_TECNICO_GPS': 'Verifica permisos de ubicaci√≥n en el navegador',
                'PERMISOS_GPS_DENEGADOS': 'Habilita permisos de ubicaci√≥n en tu navegador',
                'TIMEOUT_GPS': 'Busca zona con mejor cobertura GPS y reintenta'
            };
            
            // Mensaje persistente que se mantiene visible
            document.getElementById('status-message').innerHTML = `
                <div class="warning-box" id="mensaje-persistente">
                    ‚ö†Ô∏è <strong>${mensaje}</strong><br><br>
                    üîÑ <strong>Intento ${intentosGPS} de ${CONFIG.MAX_INTENTOS} completado</strong><br>
                    üìä <em>Evento registrado para auditor√≠a</em><br><br>
                    üí° <strong>Sugerencia:</strong> ${sugerencias[tipo] || 'Reintenta tras verificar las condiciones'}<br><br>
                    üîÑ <strong>Puedes hacer ${CONFIG.MAX_INTENTOS - intentosGPS} intento(s) m√°s</strong><br>
                    üìû <strong>Si necesitas ayuda:</strong> Contacta a tu supervisor
                </div>`;
        }
        
        function resetearBotonParaReintento() {
            if (intentosGPS < CONFIG.MAX_INTENTOS) {
                const button = document.getElementById('gps-button');
                button.innerHTML = `REINTENTO ${intentosGPS + 1}/${CONFIG.MAX_INTENTOS} - OBTENER UBICACI√ìN`;
                button.disabled = false;
                button.classList.remove('loading');
                button.style.background = '#f39c12'; // Color naranja para reintentos
            }
        }
        
        function bloquearInterfazLimite() {
            document.getElementById('status-message').innerHTML = `
                <div class="error-box">
                    ‚ùå <strong>M√°ximo de intentos alcanzado (${CONFIG.MAX_INTENTOS})</strong><br><br>
                    üìß <strong>Historial completo enviado al supervisor</strong><br>
                    üîî Te contactar√° para procesar check-in manual<br><br>
                    üìû <strong>Contacta directamente:</strong><br>
                    <a href="tel:${parametrosURL.telefono}" style="font-size: 16px; font-weight: bold;">${parametrosURL.telefono}</a><br><br>
                    üí° <strong>Posibles soluciones:</strong><br>
                    ‚Ä¢ Verificar permisos de ubicaci√≥n<br>
                    ‚Ä¢ Salir al exterior para mejor se√±al GPS<br>
                    ‚Ä¢ Reiniciar navegador si persiste
                </div>`;
                
            // Deshabilitar botones
            const gpsButton = document.getElementById('gps-button');
            gpsButton.disabled = true;
            gpsButton.innerHTML = '‚ùå M√ÅXIMO INTENTOS ALCANZADO';
            gpsButton.style.background = '#dc3545';
            gpsButton.style.opacity = '0.7';
            gpsButton.classList.remove('loading');
            
            const emergencyButton = document.getElementById('emergency-button');
            emergencyButton.disabled = true;
            emergencyButton.innerHTML = 'üìß SUPERVISOR NOTIFICADO';
            emergencyButton.style.background = '#6c757d';
            emergencyButton.style.opacity = '0.7';
        }
        
        // ========================================
        // üîç SISTEMA DE DETECCI√ìN DE ANOMAL√çAS
        // ========================================
        
        async function obtenerDatosDispositivoCompleto() {
            const dispositivo = {
                // Datos b√°sicos del navegador
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                
                // Datos de red y ubicaci√≥n
                ip_publica: await obtenerIPPublica().catch(() => 'no_disponible'),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezone_offset: new Date().getTimezoneOffset(),
                
                // Capacidades del dispositivo
                screen_resolution: `${screen.width}x${screen.height}`,
                color_depth: screen.colorDepth,
                pixel_ratio: window.devicePixelRatio,
                
                // Detecci√≥n de entorno
                touch_support: 'ontouchstart' in window,
                webgl_info: obtenerWebGLInfo(),
                
                // Detecci√≥n anti-bot
                webdriver: navigator.webdriver || false,
                automation_indicators: detectarAutomation(),
                
                // Metadatos
                timestamp_dispositivo: Date.now(),
                connection_type: navigator.connection?.effectiveType || 'unknown'
            };
            
            return dispositivo;
        }
        
        async function obtenerIPPublica() {
            try {
                const response = await fetch('https://api.ipify.org?format=json', { timeout: 5000 });
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('No se pudo obtener IP p√∫blica:', error);
                return 'no_disponible';
            }
        }
        
        function obtenerWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'no_disponible';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown',
                    renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown'
                };
            } catch (error) {
                return 'error';
            }
        }
        
        function detectarAutomation() {
            const indicadores = [];
            
            // Selenium
            if (window.navigator.webdriver) {
                indicadores.push('SELENIUM_WEBDRIVER');
            }
            
            // Phantom JS
            if (window.callPhantom || window._phantom) {
                indicadores.push('PHANTOM_JS');
            }
            
            // Headless Chrome
            if (navigator.userAgent.includes('HeadlessChrome')) {
                indicadores.push('HEADLESS_CHROME');
            }
            
            // Propiedades an√≥malas
            if (navigator.plugins.length === 0 && !navigator.userAgent.includes('Mobile')) {
                indicadores.push('SIN_PLUGINS_DESKTOP');
            }
            
            return indicadores;
        }
        
        async function analizarCoherenciaDispositivo(coords, dispositivo) {
            const anomalias = [];
            
            // ===== ANOMAL√çAS T√âCNICAS DE DISPOSITIVO =====
            
            // Timezone vs GPS (solo si no es cr√≠tico)
            if (dispositivo.timezone && !dispositivo.timezone.includes('Europe') && 
                coords.lat > 35 && coords.lat < 45 && coords.lng > -10 && coords.lng < 5) {
                anomalias.push('TIMEZONE_GPS_INCOHERENTE');
            }
            
            // Indicadores de automation
            if (dispositivo.automation_indicators.length > 0) {
                anomalias.push('AUTOMATION_DETECTADA');
            }
            
            // WebGL sospechoso
            if (dispositivo.webgl_info.renderer && 
                (dispositivo.webgl_info.renderer.includes('SwiftShader') || 
                 dispositivo.webgl_info.renderer.includes('VMware'))) {
                anomalias.push('WEBGL_EMULADOR');
            }
            
            // Resoluci√≥n t√≠pica de emulador
            if (dispositivo.screen_resolution === '393x851' ||  // Android emulator
                dispositivo.screen_resolution === '375x667' ||  // iPhone emulator
                (dispositivo.screen_resolution === '1920x1080' && dispositivo.pixel_ratio === 1)) {
                anomalias.push('RESOLUCION_EMULADOR_TIPICA');
            }
            
            // User Agent vs capacidades
            if (navigator.userAgent.includes('Mobile') && !dispositivo.touch_support) {
                anomalias.push('MOBILE_SIN_TOUCH');
            }
            
            // ===== ANOMAL√çAS GEOGR√ÅFICAS =====
            
            // GPS demasiado preciso
            if (coords.accuracy < 3) {
                anomalias.push('GPS_DEMASIADO_PRECISO');
            }
            
            // Distancia a f√°brica
            const distanciaFabrica = calcularDistancia(coords.lat, coords.lng, CONFIG.FABRICA_LAT, CONFIG.FABRICA_LNG);
            if (distanciaFabrica > CONFIG.DISTANCIA_FABRICA_EXTREMO) {
                anomalias.push('LEJOS_DE_FABRICA_EXTREMO');
            } else if (distanciaFabrica > CONFIG.DISTANCIA_FABRICA_LEJOS) {
                anomalias.push('LEJOS_DE_FABRICA');
            }
            
            // GPS impreciso en f√°brica
            if (coords.accuracy > CONFIG.UMBRAL_GPS_IMPRECISO && distanciaFabrica < CONFIG.DISTANCIA_FABRICA_CERCA) {
                anomalias.push('GPS_IMPRECISO_EN_FABRICA');
            }
            
            // ===== ANOMAL√çAS DE COHERENCIA IP/GPS/TIMEZONE =====
            
            // Coherencia IP vs GPS
            if (dispositivo.ip_publica && dispositivo.ip_publica !== 'no_disponible') {
                try {
                    const distanciaIPGPS = await calcularDistanciaIPvsGPS(dispositivo.ip_publica, coords);
                    if (distanciaIPGPS > CONFIG.DISTANCIA_IP_GPS_SOSPECHOSA) {
                        anomalias.push('IP_GPS_DISTANCIA_SOSPECHOSA');
                    }
                } catch (error) {
                    console.log('No se pudo verificar coherencia IP-GPS:', error);
                }
            }
            
            // GPS vs Timezone incoherente
            if (dispositivo.timezone) {
                const esTimezoneEspanol = dispositivo.timezone.includes('Madrid') || dispositivo.timezone.includes('Europe/Madrid');
                const esGPSEspanol = coords.lat > 35 && coords.lat < 45 && coords.lng > -10 && coords.lng < 5;
                
                if (esGPSEspanol && !esTimezoneEspanol) {
                    anomalias.push('GPS_TIMEZONE_INCOHERENTE');
                }
            }
            
            // IP vs Timezone incoherente
            if (dispositivo.ip_publica && dispositivo.ip_publica !== 'no_disponible' && dispositivo.timezone) {
                try {
                    const paisIP = await obtenerPaisDeIP(dispositivo.ip_publica);
                    const esTimezoneEspanol = dispositivo.timezone.includes('Madrid') || dispositivo.timezone.includes('Europe/Madrid');
                    
                    if ((paisIP === 'ES' && !esTimezoneEspanol) || (paisIP !== 'ES' && esTimezoneEspanol)) {
                        anomalias.push('IP_TIMEZONE_INCOHERENTE');
                    }
                } catch (error) {
                    console.log('No se pudo verificar coherencia IP-Timezone:', error);
                }
            }
            
            return anomalias;
        }
        
        // ========================================
        // üìä SISTEMA DE SCORING Y M√âTRICAS
        // ========================================
        
        function calcularScoreSospecha(anomalias, coords, validacion) {
            let score = 0;
            
            // Sumar pesos seg√∫n anomal√≠as detectadas
            anomalias.forEach(anomalia => {
                score += PESOS_ANOMALIAS[anomalia] || 0;
            });
            
            // Factores adicionales de ubicaci√≥n
            if (validacion && validacion.distancia > 1000) score += 1;
            if (coords.accuracy < 5 && validacion?.distancia < 10) score += 1;
            
            return Math.min(score, 10); // M√°ximo 10
        }
        
        function generarResumenExitoso(evento, validacion) {
            return {
                total_intentos: intentosGPS,
                motivo_envio: 'CHECK_IN_EXITOSO',
                tipos_errores: historialErroresGPS.filter(h => h.tipo !== 'EXITO').map(h => h.tipo),
                resultado_final: 'EXITOSO',
                timestamp_inicio: historialErroresGPS[0]?.timestamp,
                timestamp_fin: evento.timestamp,
                
                // KPIs calculados para Notion
                duracion_total_segundos: Math.floor((new Date(evento.timestamp) - new Date(historialErroresGPS[0]?.timestamp)) / 1000),
                distancia_promedio: Math.round(
                    historialErroresGPS.filter(h => h.distancia_zona)
                        .reduce((acc, h) => acc + h.distancia_zona, 0) / 
                    historialErroresGPS.filter(h => h.distancia_zona).length
                ) || validacion.distancia || 0,
                accuracy_promedio: Math.round(
                    historialErroresGPS.reduce((acc, h) => acc + (h.accuracy || 0), 0) / historialErroresGPS.length
                ),
                
                // KPIs categorizados para Notion
                eficiencia_gps: Math.round((1 / intentosGPS) * 100) / 100,
                categoria_distancia: categorizarDistancia(validacion.distancia || 0),
                precision_gps_categoria: categorizarPrecision(Math.round(
                    historialErroresGPS.reduce((acc, h) => acc + (h.accuracy || 0), 0) / historialErroresGPS.length
                )),
                dispositivo_estable: historialErroresGPS.every(h => 
                    h.dispositivo?.ip_publica === historialErroresGPS[0]?.dispositivo?.ip_publica
                ),
                
                // Campos de seguridad
                ip_dispositivo: evento.dispositivo?.ip_publica || 'no_disponible',
                timezone_dispositivo: evento.dispositivo?.timezone || 'unknown',
                fingerprint_dispositivo: generarHashDispositivo(evento.dispositivo || {}),
                anomalias_detectadas: evento.anomalias || [],
                score_sospecha: calcularScoreSospecha(evento.anomalias || [], 
                    {lat: evento.lat, lng: evento.lng, accuracy: evento.accuracy}, validacion),
                distancia_fabrica_metros: Math.round(calcularDistancia(
                    evento.lat, evento.lng, CONFIG.FABRICA_LAT, CONFIG.FABRICA_LNG
                )),
                
                // Contexto final
                zona_final: zonaSeleccionada,
                es_zona_secundaria: zonaSeleccionada !== parametrosURL.zona_principal,
                plataforma_dispositivo: evento.dispositivo?.platform || 'unknown'
            };
        }
        
  function enviarHistorialCompleto(motivo) {
    const resumen = {
        total_intentos: intentosGPS,
        motivo_envio: motivo,
        tipos_errores: [...new Set(historialErroresGPS.map(h => h.tipo))],
        resultado_final: 'FALLIDO',
        timestamp_inicio: historialErroresGPS[0]?.timestamp,
        timestamp_fin: new Date().toISOString(),
        duracion_total_segundos: Math.floor((Date.now() - new Date(historialErroresGPS[0]?.timestamp)) / 1000),
        distancia_promedio: Math.round(
            historialErroresGPS.filter(h => h.distancia_zona)
                .reduce((acc, h) => acc + h.distancia_zona, 0) / 
            historialErroresGPS.filter(h => h.distancia_zona).length
        ) || 0,
        accuracy_promedio: Math.round(
            historialErroresGPS.reduce((acc, h) => acc + (h.accuracy || 0), 0) / historialErroresGPS.length
        ),
        eficiencia_gps: Math.round((1 / intentosGPS) * 100) / 100,
        dispositivo_estable: historialErroresGPS.every(h => h.dispositivo?.ip_publica === historialErroresGPS[0]?.dispositivo?.ip_publica),
        plataforma_dispositivo: historialErroresGPS[0]?.dispositivo?.platform || 'unknown'
    };
            
    const url = CONFIG.WEBHOOK_MANUAL + 
        `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
        `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
        `&zona_utilizada=${encodeURIComponent(zonaSeleccionada)}` + // ‚úÖ CORREGIDO
        `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
        `&telefono=${encodeURIComponent(parametrosURL.telefono)}` +
        `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
        `&horario_turno=${encodeURIComponent(parametrosURL.horario_turno)}` + // ‚úÖ A√ëADIDO
        `&motivo_envio=${motivo}` +
        `&total_intentos=${intentosGPS}` +
        `&tipos_errores=${encodeURIComponent(resumen.tipos_errores.join(','))}` +
        `&historial_completo=${encodeURIComponent(JSON.stringify(historialErroresGPS))}` +
        `&datos_dispositivo=${encodeURIComponent(JSON.stringify(historialErroresGPS[0]?.dispositivo || {}))}` + // ‚úÖ A√ëADIDO
        `&metodo_check_in=Supervisor` + // ‚úÖ A√ëADIDO
        `&resumen_eventos=${encodeURIComponent(JSON.stringify(resumen))}` +
        `&timestamp=${Math.floor(Date.now()/1000)}`;

    fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Historial completo enviado al supervisor'))
        .catch(() => console.log('‚ùå Error enviando historial al supervisor'));
}
        
        // ========================================
        // üìç VALIDACI√ìN DE UBICACI√ìN Y ZONAS
        // ========================================
        
        function validarUbicacionConZona(lat, lng) {
            const zona = ZONAS_CONFIG[zonaSeleccionada];
            if (!zona) {
                return {
                    valido: false,
                    codigo: "ZONA_NO_CONFIGURADA",
                    mensaje: `Zona "${zonaSeleccionada}" no configurada`,
                    zona_utilizada: zonaSeleccionada,
                    es_zona_secundaria: false
                };
            }
            
            const distancia = calcularDistancia(lat, lng, zona.lat, zona.lng);
            const esZonaSecundaria = zonasSecundariasArray.includes(zonaSeleccionada);
            const ubicacionReportada = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            
if (distancia <= zona.radio) {
    return {
        valido: true,
        codigo: "UBICACION_VALIDA",
        mensaje: `Check-in exitoso en ${zonaSeleccionada}`,
        distancia: Math.round(distancia),
        zona_utilizada: zonaSeleccionada,
        es_zona_secundaria: esZonaSecundaria,
        motivo_cambio: motivoSeleccionado,
        metodo_check_in: "GPS", // ‚úÖ CORREGIDO: metodo_checkin ‚Üí metodo_check_in
        ubicacion_reportada: ubicacionReportada,
        ubicacion_verificada: "V√°lida",
        observaciones_sistema: `GPS: ${Math.round(distancia)}m del centro de ${zonaSeleccionada}${esZonaSecundaria ? ' (zona secundaria)' : ''}`
    };
}
            
return {
    valido: false,
    codigo: "ZONA_LEJANA",
    mensaje: `Alejado de ${zonaSeleccionada}`,
    distancia: Math.round(distancia),
    zona_utilizada: zonaSeleccionada,
    es_zona_secundaria: esZonaSecundaria,
    motivo_cambio: motivoSeleccionado,
    metodo_check_in: "Supervisor", // ‚úÖ CORREGIDO: metodo_checkin ‚Üí metodo_check_in
    ubicacion_reportada: ubicacionReportada,
    ubicacion_verificada: "No V√°lida"
};
        }
        
        // ========================================
        // üì§ SISTEMA DE ENV√çO DE RESULTADOS
        // ========================================
        
        async function enviarResultadoCheckIn(lat, lng, accuracy, validacion) {
            console.log('üöÄ Iniciando env√≠o de resultado check-in...');
            
            const tieneConexion = await validarConectividad();
            if (!tieneConexion) {
                mostrarError('Perdida conexi√≥n antes del env√≠o. Reintenta cuando tengas conexi√≥n.');
                return;
            }
            
            const webhook = validacion.valido ? CONFIG.WEBHOOK_EXITOSO : CONFIG.WEBHOOK_MANUAL;
            const fechaActual = new Date();
            
            const url = construirURLWebhook(webhook, lat, lng, accuracy, validacion, fechaActual);
            
            try {
                if (validacion.valido) {
                    console.log('‚úÖ Enviando resultado EXITOSO...');
                    mostrarPaginaConfirmacion(validacion);
                    
                    const response = await fetch(url, {method: 'GET'});
                    if (!response.ok) {
                        console.error('‚ùå Error en webhook exitoso:', response.status);
                        mostrarAdvertenciaEnvio();
                    } else {
                        console.log('‚úÖ Webhook exitoso enviado correctamente');
                    }
                } else {
                    console.log('‚ùå Enviando resultado para VALIDACI√ìN MANUAL...');
                    mostrarResultadoError(validacion);
                    
                    const response = await fetch(url, {method: 'GET'});
                    if (!response.ok) {
                        console.error('‚ùå Error en webhook manual:', response.status);
                    } else {
                        console.log('‚úÖ Webhook manual enviado correctamente');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error cr√≠tico enviando webhook:', error);
                mostrarErrorEnvio(error);
            }
        }
        
 function construirURLWebhook(webhook, lat, lng, accuracy, validacion, fechaActual) {
    return webhook + 
        `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
        `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
        `&zonas_secundarias=${encodeURIComponent(parametrosURL.zonas_secundarias)}` +
        `&zona_utilizada=${encodeURIComponent(validacion.zona_utilizada)}` +
        `&es_zona_secundaria=${validacion.es_zona_secundaria}` +
        `&motivo_cambio=${encodeURIComponent(validacion.motivo_cambio || '')}` +
        `&turno=${encodeURIComponent(parametrosURL.turno)}` +
        `&horario_turno=${encodeURIComponent(parametrosURL.horario_turno)}` +
        `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
        `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
        `&lat=${lat}&lng=${lng}&accuracy=${accuracy}` +
        `&ubicacion_reportada=${encodeURIComponent(validacion.ubicacion_reportada || '')}` +
        `&ubicacion_verificada=${encodeURIComponent(validacion.ubicacion_verificada || '')}` +
        `&distancia_zona_metros=${validacion.distancia || 0}` +
        `&metodo_check_in=${encodeURIComponent(validacion.metodo_check_in || 'GPS')}` + // ‚úÖ CORREGIDO
        `&observaciones_sistema=${encodeURIComponent(validacion.observaciones_sistema || '')}` +
        `&hash_validacion=${encodeURIComponent(parametrosURL.hash_validacion)}` +
        `&validacion_codigo=${validacion.codigo}` +
        `&historial_completo=${encodeURIComponent(JSON.stringify(validacion.historial_completo || []))}` +
        `&datos_dispositivo=${encodeURIComponent(JSON.stringify(validacion.device_fingerprint || {}))}` + // ‚úÖ A√ëADIDO
        `&resumen_eventos=${encodeURIComponent(JSON.stringify(validacion.resumen_eventos || {}))}` +
        `&timestamp=${Math.floor(Date.now()/1000)}`;
}

        
        // ========================================
        // üé® FUNCIONES DE INTERFAZ USUARIO
        // ========================================
        
        function mostrarPaginaConfirmacion(validacion) {
            document.getElementById('checkin-content').style.display = 'none';
            document.getElementById('confirmation-content').style.display = 'block';
            
            const detalles = document.getElementById('confirmation-details');
            const tipoZona = validacion.es_zona_secundaria ? 'secundaria' : 'principal';
            const motivoTexto = validacion.motivo_cambio ? MOTIVOS_TEXTO[validacion.motivo_cambio] : 'No aplicable';
            
            detalles.innerHTML = `
                <div class="confirmation-item">
                    <span class="confirmation-label">T√©cnico:</span>
                    <span class="confirmation-value">${parametrosURL.tecnico}</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Fecha:</span>
                    <span class="confirmation-value">${parametrosURL.fecha_evento}</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Hora check-in:</span>
                    <span class="confirmation-value">${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Zona:</span>
                    <span class="confirmation-value">${validacion.zona_utilizada} (${tipoZona})</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Distancia:</span>
                    <span class="confirmation-value">${validacion.distancia}m del centro</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Motivo:</span>
                    <span class="confirmation-value">${motivoTexto}</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Turno:</span>
                    <span class="confirmation-value">${parametrosURL.turno}</span>
                </div>
                <div class="confirmation-item">
                    <span class="confirmation-label">Horario:</span>
                    <span class="confirmation-value">${parametrosURL.horario_turno}</span>
                </div>
            `;
        }
        
        function mostrarResultadoError(validacion) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `
                <div class="error-box">
                    ‚ùå <strong>Check-in requiere validaci√≥n manual</strong><br><br>
                    üìç <strong>Zona intentada:</strong> ${validacion.zona_utilizada}<br>
                    üìè <strong>Distancia:</strong> ${validacion.distancia}m<br>
                    ${validacion.motivo_cambio ? `üìù <strong>Motivo:</strong> ${MOTIVOS_TEXTO[validacion.motivo_cambio]}<br>` : ''}
                    üìß Supervisor notificado para validaci√≥n manual
                </div>`;
                
            const gpsButton = document.getElementById('gps-button');
            gpsButton.disabled = true;
            gpsButton.innerHTML = 'SUPERVISOR NOTIFICADO';
            gpsButton.style.background = '#6c757d';
        }
        
        function mostrarAdvertenciaEnvio() {
            document.getElementById('status-message').innerHTML = `
                <div class="warning-box">
                    ‚ö†Ô∏è Check-in procesado localmente pero error enviando a servidor<br>
                    üìû Contacta a tu supervisor si necesitas confirmaci√≥n
                </div>`;
        }
        
        function mostrarErrorEnvio(error) {
            document.getElementById('status-message').innerHTML = `
                <div class="error-box">
                    üö® <strong>Error enviando datos al servidor</strong><br><br>
                    üìù Tu check-in ha sido procesado localmente<br>
                    üìû <strong>IMPORTANTE:</strong> Contacta inmediatamente a tu supervisor<br>
                    üìß Email: ${parametrosURL.supervisor}<br>
                    üì± Tel√©fono: ${parametrosURL.telefono}<br><br>
                    üîç <strong>Error t√©cnico:</strong> ${error.message}
                </div>`;
        }
        
        function mostrarEstado(mensaje) {
            document.getElementById('status-message').innerHTML = `<div class='success-box'>${mensaje}</div>`;
        }
        
        function mostrarError(mensaje) {
            document.getElementById('status-message').innerHTML = `<div class='error-box'>${mensaje}</div>`;
        }
        
        // ========================================
        // üìû CONTACTO CON SUPERVISOR
        // ========================================
        
        function contactarSupervisor() {
            const tel = parametrosURL.telefono || '';
            if (tel) {
                if (confirm('üìû ¬øQuieres contactar a tu supervisor?\n\n‚úÖ S√ç: Ser√° notificado para hacer check-in manual\n‚ùå NO: Cancelar')) {
                    const infoSolicitud = zonaSeleccionada !== parametrosURL.zona_principal ? 
                        `Zona solicitada: ${zonaSeleccionada}. Motivo: ${MOTIVOS_TEXTO[motivoSeleccionado] || 'no especificado'}` :
                        `Zona principal: ${parametrosURL.zona_principal}`;
                    
                    enviarSolicitudManual(infoSolicitud);
                    mostrarConfirmacionContacto(infoSolicitud, tel);
                }
            } else {
                mostrarError("‚ùå Tel√©fono del supervisor no disponible.");
            }
        }
        
function enviarSolicitudManual(infoSolicitud) {
    const url = CONFIG.WEBHOOK_MANUAL + 
        `?tecnico=${encodeURIComponent(parametrosURL.tecnico)}` +
        `&zona_principal=${encodeURIComponent(parametrosURL.zona_principal)}` +
        `&zona_utilizada=${encodeURIComponent(zonaSeleccionada)}` + // ‚úÖ CORREGIDO
        `&es_zona_secundaria=${zonaSeleccionada !== parametrosURL.zona_principal}` + // ‚úÖ A√ëADIDO
        `&motivo_cambio=${encodeURIComponent(motivoSeleccionado || '')}` +
        `&supervisor=${encodeURIComponent(parametrosURL.supervisor)}` +
        `&telefono=${encodeURIComponent(parametrosURL.telefono)}` +
        `&fecha_evento=${encodeURIComponent(parametrosURL.fecha_evento)}` +
        `&horario_turno=${encodeURIComponent(parametrosURL.horario_turno)}` + // ‚úÖ A√ëADIDO
        `&hash_validacion=${encodeURIComponent(parametrosURL.hash_validacion)}` + // ‚úÖ A√ëADIDO
        `&error_message=SOLICITUD_CHECKIN_MANUAL` +
        `&info_solicitud=${encodeURIComponent(infoSolicitud)}` +
        `&historial_completo=${encodeURIComponent(JSON.stringify(historialErroresGPS))}` + // ‚úÖ CORREGIDO
        `&datos_dispositivo=${encodeURIComponent(JSON.stringify(deviceFingerprint))}` + // ‚úÖ CORREGIDO
        `&metodo_check_in=Supervisor` + // ‚úÖ A√ëADIDO
        `&timestamp=${Math.floor(Date.now()/1000)}`;

    fetch(url, {method: 'GET'})
        .then(() => console.log('‚úÖ Solicitud manual enviada al supervisor'))
        .catch(() => console.log('‚ùå Error enviando solicitud manual'));
}
        
        function mostrarConfirmacionContacto(infoSolicitud, tel) {
            document.getElementById('status-message').innerHTML = `
                <div class="success-box">
                    üìß <strong>Supervisor notificado correctamente</strong><br><br>
                    üîî Tu supervisor ${parametrosURL.supervisor} ha sido informado<br>
                    üìû Te contactar√° en breve para procesar check-in manual<br><br>
                    üìã <strong>Informaci√≥n enviada:</strong><br>
                    ‚Ä¢ Zona solicitada: ${zonaSeleccionada}<br>
                    ${motivoSeleccionado ? `‚Ä¢ Motivo: ${MOTIVOS_TEXTO[motivoSeleccionado]}<br>` : ''}
                    ‚Ä¢ Historial errores GPS: ${historialErroresGPS.length} error(es)<br><br>
                    üì± <strong>Llamada directa:</strong><br>
                    <a href="tel:${tel}">${tel}</a>
                </div>`;
                
            document.getElementById('gps-button').disabled = true;
            document.getElementById('emergency-button').disabled = true;
            document.getElementById('emergency-button').innerHTML = '‚úÖ ENVIADO';
            document.getElementById('emergency-button').style.background = '#28a745';
        }
        
        // ========================================
        // üîß FUNCIONES AUXILIARES Y UTILIDADES
        // ========================================
        
function crearEventoGPS(intento, lat, lng, accuracy, dispositivo, anomalias) {
    return {
        intento: intento,
        timestamp: new Date().toISOString(),
        lat: lat,
        lng: lng,
        accuracy: accuracy,
        dispositivo: dispositivo,
        anomalias: anomalias,
        // ‚úÖ A√ëADIR campos de zona consistentes:
        zona_intentada: zonaSeleccionada,
        es_zona_secundaria: zonaSeleccionada !== parametrosURL.zona_principal,
        motivo_cambio: motivoSeleccionado || null
    };
}
        
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radio de la Tierra en metros
            const rad = Math.PI / 180;
            const dLat = (lat2 - lat1) * rad;
            const dLon = (lon2 - lon1) * rad;
            const a = Math.sin(dLat / 2) ** 2 + 
                     Math.cos(lat1 * rad) * Math.cos(lat2 * rad) * 
                     Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function calcularDistanciaMinimaBordeEspana(lat, lng) {
            // Coordenadas aproximadas de los bordes de Espa√±a
            const bordeEspana = {
                norte: 43.79,
                sur: 35.95,
                este: 4.32,
                oeste: -9.30
            };
            
            let distanciaMinima = Infinity;
            
            // Distancia a cada borde
            if (lat > bordeEspana.norte) {
                distanciaMinima = Math.min(distanciaMinima, calcularDistancia(lat, lng, bordeEspana.norte, lng));
            }
            if (lat < bordeEspana.sur) {
                distanciaMinima = Math.min(distanciaMinima, calcularDistancia(lat, lng, bordeEspana.sur, lng));
            }
            if (lng > bordeEspana.este) {
                distanciaMinima = Math.min(distanciaMinima, calcularDistancia(lat, lng, lat, bordeEspana.este));
            }
            if (lng < bordeEspana.oeste) {
                distanciaMinima = Math.min(distanciaMinima, calcularDistancia(lat, lng, lat, bordeEspana.oeste));
            }
            
            return Math.round(distanciaMinima);
        }
        
        async function calcularDistanciaIPvsGPS(ip, coords) {
            try {
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                const ipData = await response.json();
                
                if (ipData.latitude && ipData.longitude) {
                    return calcularDistancia(
                        coords.lat, coords.lng,
                        parseFloat(ipData.latitude), parseFloat(ipData.longitude)
                    );
                }
            } catch (error) {
                console.log('Error obteniendo ubicaci√≥n de IP:', error);
            }
            return 0;
        }
        
        async function obtenerPaisDeIP(ip) {
            try {
                const response = await fetch(`https://ipapi.co/${ip}/country/`);
                return await response.text();
            } catch (error) {
                console.log('Error obteniendo pa√≠s de IP:', error);
                return 'unknown';
            }
        }
        
        function getDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('mobile') || ua.includes('android') || ua.includes('iphone')) return 'Mobile';
            if (ua.includes('tablet') || ua.includes('ipad')) return 'Tablet';
            return 'Desktop';
        }
        
        function validarConectividad() {
            return Promise.resolve(navigator.onLine);
        }
        
        function cerrarPagina() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar la p√°gina?')) {
                window.close();
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 500);
            }
        }
        
        // ========================================
        // üìà FUNCIONES DE CATEGORIZACI√ìN PARA KPIs
        // ========================================
        
        function categorizarDistancia(metros) {
            if (metros < 100) return 'CERCA';
            if (metros < 500) return 'MEDIA';
            if (metros < 1000) return 'LEJANA';
            return 'MUY_LEJANA';
        }
        
        function categorizarPrecision(accuracy) {
            if (accuracy < 20) return 'ALTA';
            if (accuracy < 50) return 'MEDIA';
            return 'BAJA';
        }
        
        function generarHashDispositivo(dispositivo) {
            const datos = `${dispositivo.userAgent}-${dispositivo.platform}-${dispositivo.screen_resolution}-${dispositivo.webgl_info?.vendor}`;
            return btoa(datos).slice(0, 12);
        }
        
    </script>
</body>
</html>
