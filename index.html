<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Manual Supervisor</title>
</head>
<body style="font-family: Arial; padding: 20px; background: #f8f9fa;">
    
    <div style="max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        
        <h2 style="color: #495057; text-align: center; margin-bottom: 30px;">🔧 CHECK-IN MANUAL - SUPERVISOR</h2>
        
        <form id="checkinForm">
            
            <!-- AUTO-RECUPERACIÓN DE TÉCNICO -->
            <div style="margin: 15px 0;">
                <label style="font-weight: bold; color: #495057;">👤 Email Técnico:</label><br>
                <input type="email" id="tecnico" required style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; box-sizing: border-box;" 
                       placeholder="Se auto-completa desde URL o ingresa manual">
            </div>
            
            <!-- AUTO-RECUPERACIÓN DE ZONA -->
            <div style="margin: 15px 0;">
                <label style="font-weight: bold; color: #495057;">📍 Zona:</label><br>
                <select id="zona" required style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; box-sizing: border-box;">
                    <option value="">Se auto-detecta o selecciona manual...</option>
                    <option value="Línea-A">🏭 Línea-A</option>
                    <option value="Línea-B">🏭 Línea-B</option>
                    <option value="Línea-C">🏭 Línea-C</option>
                    <option value="Almacén">📦 Almacén</option>
                    <option value="Utilities">⚡ Utilities</option>
                    <option value="Oficinas">🏢 Oficinas</option>
                    <option value="Taller">🔧 Taller</option>
                </select>
            </div>
            
            <!-- AUTO-RECUPERACIÓN DE SUPERVISOR -->
            <div style="margin: 15px 0;">
                <label style="font-weight: bold; color: #495057;">📞 Email Supervisor:</label><br>
                <input type="email" id="supervisor" required style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; box-sizing: border-box;"
                       placeholder="Se auto-detecta turno actual o ingresa manual">
            </div>
            
            <!-- CAMPO AUTENTICACIÓN SUPERVISOR -->
            <div style="margin: 15px 0; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                <label style="font-weight: bold; color: #856404;">🔐 PIN Supervisor:</label><br>
                <input type="password" id="supervisor_pin" required 
                       placeholder="PIN de 4 dígitos" 
                       maxlength="4" pattern="[0-9]{4}"
                       style="width: 150px; padding: 12px; border: 1px solid #ffc107; border-radius: 8px; margin-top: 5px; text-align: center; font-size: 18px; font-weight: bold; box-sizing: border-box;">
                <small style="display: block; color: #856404; margin-top: 5px;">
                    ⚠️ Solo supervisores autorizados pueden procesar check-ins manuales
                </small>
            </div>
            
            <!-- MOTIVO OBLIGATORIO -->
            <div style="margin: 15px 0;">
                <label style="font-weight: bold; color: #495057;">📝 Motivo Check-in Manual:</label><br>
                <select id="motivo" required style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; box-sizing: border-box;">
                    <option value="">Seleccionar motivo...</option>
                    <option value="GPS_no_funciona">📱 GPS no funciona</option>
                    <option value="Bateria_agotada">🔋 Batería agotada/teléfono apagado</option>
                    <option value="Sin_cobertura">📶 Sin cobertura móvil</option>
                    <option value="Emergencia_operacional">🚨 Emergencia operacional</option>
                    <option value="Equipo_compartido">🔧 Equipo/tablet empresa sin GPS</option>
                    <option value="Problema_medico">🏥 Problema médico leve (presente)</option>
                    <option value="Llegada_tardia">🕐 Llegada tardía justificada</option>
                    <option value="Error_tecnico">⚠️ Error técnico sistema</option>
                    <option value="Otro">📝 Otro motivo</option>
                </select>
            </div>
            
            <!-- OBSERVACIONES OPCIONALES -->
            <div style="margin: 15px 0;">
                <label style="font-weight: bold; color: #495057;">💬 Observaciones adicionales (opcional):</label><br>
                <textarea id="observaciones" placeholder="Detalles adicionales del motivo..." 
                         style="width: 100%; height: 80px; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-top: 5px; resize: vertical; box-sizing: border-box;"></textarea>
            </div>
            
            <!-- INFO AUTO-DETECTADA -->
            <div id="autoInfo" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px; color: #6c757d;">
                <strong>ℹ️ Info auto-detectada:</strong><br>
                <span id="infoText">Cargando datos automáticos...</span>
            </div>
            
            <button type="submit" style="width: 100%; background: #28a745; color: white; padding: 15px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                ✅ AUTORIZAR CHECK-IN MANUAL
            </button>
            
            <div style="text-align: center; margin-top: 15px;">
                <small style="color: #6c757d;">Solo usar cuando técnico presente físicamente pero GPS falla</small>
            </div>
            
        </form>
    </div>
    
       <script>
        // AUTO-RECUPERACIÓN AL CARGAR
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            
            // Auto-completar técnico
            if (params.get('tecnico')) {
                document.getElementById('tecnico').value = params.get('tecnico');
            }
            
            // Auto-seleccionar zona
            if (params.get('zona')) {
                document.getElementById('zona').value = params.get('zona');
            }
            
            // Auto-completar supervisor (DESDE WEBHOOK, NO CALCULADO)
            if (params.get('supervisor')) {
                document.getElementById('supervisor').value = params.get('supervisor');
            }
            
            // Auto-seleccionar motivo sugerido
            if (params.get('motivo_sugerido')) {
                document.getElementById('motivo').value = params.get('motivo_sugerido');
            }
            
            // Auto-detectar turno (DESDE WEBHOOK, NO CALCULADO)
            let turnoDetectado = params.get('turno') || "No detectado";
            let supervisorDetectado = params.get('supervisor') || "No detectado";
            
            // Detectar urgente
            if (params.get('urgente') === 'true') {
                document.body.style.background = '#fff3cd';
                const title = document.querySelector('h2');
                title.innerHTML = '🚨 CHECK-IN URGENTE - GPS FALLÓ';
                title.style.color = '#dc3545';
                
                // Agregar banner urgente
                const urgentBanner = document.createElement('div');
                urgentBanner.style.cssText = 'background: #f8d7da; border: 2px solid #dc3545; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;';
                urgentBanner.innerHTML = '<strong style="color: #721c24;">⚠️ ATENCIÓN: Técnico intentó check-in GPS pero falló.<br>Verificar presencia física antes de autorizar.</strong>';
                document.querySelector('form').insertBefore(urgentBanner, document.querySelector('form').firstChild);
            }
            
            // AUTO-DETECTAR SUPERVISOR SOLO SI NO VIENE EN URL
            if (!params.get('supervisor')) {
                const horaActual = new Date().getHours();
                let supervisorSugerido = "";
                let turnoSugerido = "";
                
                if (horaActual >= 6 && horaActual < 14) {
                    supervisorSugerido = "supervisor.campo.a@empresa.com";
                    turnoSugerido = "A (06:00-14:00) - ESTIMADO";
                } else if (horaActual >= 14 && horaActual < 22) {
                    supervisorSugerido = "supervisor.campo.b@empresa.com";
                    turnoSugerido = "B (14:00-22:00) - ESTIMADO";
                } else {
                    supervisorSugerido = "supervisor.campo.c@empresa.com";
                    turnoSugerido = "C (22:00-06:00) - ESTIMADO";
                }
                
                document.getElementById('supervisor').value = supervisorSugerido;
                turnoDetectado = turnoSugerido;
                supervisorDetectado = supervisorSugerido;
            }
            
            // Mostrar info detectada
            document.getElementById('infoText').innerHTML = 
                `Turno: ${turnoDetectado}<br>` +
                `Supervisor: ${supervisorDetectado}<br>` +
                `Hora actual: ${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}<br>` +
                `${params.get('supervisor') ? '<strong style="color: #28a745;">✅ Datos desde sistema (precisos)</strong>' : '<strong style="color: #ffc107;">⚠️ Datos estimados por hora</strong>'}`;
        };
        
        // ENVÍO DE FORMULARIO
        document.getElementById('checkinForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tecnico = document.getElementById('tecnico').value;
            const zona = document.getElementById('zona').value;
            const supervisor = document.getElementById('supervisor').value;
            const supervisorPin = document.getElementById('supervisor_pin').value;
            const motivo = document.getElementById('motivo').value;
            const observaciones = document.getElementById('observaciones').value;
            
             // Validación PIN
            if (supervisorPin.length !== 4 || !/^\d{4}$/.test(supervisorPin)) {
                alert('❌ PIN debe ser exactamente 4 dígitos numéricos');
                return;
            }
            
            // Validación campos obligatorios
            if (!tecnico || !zona || !supervisor || !motivo) {
                alert('❌ Por favor completa todos los campos obligatorios');
                return;
            }
            
          // URL webhook - REEMPLAZAR POR TU URL REAL
            const url = "https://hook.eu2.make.com/5cbp8q391axrc7nnbsuep6cxgzyqm55a" +
                       "?tecnico=" + encodeURIComponent(tecnico) +
                       "&zona=" + encodeURIComponent(zona) +
                       "&supervisor=" + encodeURIComponent(supervisor) +
                       "&supervisor_pin=" + encodeURIComponent(supervisorPin) +
                       "&motivo=" + encodeURIComponent(motivo) +
                       "&observaciones=" + encodeURIComponent(observaciones) +
                       "&manual=true" +
                       "&timestamp=" + Math.floor(Date.now()/1000);
            
            // Confirmación antes de enviar
            if (confirm(`✅ Confirmar check-in manual:\n\nTécnico: ${tecnico}\nZona: ${zona}\nMotivo: ${motivo}\nSupervisor: ${supervisor}\n\n¿Proceder?`)) {
                window.location.href = url;
            }
        });
    </script>
    
</body>
</html>
